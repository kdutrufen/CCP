---
title: "Automated_immunology_analysis_Rules"
author: "Carlos Eduardo Madureira Trufen"
date: "6/5/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## R Markdown

# Load libraries
```{r, message=FALSE, warning=FALSE}
library(bestNormalize, warn.conflicts = FALSE)
library(broom, warn.conflicts = FALSE)
library(C50, warn.conflicts = FALSE)
library(caret, warn.conflicts = FALSE)
library(caTools, warn.conflicts = FALSE)
library(Ckmeans.1d.dp, warn.conflicts = FALSE)
library(corrplot, warn.conflicts = FALSE)
library(clusterCrit, warn.conflicts = FALSE)
library(CytoML, warn.conflicts = FALSE)
library(DiffSOM, warn.conflicts = FALSE)
library(doParallel, warn.conflicts = FALSE)
library(EmbedSOM, warn.conflicts = FALSE)
library(FactoMineR, warn.conflicts = FALSE)
library(factoextra, warn.conflicts = FALSE)
library(flowClean, warn.conflicts = FALSE)
library(flowCore, warn.conflicts = FALSE)
library(flowClust, warn.conflicts = FALSE)
library(flowStats, warn.conflicts = FALSE)
library(flowViz, warn.conflicts = FALSE)
library(flowWorkspace, warn.conflicts = FALSE)
library(FlowSOM, warn.conflicts = FALSE)
library(furrr, warn.conflicts = FALSE)
library(ggcyto, warn.conflicts = FALSE)
library(HDclassif, warn.conflicts = FALSE)
library(imbalance, warn.conflicts = FALSE)
library(kohonen, warn.conflicts = FALSE)
library(microbenchmark, warn.conflicts = FALSE)
library(mlr, warn.conflicts = FALSE)
library(parallel, warn.conflicts = FALSE)
library(parallelMap, warn.conflicts = FALSE)
library(profvis, warn.conflicts = FALSE)
library(randomForest, warn.conflicts = FALSE)
library(ranger, warn.conflicts = FALSE)
library(RColorBrewer, warn.conflicts = FALSE)
library(Rcpp11, warn.conflicts = FALSE)
library(tictoc, warn.conflicts = FALSE)
library(tidyverse, warn.conflicts = FALSE)
library(vroom, warn.conflicts = FALSE)
library(xgboost, warn.conflicts = FALSE)
library(yasomi, warn.conflicts = FALSE)

# source_path <- "~/PRIMUS/"
source_path <- "/run/user/1002/gvfs/smb-share:server=primus.img.cas.cz,share="

source(paste0(source_path, "home/trufenc/new_SOM_functions.R"))
```

```{r}
scale_to_range_0_1 <- function(x, ...){(x - min(x, ...)) / (max(x, ...) - min(x, ...))}
```

```{r add_first_gate_column}
add_first_gate_column <- function(facs_data_df) {
  facs_data_df <- facs_data_df %>%
    mutate(first_gate = case_when(!(cell_type %in% c("clog+", "cells-", "S1-", "S2-", "dead")) ~ "live"))

  facs_data_df <- facs_data_df %>%
    mutate(first_gate = if_else(is.na(first_gate), true = "not_live", false = first_gate))
  return(facs_data_df)
}
```

```{r add_second_gate_column}
add_second_gate_column <- function(facs_data_df) {

  facs_data_df <- facs_data_df %>%
    mutate(second_gate = if_else(first_gate %>% str_detect(pattern = "not_live"), true = "not_live", false = as.character(cell_type)))

  facs_data_df <- facs_data_df %>%
    mutate(second_gate = if_else(second_gate %in% c("CD5+-", "DN "), true = "Not_Panel_A_cell_types", false = second_gate)) %>%
    mutate(second_gate = if_else(second_gate %>% str_detect(pattern = "gdTCR"), true = "gdTCR_cells", false = second_gate)) %>%
    mutate(second_gate = if_else(second_gate %>% str_detect(pattern = "NK_"), true = "NK_cells", false = second_gate)) %>%
    mutate(second_gate = if_else(second_gate %>% str_detect(pattern = "CD4\\-NKT_"), true = "CD4-NKT_cells", false = second_gate)) %>%
    mutate(second_gate = if_else(second_gate %>% str_detect(pattern = "CD4\\+NKT_"), true = "CD4+NKT_cells", false = second_gate)) %>%
    mutate(second_gate = if_else(second_gate %>% str_detect(pattern = "Tregs_"), true = "Tregs_CD4+_cells", false = second_gate)) %>%
    mutate(second_gate = if_else(second_gate %>% str_detect(pattern = "Th_"), true = "Th_CD4+_cells", false = second_gate)) %>%
    mutate(second_gate = if_else(second_gate %>% str_detect(pattern = "CD8"), true = "CD8+_cells", false = second_gate))

  return(facs_data_df)
}
```


```{r build_fcs_data_df}
build_fcs_data_df <- function(cell_types, diff_som) {
  
  cell_types_df <- cell_types %>%
    as.data.frame() %>%
    # rownames_to_column() %>%
    # dplyr::rename("cell_types" = ".", "File" = "rowname") %>%
    dplyr::rename("cell_types" = ".")
    # mutate(File = File %>% as.numeric())

  cell_types_df <- cell_types_df %>%
    mutate(cell_types = cell_types %>% recode(
      "clog--" = "clog+",
      "clog-_cells-" = "cells-",
      "cells_S1-" = "S1-",
      "S2_dead" = "dead",
      "S1_S2-" = "S2-",
      "NK_Eff_Klrg1+-" = "NK_Eff_Klrg1-",
      "NK_Res_Klrg1+-" = "NK_Res_Klrg1-",
      "NK_neg_Klrg1+-" = "NK_neg_Klrg1-",
      "gd_Eff_Klrg1+" = "gdTCR_Eff_Klrg1+",
      "gd_Eff_Klrg1+-" = "gdTCR_Eff_Klrg1-",
      "gd_Res_Klrg1+" = "gdTCR_Res_Klrg1+",
      "gd_Res_Klrg1+-" = "gdTCR_Res_Klrg1-",
      "gd_neg_Klrg1+" = "gdTCR_neg_Klrg1+",
      "gd_neg_Klrg1+-" = "gdTCR_neg_Klrg1-",
      "CD4-NKT_Eff_Klrg1+-" = "CD4-NKT_Eff_Klrg1-",
      "CD4-NKT_Res_Klrg1+-" = "CD4-NKT_Res_Klrg1-",
      "CD4-NKT_neg_Klrg1+-" = "CD4-NKT_neg_Klrg1-",
      "CD4+NKT_Eff_Klrg1+-" = "CD4+NKT_Eff_Klrg1-",
      "CD4+NKT_Res_Klrg1+-" = "CD4+NKT_Res_Klrg1-",
      "CD4+NKT_neg_Klrg1+-" = "CD4+NKT_neg_Klrg1-",
      "Th_Eff_Klrg1+-" = "Th_Eff_Klrg1-",
      "Th_Res_Klrg1+-" = "Th_Res_Klrg1-",
      "Th_neg_Klrg1+-" = "Th_neg_Klrg1-",
      "Treg_Eff_Klrg1+-" = "Tregs_Eff_Klrg1-",
      "Treg_Res_Klrg1+-" = "Tregs_Res_Klrg1-",
      "Treg_neg_Klrg1+-" = "Tregs_neg_Klrg1-",
      "Treg_Eff_Klrg1+" = "Tregs_Eff_Klrg1+",
      "Treg_Res_Klrg1+" = "Tregs_Res_Klrg1+",
      "Treg_neg_Klrg1+" = "Tregs_neg_Klrg1+",
      "CD8_Naive_Klrg1-_VM Tcells" = "CD8_Naive_Klrg1-_VM Tcells+",
      "CD8_Naive_Klrg1+_VM Tcells" = "CD8_Naive_Klrg1+_VM Tcells+",
      "CD8_Eff_Klrg1-_VM Tcells" = "CD8_Eff_Klrg1-_VM Tcells+",
      "CD8_Eff_Klrg1+_VM Tcells" = "CD8_Eff_Klrg1+_VM Tcells+",
      "CD8_Res_Klrg1-_VM Tcells" = "CD8_Res_Klrg1-_VM Tcells+",
      "CD8_Res_Klrg1+_VM Tcells" = "CD8_Res_Klrg1+_VM Tcells+",
      "CD8_neg_Klrg1-_VM Tcells" = "CD8_neg_Klrg1-_VM Tcells+",
      "CD8_neg_Klrg1+_VM Tcells" = "CD8_neg_Klrg1+_VM Tcells+",
      "CD8+_Eff_Klrg1-_VM Tcells-" = "CD8_Eff_Klrg1-_VM Tcells-",
      "CD8+_Eff_Klrg1+_VM Tcells" = "CD8_Eff_Klrg1+_VM Tcells+",
      "CD8+_Eff_Klrg1+_VM Tcells-" = "CD8_Eff_Klrg1+_VM Tcells-",
      "CD8+_Naive_Klrg1-_VM Tcells" = "CD8_Naive_Klrg1-_VM Tcells+",
      "CD8+_Naive_Klrg1-_VM Tcells-" = "CD8_Naive_Klrg1-_VM Tcells-",
      "CD8+_Naive_Klrg1+_VM Tcells" = "CD8_Naive_Klrg1+_VM Tcells+",
      "CD8+_Naive_Klrg1+_VM Tcells-" = "CD8_Naive_Klrg1+_VM Tcells-",
      "CD8+_neg_Klrg1-_VM Tcells" = "CD8_neg_Klrg1-_VM Tcells+",
      "CD8+_neg_Klrg1-_VM Tcells-" = "CD8_neg_Klrg1-_VM Tcells-",
      "CD8+_neg_Klrg1+_VM Tcells" = "CD8_neg_Klrg1+_VM Tcells+",
      "CD8+_neg_Klrg1+_VM Tcells-" = "CD8_neg_Klrg1+_VM Tcells-",
      "CD8+_Res_Klrg1-_VM Tcells" = "CD8_Res_Klrg1-_VM Tcells+",
      "CD8+_Res_Klrg1-_VM Tcells-" = "CD8_Res_Klrg1-_VM Tcells-",
      "CD8+_Res_Klrg1+_VM Tcells" = "CD8_Res_Klrg1+_VM Tcells+",
      "CD8+_Res_Klrg1+_VM Tcells-" = "CD8_Res_Klrg1+_VM Tcells-"
    ))

  # manual_gating <- diff_som$fs$data %>%
  #   as.data.frame() %>%
  #   full_join(cell_types_df) %>%
  #   na.omit() %>%
  #   dplyr::select(cell_types) %>%
  #   unlist() %>%
  #   as.character() %>%
  #   factor()
  
    facs_data_df <- diff_som$fs$data %>%
    as.data.frame() %>%
    mutate(cell_type = cell_types_df$cell_types)

  # facs_data_df <- diff_som$fs$data %>%
  #   as.data.frame() %>%
  #   dplyr::select(c(1:19))
  # facs_data_df <- diff_som$fs$data %>% as.data.frame() %>% dplyr::select(to_transform)

  facs_data_df <- facs_data_df %>%
    purrr::set_names(str_remove(string = names(facs_data_df), pattern = "FJComp."))

  # facs_data_df <- facs_data_df %>%
  #   mutate(cell_type = manual_gating)
  
  return(facs_data_df)
}
```
path to files
```{r path_to_files}
path_to_files <- paste0(source_path, "~/data/83_BIOINFORMATICS/Carlos")
```


```{r panel_A_classes}
panel_A_classes <- c(
  "CD4\\-NKT_Eff_Klrg1\\+\\-.fcs",
  "CD4\\-NKT_Eff_Klrg1\\+.fcs",
  "CD4\\-NKT_neg_Klrg1\\+\\-.fcs",
  "CD4\\-NKT_neg_Klrg1\\+.fcs",
  "CD4\\-NKT_Res_Klrg1\\+\\-.fcs",
  "CD4\\-NKT_Res_Klrg1\\+.fcs",
  "CD4\\+NKT_Eff_Klrg1\\+\\-.fcs",
  "CD4\\+NKT_Eff_Klrg1\\+.fcs",
  "CD4\\+NKT_neg_Klrg1\\+\\-.fcs",
  "CD4\\+NKT_neg_Klrg1\\+.fcs",
  "CD4\\+NKT_Res_Klrg1\\+\\-.fcs",
  "CD4\\+NKT_Res_Klrg1\\+.fcs",
  "CD8\\+_Eff_Klrg1\\-_VM Tcells\\-.fcs",
  "CD8\\+_Eff_Klrg1\\-_VM Tcells.fcs",
  "CD8\\+_Eff_Klrg1\\+_VM Tcells\\-.fcs",
  "CD8\\+_Eff_Klrg1\\+_VM Tcells.fcs",
  "CD8\\+_Naive_Klrg1\\-_VM Tcells\\-.fcs",
  "CD8\\+_Naive_Klrg1\\-_VM Tcells.fcs",
  "CD8\\+_Naive_Klrg1\\+_VM Tcells\\-.fcs",
  "CD8\\+_Naive_Klrg1\\+_VM Tcells.fcs",
  "CD8\\+_neg_Klrg1\\-_VM Tcells\\-.fcs",
  "CD8\\+_neg_Klrg1\\-_VM Tcells.fcs",
  "CD8\\+_neg_Klrg1\\+_VM Tcells\\-.fcs",
  "CD8\\+_neg_Klrg1\\+_VM Tcells.fcs",
  "CD8\\+_Res_Klrg1\\-_VM Tcells\\-.fcs",
  "CD8\\+_Res_Klrg1\\-_VM Tcells.fcs",
  "CD8\\+_Res_Klrg1\\+_VM Tcells\\-.fcs",
  "CD8\\+_Res_Klrg1\\+_VM Tcells.fcs",
  "clog\\-_cells\\-.fcs",
  "clog\\-\\-.fcs",
  "dead.fcs",
  "DN .fcs",
  "CD5\\+\\-.fcs",
  "gd_Eff_Klrg1\\+\\-.fcs",
  "gd_Eff_Klrg1\\+.fcs",
  "gd_neg_Klrg1\\+\\-.fcs",
  "gd_neg_Klrg1\\+.fcs",
  "gd_Res_Klrg1\\+\\-.fcs",
  "gd_Res_Klrg1\\+.fcs",
  "NK_Eff_Klrg1\\+\\-.fcs",
  "NK_Eff_Klrg1\\+.fcs",
  "NK_neg_Klrg1\\+\\-.fcs",
  "NK_neg_Klrg1\\+.fcs",
  "NK_Res_Klrg1\\+\\-.fcs",
  "NK_Res_Klrg1\\+.fcs",
  "S1\\-.fcs",
  "S2\\-.fcs",
  "Th_Eff_Klrg1\\+\\-.fcs",
  "Th_Eff_Klrg1\\+.fcs",
  "Th_neg_Klrg1\\+\\-.fcs",
  "Th_neg_Klrg1\\+.fcs",
  "Th_Res_Klrg1\\+\\-.fcs",
  "Th_Res_Klrg1\\+.fcs",
  "Treg_Eff_Klrg1\\+\\-.fcs",
  "Treg_Eff_Klrg1\\+.fcs",
  "Treg_neg_Klrg1\\+\\-.fcs",
  "Treg_neg_Klrg1\\+.fcs",
  "Treg_Res_Klrg1\\+\\-.fcs",
  "Treg_Res_Klrg1\\+.fcs"
)

```


# path_to_files
```{r path_to_files}
path_to_gold_standard_control_files_1 <- paste0(source_path, "home/trufenc/fcs_files/c122/Specimen_001_c02672_fcs_2020_09_25")

path_to_gold_standard_control_files_2 <- paste0(source_path, "home/trufenc/fcs_files/c122/Specimen_001_c02676_fcs_2020_09_25")

# path_to_gold_standard_control_files_3 <- paste0(source_path, "home/trufenc/fcs_files/c122/Specimen_001_c02677_fcs_2020_09_25")

path_to_gold_standard_control_files_3 <- paste0(source_path, "home/trufenc/fcs_files/c122/Specimen_001_c02678_fcs_2020_09_25")

path_to_gold_standard_control_files_4 <- paste0(source_path, "home/trufenc/fcs_files/c122/Specimen_001_c02679_fcs_2020_09_25")

path_to_gold_standard_control_files_5 <- paste0(source_path, "home/trufenc/fcs_files/c122/Specimen_001_c02683_fcs_2020_09_25")

path_to_gold_standard_control_files_6 <- paste0(source_path, "home/trufenc/fcs_files/c122/Specimen_001_c02684_fcs_2020_09_25")

path_to_gold_standard_control_files_7 <- paste0(source_path, "home/trufenc/fcs_files/c146/Specimen_001_c03540_fcs")

path_to_gold_standard_control_files_8 <- paste0(source_path, "home/trufenc/fcs_files/c146/Specimen_001_c03541_fcs")

path_to_gold_standard_control_files_9 <- paste0(source_path, "home/trufenc/fcs_files/c146/Specimen_001_c03542_fcs")

path_to_gold_standard_control_files_10 <- paste0(source_path, "home/trufenc/fcs_files/c146/Specimen_001_c03564_fcs")

path_to_gold_standard_control_files_11 <- paste0(source_path, "home/trufenc/fcs_files/c145/Specimen_001_c02020_fcs")

path_to_gold_standard_control_files_12 <- paste0(source_path, "home/trufenc/fcs_files/c145/Specimen_001_c02027_fcs")

path_to_gold_standard_control_files_13 <- paste0(source_path, "home/trufenc/fcs_files/c145/Specimen_001_c02042_fcs")

path_to_gold_standard_control_files_14 <- paste0(source_path, "home/trufenc/fcs_files/c145/Specimen_001_c02043_fcs")

path_to_gold_standard_control_files_15 <- paste0(source_path, "home/trufenc/fcs_files/c145/Specimen_001_c02044_fcs")

path_to_gold_standard_control_files_16 <- paste0(source_path, "home/trufenc/fcs_files/c145/Specimen_001_c02045_fcs")

path_to_gold_standard_control_files_17 <- paste0(source_path, "home/trufenc/fcs_files/c145/Specimen_001_c02046_fcs")

path_to_gold_standard_control_files_18 <- paste0(source_path, "home/trufenc/fcs_files/c145/Specimen_001_c02055_fcs")

path_to_gold_standard_control_files_19 <- paste0(source_path, "home/trufenc/fcs_files/c145/Specimen_001_c02056_fcs")

path_to_gold_standard_control_files_20 <- paste0(source_path, "home/trufenc/fcs_files/c145/Specimen_001_c02057_fcs")



path_to_files <- list(path_to_gold_standard_control_files_1,
                      path_to_gold_standard_control_files_2,
                      path_to_gold_standard_control_files_3,
                      path_to_gold_standard_control_files_4,
                      path_to_gold_standard_control_files_5,
                      path_to_gold_standard_control_files_6,
                      path_to_gold_standard_control_files_7,
                      path_to_gold_standard_control_files_8,
                      path_to_gold_standard_control_files_9,
                      path_to_gold_standard_control_files_10,
                      path_to_gold_standard_control_files_11,
                      path_to_gold_standard_control_files_12,
                      path_to_gold_standard_control_files_13,
                      path_to_gold_standard_control_files_14,
                      path_to_gold_standard_control_files_15,
                      path_to_gold_standard_control_files_16,
                      path_to_gold_standard_control_files_17,
                      path_to_gold_standard_control_files_18
                      # path_to_gold_standard_control_files_19,
                      # path_to_gold_standard_control_files_20
                      )

files <- path_to_files %>% purrr::map(list.files, pattern = ".fcs", full.names = TRUE)

file_names <- path_to_files %>% purrr::map(list.files, pattern = ".fcs")

indices_list <- purrr::map(seq_along(files), function(j) purrr::map(seq_along(panel_A_classes), function(i) files[[j]] %>% str_which(pattern = panel_A_classes[i])) %>% unlist())
files_to_load_list <- purrr::map(seq_along(files), function(j) files[[j]][indices_list[[j]]])
files_to_load_names_list <- purrr::map(seq_along(files), function(j) file_names[[j]][indices_list[[j]]])

# for new samples from 03/11/2020
files_to_load_list <- purrr::map(seq_along(files_to_load_list), function(i) files_to_load_list[[i]][-c(22)] )
files_to_load_names_list <- purrr::map(seq_along(files_to_load_names_list), function(i) files_to_load_names_list[[i]][-c(22)] )

# files_to_load_list[[9]] <- files_to_load_list[[9]][-c(56)]
# files_to_load_names_list[[9]] <- files_to_load_names_list[[9]][-c(56)]
# files_to_load_list[[13]] <- files_to_load_list[[9]][-c(56)]
# files_to_load_names_list[[13]] <- files_to_load_names_list[[9]][-c(56)]
# files_to_load_list[[4]] <- files_to_load_list[[4]][-c(6, 24, 28, 48)]
# files_to_load_names_list[[4]] <- files_to_load_names_list[[4]][-c(6, 24, 28, 48)]

tic()
diff_som_1 <- files_to_load_list %>% unlist() %>% load_fcs_files(n_cells = 1e20, filter = TRUE, to_filter = c(1:6), scale = FALSE, transform = TRUE, to_transform = c(1:18))
toc()

# diff_som_1 %>% saveRDS(paste0(source_path, "home/trufenc/diff_som_11_2020.rds"))
diff_som_1 <- readRDS(paste0(source_path, "home/trufenc/diff_som_11_2020.rds"))

cell_types_control <- diff_som_1$files %>% 
  unlist() %>% 
  str_remove(pattern = ".fcs") %>% 
  str_remove(pattern = "export_Specimen_..._c....._..._..._")

cell_types <- cell_types_control
# cell_types[cell_types %>% str_which(pattern = "CD8\\+_VM Tcells\\-")] <- NA
cell_types <- cell_types[!is.na(cell_types)]
# files_to_load_list %>% unlist()

# facs_data_df <- diff_som_1_normalized %>% build_fcs_data_df(cell_types = cell_types)
facs_data_df <- diff_som_1 %>% build_fcs_data_df(cell_types = cell_types)

facs_data_df <- facs_data_df %>% add_first_gate_column()

facs_data_df <- facs_data_df %>% add_second_gate_column()

facs_data_df_step_2 <- facs_data_df %>% dplyr::filter(first_gate != "not_live")

second_gate_table <- facs_data_df_step_2 %>% group_by(second_gate) %>% tally()

train_df_step_2 <- facs_data_df_step_2
```

```{r}
val_path_to_files <- list(
  # path_to_gold_standard_control_files_1,
  #                       path_to_gold_standard_control_files_2,
  #                       path_to_gold_standard_control_files_3,
  #                       path_to_gold_standard_control_files_4,
  #                       path_to_gold_standard_control_files_5,
  #                       path_to_gold_standard_control_files_6,
  #                       path_to_gold_standard_control_files_7,
  #                       path_to_gold_standard_control_files_8,
  #                       path_to_gold_standard_control_files_9,
  #                       path_to_gold_standard_control_files_10,
  #                       path_to_gold_standard_control_files_11,
  #                       path_to_gold_standard_control_files_12,
  #                       path_to_gold_standard_control_files_13,
  #                       path_to_gold_standard_control_files_14,
  #                       path_to_gold_standard_control_files_15,
  #                       path_to_gold_standard_control_files_16,
  #                       path_to_gold_standard_control_files_17,
  #                       path_to_gold_standard_control_files_18
  path_to_gold_standard_control_files_19,
  path_to_gold_standard_control_files_20
)

val_files <- val_path_to_files %>% purrr::map(list.files, pattern = ".fcs", full.names = TRUE)

val_file_names <- val_path_to_files %>% purrr::map(list.files, pattern = ".fcs")

val_indices_list <- purrr::map(seq_along(val_files), function(j) purrr::map(seq_along(panel_A_classes), function(i) val_files[[j]] %>% str_which(pattern = panel_A_classes[i])) %>% unlist())
val_files_to_load_list <- purrr::map(seq_along(val_files), function(j) val_files[[j]][val_indices_list[[j]]])
val_files_to_load_names_list <- purrr::map(seq_along(val_files), function(j) val_file_names[[j]][val_indices_list[[j]]])

val_files_to_load_list <- purrr::map(seq_along(val_files_to_load_list), function(i) val_files_to_load_list[[i]][-c(22)] )
val_files_to_load_names_list <- purrr::map(seq_along(val_files_to_load_names_list), function(i) val_files_to_load_names_list[[i]][-c(22)] )

tic()
val_diff_som_1 <- val_files_to_load_list %>% unlist() %>% load_fcs_files(n_cells = 1e20, filter = TRUE, to_filter = c(1:6), scale = FALSE, transform = TRUE, to_transform = c(1:18))
toc()

val_diff_som_1 <- readRDS(paste0(source_path, "home/trufenc/val_diff_som_11_2020.rds"))

val_cell_types_control <- val_diff_som_1$files %>% 
  unlist() %>% 
  str_remove(pattern = ".fcs") %>% 
  str_remove(pattern = "export_Specimen_..._c....._..._..._")

val_cell_types <- val_cell_types_control
# cell_types[cell_types %>% str_which(pattern = "CD8\\+_VM Tcells\\-")] <- NA
val_cell_types <- val_cell_types[!is.na(val_cell_types)]
# files_to_load_list %>% unlist()

# val_facs_data_df <- val_diff_som_1_normalized %>% build_fcs_data_df(cell_types = cell_types)
val_facs_data_df <- val_diff_som_1 %>% build_fcs_data_df(cell_types = val_cell_types)

val_facs_data_df <- val_facs_data_df %>% add_first_gate_column()

val_facs_data_df <- val_facs_data_df %>% add_second_gate_column()

val_facs_data_df_step_2 <- val_facs_data_df %>% dplyr::filter(first_gate != "not_live")

val_second_gate_table <- val_facs_data_df_step_2 %>% group_by(second_gate) %>% tally()

val_df_step_2 <- val_facs_data_df_step_2
```

```{r}
# path_to_gold_standard_control_files_1 <- paste0(source_path, "home/trufenc/fcs_files/c122/Specimen_001_c02672_fcs_2020_09_25")
# 
# path_to_gold_standard_control_files_2 <- paste0(source_path, "home/trufenc/fcs_files/c122/Specimen_001_c02676_fcs_2020_09_25")
# 
# # path_to_gold_standard_control_files_3 <- paste0(source_path, "home/trufenc/fcs_files/c122/Specimen_001_c02677_fcs_2020_09_25")
# 
# path_to_gold_standard_control_files_3 <- paste0(source_path, "home/trufenc/fcs_files/c122/Specimen_001_c02678_fcs_2020_09_25")
# 
# path_to_gold_standard_control_files_4 <- paste0(source_path, "home/trufenc/fcs_files/c122/Specimen_001_c02679_fcs_2020_09_25")
# 
# path_to_gold_standard_control_files_5 <- paste0(source_path, "home/trufenc/fcs_files/c122/Specimen_001_c02683_fcs_2020_09_25")
# 
# path_to_gold_standard_control_files_6 <- paste0(source_path, "home/trufenc/fcs_files/c122/Specimen_001_c02684_fcs_2020_09_25")
# 
# path_to_gold_standard_control_files_7 <- paste0(source_path, "home/trufenc/fcs_files/c146/Specimen_001_c03540_fcs")
# 
# path_to_gold_standard_control_files_8 <- paste0(source_path, "home/trufenc/fcs_files/c146/Specimen_001_c03541_fcs")
# 
# path_to_gold_standard_control_files_9 <- paste0(source_path, "home/trufenc/fcs_files/c146/Specimen_001_c03542_fcs")
# 
# path_to_gold_standard_control_files_10 <- paste0(source_path, "home/trufenc/fcs_files/c146/Specimen_001_c03564_fcs")
# 
# path_to_gold_standard_control_files_11 <- paste0(source_path, "home/trufenc/fcs_files/c145/Specimen_001_c02020_fcs")
# 
# path_to_gold_standard_control_files_12 <- paste0(source_path, "home/trufenc/fcs_files/c145/Specimen_001_c02027_fcs")
# 
# path_to_gold_standard_control_files_13 <- paste0(source_path, "home/trufenc/fcs_files/c145/Specimen_001_c02042_fcs")
# 
# path_to_gold_standard_control_files_14 <- paste0(source_path, "home/trufenc/fcs_files/c145/Specimen_001_c02043_fcs")
# 
# path_to_gold_standard_control_files_15 <- paste0(source_path, "home/trufenc/fcs_files/c145/Specimen_001_c02044_fcs")
# 
# path_to_gold_standard_control_files_16 <- paste0(source_path, "home/trufenc/fcs_files/c145/Specimen_001_c02045_fcs")
# 
# path_to_gold_standard_control_files_17 <- paste0(source_path, "home/trufenc/fcs_files/c145/Specimen_001_c02046_fcs")
# 
# path_to_gold_standard_control_files_18 <- paste0(source_path, "home/trufenc/fcs_files/c145/Specimen_001_c02055_fcs")
# 
# path_to_gold_standard_control_files_19 <- paste0(source_path, "home/trufenc/fcs_files/c145/Specimen_001_c02056_fcs")
# 
# path_to_gold_standard_control_files_20 <- paste0(source_path, "home/trufenc/fcs_files/c145/Specimen_001_c02057_fcs")
# 
# 
# 
# path_to_files <- list(path_to_gold_standard_control_files_1,
#                       path_to_gold_standard_control_files_2,
#                       path_to_gold_standard_control_files_3,
#                       path_to_gold_standard_control_files_4,
#                       path_to_gold_standard_control_files_5,
#                       path_to_gold_standard_control_files_6,
#                       path_to_gold_standard_control_files_7,
#                       path_to_gold_standard_control_files_8,
#                       path_to_gold_standard_control_files_9,
#                       path_to_gold_standard_control_files_10,
#                       path_to_gold_standard_control_files_11,
#                       path_to_gold_standard_control_files_12,
#                       path_to_gold_standard_control_files_13,
#                       path_to_gold_standard_control_files_14,
#                       path_to_gold_standard_control_files_15,
#                       path_to_gold_standard_control_files_16,
#                       path_to_gold_standard_control_files_17,
#                       path_to_gold_standard_control_files_18,
#                       path_to_gold_standard_control_files_19,
#                       path_to_gold_standard_control_files_20
#                       )
# 
# files <- path_to_files %>% purrr::map(list.files, pattern = ".fcs", full.names = TRUE)
# 
# file_names <- path_to_files %>% purrr::map(list.files, pattern = ".fcs")
# 
# indices_list <- purrr::map(seq_along(files), function(j) purrr::map(seq_along(panel_A_classes), function(i) files[[j]] %>% str_which(pattern = panel_A_classes[i])) %>% unlist())
# files_to_load_list <- purrr::map(seq_along(files), function(j) files[[j]][indices_list[[j]]])
# files_to_load_names_list <- purrr::map(seq_along(files), function(j) file_names[[j]][indices_list[[j]]])
# files_to_load_list[[9]] <- files_to_load_list[[9]][-c(56)]
# files_to_load_names_list[[9]] <- files_to_load_names_list[[9]][-c(56)]
# files_to_load_list[[13]] <- files_to_load_list[[9]][-c(56)]
# files_to_load_names_list[[13]] <- files_to_load_names_list[[9]][-c(56)]
# 
# # to_load <- files_to_load_list[[6]][53:58] %>% unlist()
# to_load <- files_to_load_list %>% unlist()
# # to_load_names <- files_to_load_names_list[[6]][53:58] %>% unlist()
# to_load_names <- files_to_load_names_list %>% unlist()
# 
# diff_som_1 <- readRDS(file = "~/PRIMUS/home/trufenc/diff_som_12_million_events.rds")
# 
# # diff_som_1_normalized <- diff_som_1 %>% pre_process_data()
# 
# cell_types_control <- diff_som_1$files %>% 
#   str_remove(pattern = ".fcs") %>% 
#   str_remove(pattern = "export_Specimen_..._c....._..._..._") 
# 
# cell_types <- cell_types_control
# # cell_types[cell_types %>% str_which(pattern = "CD8\\+_VM Tcells\\-")] <- NA
# cell_types <- cell_types[!is.na(cell_types)]
# # files_to_load_list %>% unlist()
# 
# # facs_data_df <- diff_som_1_normalized %>% build_fcs_data_df(cell_types = cell_types)
# facs_data_df <- diff_som_1 %>% build_fcs_data_df(cell_types = cell_types)
# 
# facs_data_df <- facs_data_df %>% add_first_gate_column()
# 
# facs_data_df <- facs_data_df %>% add_second_gate_column()
# 
# facs_data_df_step_2 <- facs_data_df %>% dplyr::filter(first_gate != "not_live")
# 
# second_gate_table <- facs_data_df_step_2 %>% group_by(second_gate) %>% tally()
```




```{r}
# n_cells <- 24000
# n_cells <- 20000

# sort data
# reseed()
# facs_data_df_step_2 <- facs_data_df_step_2 %>% dplyr::slice(sample(nrow(facs_data_df_step_2)))
# 
# # balance data
# reseed()
# facs_data_subset_df_step_2 <- facs_data_df_step_2 %>% split(f = .$second_gate) %>% purrr::map(dplyr::slice, sample(n_cells)) %>% bind_rows()
# 
# 
# # Set train and test dfs
# train_index_step_2 <- sample(1:nrow(facs_data_subset_df_step_2), 0.7 * nrow(facs_data_subset_df_step_2))
# 
# train_df_step_2 <- facs_data_subset_df_step_2[train_index_step_2, ] %>% dplyr::select(-c("Time", "File", "File_scattered", "cell_type", "first_gate"))
# val_df_step_2 <- facs_data_subset_df_step_2[-train_index_step_2, ] %>% dplyr::select(-c("Time", "File", "File_scattered", "cell_type", "first_gate"))

# rf_train_step_2 <- train_df_step_2 %>% mutate(second_gate = second_gate %>% factor(levels = c("CD4-NKT_cells", "CD4+NKT_cells", "CD8+_cells", "gdTCR_cells", "NK_cells", "Not_Panel_A_cell_types", "Th_CD4+_cells", "Tregs_CD4+_cells")))
# 
# library(spm)
# 
# tic()
# rf_cv_results <- rgcv(trainx = rf_train_step_2 %>% dplyr::select(-c(second_gate)), trainy = rf_train_step_2$second_gate, num.trees = 500, mtry = 1, splitrule = "extratrees", min.node.size = 1, max.depth = 1, num.threads = 50)
# toc()


library(xgboost)
step_2_levels <- train_df_step_2$second_gate %>% unique()

n_classes <- length(step_2_levels)

classes_number <- data.frame(
  classes = step_2_levels,
  Number = 1:length(step_2_levels)
)

val_label_step_2 <- val_df_step_2 %>%
  dplyr::select(second_gate) %>%
  pull() %>%
  str_replace(pattern = "CD4\\-NKT_cells", replacement = "1") %>%
  str_replace(pattern = "CD4\\+NKT_cells", replacement = "2") %>%
  str_replace(pattern = "CD8\\+_cells", replacement = "3") %>%
  str_replace(pattern = "gdTCR_cells", replacement = "4") %>%
  str_replace(pattern = "NK_cells", replacement = "5") %>%
  str_replace(pattern = "Th_CD4\\+_cells", replacement = "6") %>%
  str_replace(pattern = "Tregs_CD4\\+_cells", replacement = "7") %>%
  str_replace(pattern = "Not_Panel_A_cell_types", replacement = "8") %>%
  as.numeric() %>%
  "-"(1)

train_label_step_2 <- train_df_step_2 %>%
  dplyr::select(second_gate) %>%
  pull() %>%
  str_replace(pattern = "CD4\\-NKT_cells", replacement = "1") %>%
  str_replace(pattern = "CD4\\+NKT_cells", replacement = "2") %>%
  str_replace(pattern = "CD8\\+_cells", replacement = "3") %>%
  str_replace(pattern = "gdTCR_cells", replacement = "4") %>%
  str_replace(pattern = "NK_cells", replacement = "5") %>%
  str_replace(pattern = "Th_CD4\\+_cells", replacement = "6") %>%
  str_replace(pattern = "Tregs_CD4\\+_cells", replacement = "7") %>%
  str_replace(pattern = "Not_Panel_A_cell_types", replacement = "8") %>% 
  as.numeric() %>%
  "-"(1)

train_matrix_step_2 <- xgb.DMatrix(
  data = train_df_step_2 %>%  
    dplyr::select(-c(Time, File, File_scattered, cell_type, first_gate, second_gate)) %>%
    # dplyr::select(-c(second_gate)) %>%
    as.matrix(),
  label = train_label_step_2
  )

val_matrix_step_2 <- xgb.DMatrix(
  data = val_df_step_2 %>%  
    dplyr::select(-c(Time, File, File_scattered, cell_type, first_gate, second_gate)) %>%
    # dplyr::select(-c(second_gate)) %>%
    as.matrix(),
  label = val_label_step_2
  )

k_fold <- 10

n_round <- 100

# xgb_params <- list(
#   booster = "gbtree",
#   # booster = "dart",
#   objective = "multi:softprob",
#   eta = 0.1,
#   gamma = 6.22,
#   max_depth = 10,
#   min_child_weight = 9.11,
#   subsample = 0.991,
#   colsample_bytree = 0.955,
#   num_class = n_classes,
#   nthread = 50
# )

xgb_params <- list(
  booster = "gbtree",
  # booster = "dart",
  objective = "multi:softprob",
  eta = 0.3,
  gamma = 0,
  max_depth = 9,
  min_child_weight = 9.92,
  subsample = 1,
  colsample_bytree = 1,
  num_class = n_classes,
  nthread = 6
)

tic()
xgb_cv_model_2 <- xgb.cv(
  params = xgb_params,
  data = train_matrix_step_2,
  nrounds = n_round,
  nfold = k_fold,
  showsd = T,
  stratified = T,
  print_every_n = 1,
  early_stopping_rounds = 2,
  maximize = F,
  prediction = TRUE
)
toc()

xgb_cv_model_2$best_iteration

xgb_cv_model_2$evaluation_log %>% dplyr::filter(iter == xgb_cv_model_2$best_iteration) %>% dplyr::select(test_merror_mean) %>% pull

xgb_cv_model_2$evaluation_log %>% mutate(diff = test_merror_mean - train_merror_mean) %>% View()

xgb_cv_model_2$evaluation_log %>% 
  ggplot(aes(x = iter)) +
  geom_line(aes(y = train_merror_mean, colour = "train")) + 
  geom_line(aes(y = test_merror_mean, colour = "test"))

# first default - model training
tic()
xgb_2 <- xgb.train(
  params = xgb_params, 
  data = train_matrix_step_2, 
  nrounds = xgb_cv_model_2$best_iteration,
  # nrounds = 19, 
  watchlist = list(val = val_matrix_step_2, train = train_matrix_step_2), 
  print_every_n = 1, 
  early_stopping_rounds = 10, 
  maximize = F , 
  eval_metric = "merror"
  )
toc()

# xgb_2 %>% saveRDS(paste0(source_path, "home/trufenc/xgboost_model_step_2_2020_10_22.rds"))
# xgb_2 %>% saveRDS(paste0(source_path, "home/trufenc/xgboost_model_step_2_2020_11_04.rds"))

xgb_pred <- predict(xgb_2, val_matrix_step_2)

val_prediction_df <- matrix(
  data = xgb_pred,
  nrow = n_classes,
  ncol = length(xgb_pred) / n_classes
  ) %>%
  t() %>%
  data.frame()

val_prediction <- val_prediction_df %>%
  mutate(
    label = val_label_step_2 %>% as.numeric() + 1,
    max_prob = max.col(., "last")
  )

library(caret)
confusion_matrix <- confusionMatrix(factor(val_prediction$label), factor(val_prediction$max_prob))

#view variable importance plot
importance_matrix <- xgb.importance(feature_names = colnames(train_matrix_step_2), model = xgb_2)

gp = xgb.ggplot.importance(importance_matrix = importance_matrix)
print(gp)
```

# independent dataset to test
# https://github.com/RGLab/flowCore/issues/108
```{r}
path_to_test_files_1 <- paste0(source_path, "home/trufenc/fcs_files/c120/Specimen_001_c00259_fcs")

path_to_test_files_2 <- paste0(source_path, "home/trufenc/fcs_files/c120/Specimen_001_c00260_fcs")

path_to_test_files_3 <- paste0(source_path, "home/trufenc/fcs_files/c120/Specimen_001_c00261_fcs")

path_to_test_files_4 <- paste0(source_path, "home/trufenc/fcs_files/c120/Specimen_001_c00262_fcs")

path_to_test_files_5 <- paste0(source_path, "home/trufenc/fcs_files/c120/Specimen_001_c00263_fcs")

path_to_test_files_6 <- paste0(source_path, "home/trufenc/fcs_files/c120/Specimen_001_c00273_fcs")

path_to_test_files_7 <- paste0(source_path, "home/trufenc/fcs_files/c120/Specimen_001_c00602_fcs")

path_to_test_files_8 <- paste0(source_path, "home/trufenc/fcs_files/c120/Specimen_001_c00603_fcs")

path_to_test_files_9 <- paste0(source_path, "home/trufenc/fcs_files/c120/Specimen_001_c00604_fcs")

path_to_test_files_10 <- paste0(source_path, "home/trufenc/fcs_files/c120/Specimen_001_c002601_fcs")

test_path_to_files <- list(
  path_to_test_files_1,
  path_to_test_files_2,
  path_to_test_files_3,
  path_to_test_files_4,
  path_to_test_files_5,
  path_to_test_files_6,
  path_to_test_files_7,
  path_to_test_files_8,
  path_to_test_files_9,
  path_to_test_files_10
)

test_files <- test_path_to_files %>% purrr::map(list.files, pattern = ".fcs", full.names = TRUE)

test_file_names <- test_path_to_files %>% purrr::map(list.files, pattern = ".fcs")

test_indices_list <- purrr::map(seq_along(test_files), function(j) purrr::map(seq_along(panel_A_classes), function(i) test_files[[j]] %>% str_which(pattern = panel_A_classes[i])) %>% unlist())

test_files_to_load_list <- purrr::map(seq_along(test_files), function(j) test_files[[j]][test_indices_list[[j]]])

test_files_to_load_names_list <- purrr::map(seq_along(test_files), function(j) test_file_names[[j]][test_indices_list[[j]]])

# files_to_load_list[[9]] <- files_to_load_list[[9]][-c(56)]
# files_to_load_names_list[[9]] <- files_to_load_names_list[[9]][-c(56)]
# files_to_load_list[[13]] <- files_to_load_list[[9]][-c(56)]
# files_to_load_names_list[[13]] <- files_to_load_names_list[[9]][-c(56)]

# test_files_to_load <- list.files(path = test_path_to_files, pattern = ".fcs", full.names = TRUE)

# test_files_to_load <- test_files_to_load[-33]

tic()
test_diff_som <- test_files_to_load_list %>% unlist() %>% load_fcs_files(n_cells = 1e20, filter = TRUE, to_filter = c(1:6), scale = FALSE, transform = TRUE, to_transform = c(1:18))
toc()

test_diff_som <- readRDS(paste0(source_path, "home/trufenc/test_diff_som_11_2020.rds"))

test_cell_types_control <- test_diff_som$files %>% 
  unlist() %>% 
  str_remove(pattern = ".fcs") %>% 
  str_remove(pattern = "export_Specimen_..._c....._..._..._")

test_cell_types <- test_cell_types_control
test_cell_types <- test_cell_types[!is.na(test_cell_types)]

test_facs_data_df <- test_diff_som %>% build_fcs_data_df(cell_types = test_cell_types)

test_facs_data_df <- test_facs_data_df %>% add_first_gate_column()

test_facs_data_df <- test_facs_data_df %>% add_second_gate_column()

test_df_step_2 <- test_facs_data_df %>% dplyr::filter(first_gate != "not_live")

step_2_levels <- test_df_step_2$second_gate %>% unique()

n_classes <- length(step_2_levels)

test_label <- test_df_step_2 %>%
  dplyr::select(second_gate) %>%
  pull() %>%
  str_replace(pattern = "CD4\\-NKT_cells", replacement = "1") %>%
  str_replace(pattern = "CD4\\+NKT_cells", replacement = "2") %>%
  str_replace(pattern = "CD8\\+_cells", replacement = "3") %>%
  str_replace(pattern = "gdTCR_cells", replacement = "4") %>%
  str_replace(pattern = "NK_cells", replacement = "5") %>%
  str_replace(pattern = "Th_CD4\\+_cells", replacement = "6") %>%
  str_replace(pattern = "Tregs_CD4\\+_cells", replacement = "7") %>%
  str_replace(pattern = "Not_Panel_A_cell_types", replacement = "8") %>% 
  as.numeric() %>%
  "-"(1)

test_matrix <- xgb.DMatrix(
  # data = EmbedSOM_results_step_2$weights_df[-test_indices, ] %>%
  # data = test_EmbedSOM_results_step_2$weights_df %>%  
  data = test_df_step_2 %>%    
    dplyr::select(-c(Time, File, File_scattered, cell_type, first_gate, second_gate)) %>%
    # dplyr::select(-c(first_gate)) %>%
    as.matrix(),
  label = test_label
  )

xgb_pred_2 <- predict(xgb_2, test_matrix)

test_prediction_df <- matrix(
  data = xgb_pred_2,
  nrow = n_classes,
  ncol = length(xgb_pred_2) / n_classes
  ) %>%
  t() %>%
  data.frame()

test_prediction <- test_prediction_df %>%
  mutate(
    label = test_label %>% as.numeric() + 1,
    max_prob = max.col(., "last")
  )

library(caret)
test_confusion_matrix <- confusionMatrix(factor(test_prediction$label), factor(test_prediction$max_prob))

#view variable importance plot
test_importance_matrix <- xgb.importance(feature_names = colnames(train_matrix_step_2), model = xgb_2)

gp = xgb.ggplot.importance(importance_matrix = importance_matrix)
print(gp)
```

# mlr - xgboost
# Tune max_depth and min_child_weight
```{r}
library(mlr)

# Convert characters to factors
train_df <- train_df_step_2 %>% dplyr::select(-c(Time, File, File_scattered, cell_type, first_gate)) %>% mutate(second_gate = second_gate %>% factor()) %>% as.data.frame()
test_df <- val_df_step_2 %>% dplyr::select(-c(Time, File, File_scattered, cell_type, first_gate)) %>%  mutate(second_gate = second_gate %>% factor()) %>% as.data.frame()

# Do one hot encoding`<br/>
train_df <- createDummyFeatures(obj = train_df, target = "second_gate", method = "1-of-n")
test_df <- createDummyFeatures(obj = test_df, target = "second_gate", method = "1-of-n")

# Create tasks
train_task <- makeClassifTask(data = train_df, target = "second_gate")
test_task <- makeClassifTask(data = test_df, target = "second_gate")

# Create learner
lrn <- makeLearner("classif.xgboost", predict.type = "response")
lrn$par.vals <- list(objective = "multi:softprob", etest_metric = "merror", nrounds = 100L, booster = "gbtree", max_depth = 9, min_child_weight = 9.92, subsample = 1, colsample_bytree = 1, nthread = 6)

# Set parameter space
params <- makeParamSet(
  # makeDiscreteParam("booster", values = c("gbtree", "dart")),
  # makeIntegerParam("max_depth", lower = 3L, upper = 10L),
  # makeNumericParam("min_child_weight", lower = 1L, upper = 10L)
  makeNumericParam("gamma", lower = 0L, upper = 10L)
  # makeNumericParam("subsample", lower = 0.5, upper = 1),
  # makeNumericParam("colsample_bytree", lower = 0.5, upper = 1)
  # makeNumericParam("alpha", lower = 0, upper = 1),
  # makeNumericParam("eta", lower = 0.001, upper = 1)
)

# set resampling strategy
rdesc <- makeResampleDesc("CV", stratify = T, iters = 5L)

# Search strategy
ctrl <- makeTuneControlRandom(maxit = 10L)

# Set parallel backend
# library(parallel)
# library(parallelMap) 
# parallelStartSocket(cpus = (detectCores()-1))
# parallelStartSocket(cpus = 6)

#parameter tuning
tic()
xgb_tuning <- tuneParams(learner = lrn, task = train_task, resampling = rdesc, measures = acc, par.set = params, control = ctrl, show.info = T)
toc()

# xgb_tuning %>% saveRDS("~/Documents/xgb_tuning_step_2_balanced_data.rds")
# xgb_tuning <- readRDS("~/Documents/xgb_tuning_step_2_balanced_data.rds")

xgb_tuning$y

#set hyperparameters
lrn_tune <- setHyperPars(lrn,par.vals = xgb_tuning$x)

#train model
xg_model <- train(learner = lrn_tune, task = train_task)

#predict model
xg_pred <- predict(xg_model, test_task)

confusion_matrix <- confusionMatrix(xg_pred$data$response, xg_pred$data$truth)

conf_df <- confusion_matrix$byClass %>% as.data.frame()

conf_df$F1
```












```{r}
path_to_control_files_1 <- paste0(source_path, "data/83_IMPC_DATA/Immunology/CCP_Phenotyping_Immunology_Data_JB/CCP_cohorts_2018/CCP_cohorts_2018_12/2018_12_27_C067/2018_12_27_PA/C067_cA1556_gates")

path_to_control_files_2 <- paste0(source_path, "data/83_IMPC_DATA/Immunology/CCP_Phenotyping_Immunology_Data_JB/CCP_cohorts_2019/CCP_cohorts_2019_10/2019_10_29_C108/2019_10_29_PA/gates_c90692")

path_to_control_files_3 <- paste0(source_path, "data/83_IMPC_DATA/Immunology/CCP_Phenotyping_Immunology_Data_JB/CCP_cohorts_2019/CCP_cohorts_2019_10/2019_10_29_C108/2019_10_29_PA/gates_c90695")

path_to_control_files_4 <- paste0(source_path, "data/83_IMPC_DATA/Immunology/CCP_Phenotyping_Immunology_Data_JB/CCP_cohorts_2019/CCP_cohorts_2019_06/2019_06_10_C088/C088_PA_c89141_gates")

path_to_control_files_5 <- paste0(source_path, "data/83_IMPC_DATA/Immunology/CCP_Phenotyping_Immunology_Data_JB/CCP_cohorts_2019/CCP_cohorts_2019_06/2019_06_10_C088/C088_PA_c90043_gates")

path_to_ko_files_1 <- paste0(source_path, "data/83_IMPC_DATA/Immunology/CCP_Phenotyping_Immunology_Data_JB/CCP_cohorts_2019/CCP_cohorts_2019_10/2019_10_29_C108/2019_10_29_PA/gates_tgE8038")

path_to_ko_files_2 <- paste0(source_path, "data/83_IMPC_DATA/Immunology/CCP_Phenotyping_Immunology_Data_JB/CCP_cohorts_2019/CCP_cohorts_2019_10/2019_10_29_C108/2019_10_29_PA/gates_tgE8040")
```

```{r}
path_to_files <- list(path_to_control_files_1,
                      path_to_control_files_2,
                      path_to_control_files_3,
                      path_to_control_files_4,
                      path_to_control_files_5)

path_to_ko_files <- list(path_to_ko_files_1,
                           path_to_ko_files_2)
```

```{r files}
files <- path_to_files %>% purrr::map(list.files, pattern = ".fcs", full.names = TRUE)
ko_files <- path_to_ko_files %>% purrr::map(list.files, pattern = ".fcs", full.names = TRUE)
```

```{r file_names}
file_names <- path_to_files %>% purrr::map(list.files, pattern = ".fcs")
ko_files_names <- path_to_ko_files %>% purrr::map(list.files, pattern = ".fcs")
```

```{r}
panel_A_classes <- c(
  "_clog\\+.fcs",
  "_clog\\-_cells\\-.fcs",
  "_S1\\-.fcs",
  "_dead.fcs",
  "_S2\\-.fcs",
  "gdTCR_Eff_Klrg1\\-.fcs",
  "gdTCR_Eff_Klrg1\\+.fcs",
  "gdTCR_Res_Klrg1\\-.fcs",
  "gdTCR_Res_Klrg1\\+.fcs",
  "gdTCR_neg_Klrg1\\-.fcs",
  "gdTCR_neg_Klrg1\\+.fcs",
  "NK_Eff_Klrg1\\-.fcs",
  "NK_Eff_Klrg1\\+.fcs",
  "NK_Res_Klrg1\\-.fcs",
  "NK_Res_Klrg1\\+.fcs",
  "NK_neg_Klrg1\\+\\-.fcs",
  "NK_neg_Klrg1\\+.fcs",
  #"_CD5\\+\\-.fcs",
  #"_CD4\\+ NKT\\+ or CD4\\- NKT\\+\\-.fcs",
  "CD4\\-NKT_Eff_Klrg1\\-.fcs",
  "CD4\\-NKT_Eff_Klrg1\\+.fcs",
  "CD4\\-NKT_Res_Klrg1\\-.fcs",
  "CD4\\-NKT_Res_Klrg1\\+.fcs",
  "CD4\\-NKT_neg_Klrg1\\-.fcs",
  "CD4\\-NKT_neg_Klrg1\\+.fcs",
  "CD4\\+NKT_Eff_Klrg1\\-.fcs",
  "CD4\\+NKT_Eff_Klrg1\\+.fcs",
  "CD4\\+NKT_Res_Klrg1\\-.fcs",
  "CD4\\+NKT_Res_Klrg1\\+.fcs",
  "CD4\\+NKT_neg_Klrg1\\-.fcs",
  "CD4\\+NKT_neg_Klrg1\\+.fcs",
  "DN .fcs",
  "Tregs_Eff_Klrg1\\-.fcs",
  "Tregs_Eff_Klrg1\\+.fcs",
  "Tregs_Res_Klrg1\\-.fcs",
  "Tregs_Res_Klrg1\\+.fcs",
  "Tregs_neg_Klrg1\\-.fcs",
  "Tregs_neg_Klrg1\\+.fcs",
  "Th_Eff_Klrg1\\-.fcs",
  "Th_Eff_Klrg1\\+.fcs",
  "Th_Res_Klrg1\\-.fcs",
  "Th_Res_Klrg1\\+.fcs",
  "Th_neg_Klrg1\\-.fcs",
  "Th_neg_Klrg1\\+.fcs",
  "CD8_Naive_Klrg1\\-_VM Tcells\\-.fcs",
  "CD8_Naive_Klrg1\\-_VM Tcells.fcs",
  "CD8_Naive_Klrg1\\+_VM Tcells\\-.fcs",
  "CD8_Naive_Klrg1\\+_VM Tcells.fcs",
  "CD8_Eff_Klrg1\\-_VM Tcells\\-.fcs",
  "CD8_Eff_Klrg1\\-_VM Tcells.fcs",
  "CD8_Eff_Klrg1\\+_VM Tcells\\-.fcs",
  "CD8_Eff_Klrg1\\+_VM Tcells.fcs",
  "CD8_Res_Klrg1\\-_VM Tcells\\-.fcs",
  "CD8_Res_Klrg1\\-_VM Tcells.fcs",
  "CD8_Res_Klrg1\\+_VM Tcells\\-.fcs",
  "CD8_Res_Klrg1\\+_VM Tcells.fcs",
  "CD8_neg_Klrg1\\-_VM Tcells\\-.fcs",
  "CD8_neg_Klrg1\\-_VM Tcells.fcs",
  "CD8_neg_Klrg1\\+_VM Tcells\\-.fcs",
  "CD8_neg_Klrg1\\+_VM Tcells.fcs"
)
```

```{r}
indices_1 <- purrr::map(seq_along(panel_A_classes), function(i) files[[1]] %>% str_which(pattern = panel_A_classes[i])) %>% unlist()
files_to_load_1 <- files[[1]][indices_1]
files_to_load_names_1 <- file_names[[1]][indices_1]
```

# Second class assignment, more refined - gates_c90692
```{r}
panel_A_classes_2 <- c(
  "clog\\-\\-.fcs",
  "cells\\-.fcs",
  "S1\\-.fcs",
  "dead.fcs",
  "S2\\-.fcs",
  "gd_Eff_Klrg1\\+\\-.fcs",
  "gd_Eff_Klrg1\\+.fcs",
  "gd_Res_Klrg1\\+\\-.fcs",
  "gd_Res_Klrg1\\+.fcs",
  "gd_neg_Klrg1\\+\\-.fcs",
  "gd_neg_Klrg1\\+.fcs",
  "NK_Eff_Klrg1\\+\\-.fcs",
  "NK_Eff_Klrg1\\+.fcs",
  "NK_Res_Klrg1\\+\\-.fcs",
  "NK_Res_Klrg1\\+.fcs",
  "NK_neg_Klrg1\\+\\-.fcs",
  "NK_neg_Klrg1\\+.fcs",
  "CD4\\-NKT_Eff_Klrg1\\+\\-.fcs",
  "CD4\\-NKT_Eff_Klrg1\\+.fcs",
  "CD4\\-NKT_Res_Klrg1\\+\\-.fcs",
  "CD4\\-NKT_Res_Klrg1\\+.fcs",
  "CD4\\-NKT_neg_Klrg1\\+\\-.fcs",
  "CD4\\-NKT_neg_Klrg1\\+.fcs",
  "CD4\\+NKT_Eff_Klrg1\\+\\-.fcs",
  "CD4\\+NKT_Eff_Klrg1\\+.fcs",
  "CD4\\+NKT_Res_Klrg1\\+\\-.fcs",
  "CD4\\+NKT_Res_Klrg1\\+.fcs",
  "CD4\\+NKT_neg_Klrg1\\+\\-.fcs",
  "CD4\\+NKT_neg_Klrg1\\+.fcs",
  "DN .fcs",
  "Treg_Eff_Klrg1\\+\\-.fcs",
  "Treg_Eff_Klrg1\\+.fcs",
  "Treg_Res_Klrg1\\+\\-.fcs",
  "Treg_Res_Klrg1\\+.fcs",
  "Treg_neg_Klrg1\\+\\-.fcs",
  "Treg_neg_Klrg1\\+.fcs",
  "Th_Eff_Klrg1\\+\\-.fcs",
  "Th_Eff_Klrg1\\+.fcs",
  "Th_Res_Klrg1\\+\\-.fcs",
  "Th_Res_Klrg1\\+.fcs",
  "Th_neg_Klrg1\\+\\-.fcs",
  "Th_neg_Klrg1\\+.fcs",
  "CD8\\+_Naive_Klrg1\\-_VM Tcells\\-.fcs",
  "CD8\\+_Naive_Klrg1\\-_VM Tcells.fcs",
  "CD8\\+_Naive_Klrg1\\+_VM Tcells\\-.fcs",
  "CD8\\+_Naive_Klrg1\\+_VM Tcells.fcs",
  "CD8\\+_Eff_Klrg1\\-_VM Tcells\\-.fcs",
  "CD8\\+_Eff_Klrg1\\-_VM Tcells.fcs",
  "CD8\\+_Eff_Klrg1\\+_VM Tcells\\-.fcs",
  "CD8\\+_Eff_Klrg1\\+_VM Tcells.fcs",
  "CD8\\+_Res_Klrg1\\-_VM Tcells\\-.fcs",
  "CD8\\+_Res_Klrg1\\-_VM Tcells.fcs",
  "CD8\\+_Res_Klrg1\\+_VM Tcells\\-.fcs",
  "CD8\\+_Res_Klrg1\\+_VM Tcells.fcs",
  "CD8\\+_neg_Klrg1\\-_VM Tcells\\-.fcs",
  "CD8\\+_neg_Klrg1\\-_VM Tcells.fcs",
  "CD8\\+_neg_Klrg1\\+_VM Tcells\\-.fcs",
  "CD8\\+_neg_Klrg1\\+_VM Tcells.fcs"
)
```

```{r}
indices_2 <- purrr::map(seq_along(panel_A_classes_2), function(i) files[[2]] %>% str_which(pattern = panel_A_classes_2[i])) %>% unlist()
files_to_load_2 <- files[[2]][indices_2]
files_to_load_names_2 <- file_names[[2]][indices_2]

files_to_load_2[files_to_load_2 %>% str_which(pattern = "CD8\\+_VM Tcells\\-")] <- NA
files_to_load_2 <- files_to_load_2[!is.na(files_to_load_2)]
```

# Second class assignment, more refined - gates_c90695
```{r}
panel_A_classes_3 <- panel_A_classes_4 <- panel_A_classes_5 <- c(
  "clog\\-\\-.fcs",
  "clog\\-_cells\\-.fcs",
  "S1\\-.fcs",
  "dead.fcs",
  "S2\\-.fcs",
  "gd_Eff_Klrg1\\+\\-.fcs",
  "gd_Eff_Klrg1\\+.fcs",
  "gd_Res_Klrg1\\+\\-.fcs",
  "gd_Res_Klrg1\\+.fcs",
  "gd_neg_Klrg1\\+\\-.fcs",
  "gd_neg_Klrg1\\+.fcs",
  "NK_Eff_Klrg1\\+\\-.fcs",
  "NK_Eff_Klrg1\\+.fcs",
  "NK_Res_Klrg1\\+\\-.fcs",
  "NK_Res_Klrg1\\+.fcs",
  "NK_neg_Klrg1\\+\\-.fcs",
  "NK_neg_Klrg1\\+.fcs",
  "CD4\\-NKT_Eff_Klrg1\\+\\-.fcs",
  "CD4\\-NKT_Eff_Klrg1\\+.fcs",
  "CD4\\-NKT_Res_Klrg1\\+\\-.fcs",
  "CD4\\-NKT_Res_Klrg1\\+.fcs",
  "CD4\\-NKT_neg_Klrg1\\+\\-.fcs",
  "CD4\\-NKT_neg_Klrg1\\+.fcs",
  "CD4\\+NKT_Eff_Klrg1\\+\\-.fcs",
  "CD4\\+NKT_Eff_Klrg1\\+.fcs",
  "CD4\\+NKT_Res_Klrg1\\+\\-.fcs",
  "CD4\\+NKT_Res_Klrg1\\+.fcs",
  "CD4\\+NKT_neg_Klrg1\\+\\-.fcs",
  "CD4\\+NKT_neg_Klrg1\\+.fcs",
  "DN .fcs",
  "Treg_Eff_Klrg1\\+\\-.fcs",
  "Treg_Eff_Klrg1\\+.fcs",
  "Treg_Res_Klrg1\\+\\-.fcs",
  "Treg_Res_Klrg1\\+.fcs",
  "Treg_neg_Klrg1\\+\\-.fcs",
  "Treg_neg_Klrg1\\+.fcs",
  "Th_Eff_Klrg1\\+\\-.fcs",
  "Th_Eff_Klrg1\\+.fcs",
  "Th_Res_Klrg1\\+\\-.fcs",
  "Th_Res_Klrg1\\+.fcs",
  "Th_neg_Klrg1\\+\\-.fcs",
  "Th_neg_Klrg1\\+.fcs",
  "CD8\\+_Naive_Klrg1\\-_VM Tcells\\-.fcs",
  "CD8\\+_Naive_Klrg1\\-_VM Tcells.fcs",
  "CD8\\+_Naive_Klrg1\\+_VM Tcells\\-.fcs",
  "CD8\\+_Naive_Klrg1\\+_VM Tcells.fcs",
  "CD8\\+_Eff_Klrg1\\-_VM Tcells\\-.fcs",
  "CD8\\+_Eff_Klrg1\\-_VM Tcells.fcs",
  "CD8\\+_Eff_Klrg1\\+_VM Tcells\\-.fcs",
  "CD8\\+_Eff_Klrg1\\+_VM Tcells.fcs",
  "CD8\\+_Res_Klrg1\\-_VM Tcells\\-.fcs",
  "CD8\\+_Res_Klrg1\\-_VM Tcells.fcs",
  "CD8\\+_Res_Klrg1\\+_VM Tcells\\-.fcs",
  "CD8\\+_Res_Klrg1\\+_VM Tcells.fcs",
  "CD8\\+_neg_Klrg1\\-_VM Tcells\\-.fcs",
  "CD8\\+_neg_Klrg1\\-_VM Tcells.fcs",
  "CD8\\+_neg_Klrg1\\+_VM Tcells\\-.fcs",
  "CD8\\+_neg_Klrg1\\+_VM Tcells.fcs"
)
```

```{r}
indices_3 <- purrr::map(seq_along(panel_A_classes_3), function(i) files[[3]] %>% str_which(pattern = panel_A_classes_3[i])) %>% unlist()
files_to_load_3 <- files[[3]][indices_3]
files_to_load_names_3 <- file_names[[3]][indices_3]
```

```{r}
indices_4 <- purrr::map(seq_along(panel_A_classes_4), function(i) files[[4]] %>% str_which(pattern = panel_A_classes_4[i])) %>% unlist()
files_to_load_4 <- files[[4]][indices_4]
files_to_load_names_4 <- file_names[[4]][indices_4]
```

```{r}
indices_5 <- purrr::map(seq_along(panel_A_classes_5), function(i) files[[5]] %>% str_which(pattern = panel_A_classes_5[i])) %>% unlist()
files_to_load_5 <- files[[5]][indices_5]
files_to_load_names_5 <- file_names[[5]][indices_5]
```

All the classes for panel A
```{r}
panel_A_classes_v <- c(
  "clog+",
  "cells-",
  "S1-",
  "dead",
  "S2-",
  "gdTCR_Eff_Klrg1-",
  "gdTCR_Eff_Klrg1+",
  "gdTCR_Res_Klrg1-",
  "gdTCR_Res_Klrg1+",
  "gdTCR_neg_Klrg1-",
  "gdTCR_neg_Klrg1+",
  "NK_Eff_Klrg1-",
  "NK_Eff_Klrg1+",
  "NK_Res_Klrg1-",
  "NK_Res_Klrg1+",
  "NK_neg_Klrg1+-",
  "NK_neg_Klrg1+",
  "CD4-NKT_Eff_Klrg1-",
  "CD4-NKT_Eff_Klrg1+",
  "CD4-NKT_Res_Klrg1-",
  "CD4-NKT_Res_Klrg1+",
  "CD4-NKT_neg_Klrg1-",
  "CD4-NKT_neg_Klrg1+",
  "CD4+NKT_Eff_Klrg1-",
  "CD4+NKT_Eff_Klrg1+",
  "CD4+NKT_Res_Klrg1-",
  "CD4+NKT_Res_Klrg1+",
  "CD4+NKT_neg_Klrg1-",
  "CD4+NKT_neg_Klrg1+",
  "DN",
  "Tregs_Eff_Klrg1-",
  "Tregs_Eff_Klrg1+",
  "Tregs_Res_Klrg1-",
  "Tregs_Res_Klrg1+",
  "Tregs_neg_Klrg1-",
  "Tregs_neg_Klrg1+",
  "Th_Eff_Klrg1-",
  "Th_Eff_Klrg1+",
  "Th_Res_Klrg1-",
  "Th_Res_Klrg1+",
  "Th_neg_Klrg1-",
  "Th_neg_Klrg1+",
  "CD8_Naive_Klrg1-_VM Tcells-",
  "CD8_Naive_Klrg1-_VM Tcells",
  "CD8_Naive_Klrg1+_VM Tcells-",
  "CD8_Naive_Klrg1+_VM Tcells",
  "CD8_Eff_Klrg1-_VM Tcells-",
  "CD8_Eff_Klrg1-_VM Tcells",
  "CD8_Eff_Klrg1+_VM Tcells-",
  "CD8_Eff_Klrg1+_VM Tcells",
  "CD8_Res_Klrg1-_VM Tcells-",
  "CD8_Res_Klrg1-_VM Tcells",
  "CD8_Res_Klrg1+_VM Tcells-",
  "CD8_Res_Klrg1+_VM Tcells",
  "CD8_neg_Klrg1-_VM Tcells-",
  "CD8_neg_Klrg1-_VM Tcells",
  "CD8_neg_Klrg1+_VM Tcells-",
  "CD8_neg_Klrg1+_VM Tcells"
)
```

```{r}
ko_indices_1 <- purrr::map(seq_along(panel_A_classes_3), function(i) ko_files[[1]] %>% str_which(pattern = panel_A_classes_3[i])) %>% unlist()
ko_files_to_load_1 <- ko_files[[1]][ko_indices_1]
ko_files_to_load_names_1 <- ko_files_names[[1]][ko_indices_1]
```

```{r}
ko_indices_2 <- purrr::map(seq_along(panel_A_classes_3), function(i) ko_files[[2]] %>% str_which(pattern = panel_A_classes_3[i])) %>% unlist()
ko_files_to_load_2 <- ko_files[[2]][ko_indices_2]
ko_files_to_load_names_2 <- ko_files_names[[2]][ko_indices_2]
```


```{r}
files_to_load <- c(files_to_load_1, files_to_load_2, files_to_load_4, files_to_load_5, ko_files_to_load_1, ko_files_to_load_2)
files_to_load[files_to_load %>% str_which(pattern = "CD8\\+_VM Tcells\\-")] <- NA
files_to_load <- files_to_load[!is.na(files_to_load)]

test_files <- c(files_to_load_3)
```


# Load files and pre-procees them ()
```{r pre_process_data}
diff_som_2 <- files_to_load %>% load_fcs_files(n_cells = 1e20, filter = TRUE, toFilter = c(1:6), scale = FALSE, transform = TRUE, toTransform = c(1:18))
test_diff_som <- test_files %>% load_fcs_files(n_cells = 1e20, filter = TRUE, toFilter = c(1:6), scale = FALSE, transform = TRUE, toTransform = c(1:18))
```

```{r}
pre_process_data <- function(diff_som, to_transform = c(1:18)){
  # diff_som$fs$data <- diff_som$fs$data %>% purrr::set_names(str_remove(string = names(diff_som$fs$data), pattern = "FJComp."))
  diff_som_df <- diff_som$fs$data %>% as.data.frame() %>% dplyr::select(-c(Time, File, File_scattered))
  normally_dstributed <- diff_som_df %>% purrr::map(bestNormalize::orderNorm)
  normally_dstributed_df <- purrr::map(seq_along(normally_dstributed), function(i) normally_dstributed[[i]]$x.t) %>% purrr::set_names(colnames(diff_som_df)) %>% purrr::map(scale, center = TRUE, scale = TRUE) %>% purrr::map(scale_to_range_0_1) %>% bind_cols()
  diff_som$fs$data[, to_transform] <- normally_dstributed_df %>% as.matrix()
  return(diff_som)
}
```

```{r}
# diff_som_2 %>% saveRDS(file = paste0(source_path, "/home/trufenc/diff_som_2_2020_07_28.rds"))
# test_diff_som %>% saveRDS(file = paste0(source_path, "/home/trufenc/test_diff_som_2020_07_28.rds"))
```

```{r}
diff_som_2 <- readRDS(file = paste0(source_path, "home/trufenc/diff_som_2_2020_07_28.rds"))
test_diff_som <- readRDS(file = paste0(source_path, "home/trufenc/test_diff_som_2020_07_28.rds"))
```

```{r}
diff_som_2_normalized <- diff_som_2 %>% pre_process_data()
test_diff_som_normalized <- test_diff_som %>% pre_process_data()
```

```{r}
# cell_types <- files_to_load_names %>% str_remove(pattern = ".fcs") %>% str_remove(pattern = "export_Specimen_..._c....._..._..._")
cell_types_control <- c(files_to_load_names_1, files_to_load_names_2, files_to_load_names_4, files_to_load_names_5) %>% 
  str_remove(pattern = ".fcs") %>% 
  str_remove(pattern = "export_Specimen_..._c....._..._..._")

cell_types_ko <- c(ko_files_to_load_names_1, ko_files_to_load_names_2) %>% 
  str_remove(pattern = ".fcs") %>% 
  str_remove(pattern = "export_Specimen_..._tg....._..._..._")

cell_types <- c(cell_types_control, cell_types_ko)
cell_types[cell_types %>% str_which(pattern = "CD8\\+_VM Tcells\\-")] <- NA
cell_types <- cell_types[!is.na(cell_types)]
```

# function build_fcs_data_df
```{r build_fcs_data_df}
build_fcs_data_df <- function(cell_types, diff_som) {
  
  cell_types_df <- cell_types %>%
    as.data.frame() %>%
    rownames_to_column() %>%
    dplyr::rename("cell_types" = ".", "File" = "rowname") %>%
    mutate(File = File %>% as.numeric())

  cell_types_df <- cell_types_df %>%
    mutate(cell_types = cell_types %>% recode(
      "clog--" = "clog+",
      "clog-_cells-" = "cells-",
      "cells_S1-" = "S1-",
      "S2_dead" = "dead",
      "S1_S2-" = "S2-",
      "NK_Eff_Klrg1+-" = "NK_Eff_Klrg1-",
      "NK_Res_Klrg1+-" = "NK_Res_Klrg1-",
      "NK_neg_Klrg1+-" = "NK_neg_Klrg1-",
      "gd_Eff_Klrg1+" = "gdTCR_Eff_Klrg1+",
      "gd_Eff_Klrg1+-" = "gdTCR_Eff_Klrg1-",
      "gd_Res_Klrg1+" = "gdTCR_Res_Klrg1+",
      "gd_Res_Klrg1+-" = "gdTCR_Res_Klrg1-",
      "gd_neg_Klrg1+" = "gdTCR_neg_Klrg1+",
      "gd_neg_Klrg1+-" = "gdTCR_neg_Klrg1-",
      "CD4-NKT_Eff_Klrg1+-" = "CD4-NKT_Eff_Klrg1-",
      "CD4-NKT_Res_Klrg1+-" = "CD4-NKT_Res_Klrg1-",
      "CD4-NKT_neg_Klrg1+-" = "CD4-NKT_neg_Klrg1-",
      "CD4+NKT_Eff_Klrg1+-" = "CD4+NKT_Eff_Klrg1-",
      "CD4+NKT_Res_Klrg1+-" = "CD4+NKT_Res_Klrg1-",
      "CD4+NKT_neg_Klrg1+-" = "CD4+NKT_neg_Klrg1-",
      "Th_Eff_Klrg1+-" = "Th_Eff_Klrg1-",
      "Th_Res_Klrg1+-" = "Th_Res_Klrg1-",
      "Th_neg_Klrg1+-" = "Th_neg_Klrg1-",
      "Treg_Eff_Klrg1+-" = "Tregs_Eff_Klrg1-",
      "Treg_Res_Klrg1+-" = "Tregs_Res_Klrg1-",
      "Treg_neg_Klrg1+-" = "Tregs_neg_Klrg1-",
      "Treg_Eff_Klrg1+" = "Tregs_Eff_Klrg1+",
      "Treg_Res_Klrg1+" = "Tregs_Res_Klrg1+",
      "Treg_neg_Klrg1+" = "Tregs_neg_Klrg1+",
      "CD8_Naive_Klrg1-_VM Tcells" = "CD8_Naive_Klrg1-_VM Tcells+",
      "CD8_Naive_Klrg1+_VM Tcells" = "CD8_Naive_Klrg1+_VM Tcells+",
      "CD8_Eff_Klrg1-_VM Tcells" = "CD8_Eff_Klrg1-_VM Tcells+",
      "CD8_Eff_Klrg1+_VM Tcells" = "CD8_Eff_Klrg1+_VM Tcells+",
      "CD8_Res_Klrg1-_VM Tcells" = "CD8_Res_Klrg1-_VM Tcells+",
      "CD8_Res_Klrg1+_VM Tcells" = "CD8_Res_Klrg1+_VM Tcells+",
      "CD8_neg_Klrg1-_VM Tcells" = "CD8_neg_Klrg1-_VM Tcells+",
      "CD8_neg_Klrg1+_VM Tcells" = "CD8_neg_Klrg1+_VM Tcells+",
      "CD8+_Eff_Klrg1-_VM Tcells-" = "CD8_Eff_Klrg1-_VM Tcells-",
      "CD8+_Eff_Klrg1+_VM Tcells" = "CD8_Eff_Klrg1+_VM Tcells+",
      "CD8+_Eff_Klrg1+_VM Tcells-" = "CD8_Eff_Klrg1+_VM Tcells-",
      "CD8+_Naive_Klrg1-_VM Tcells" = "CD8_Naive_Klrg1-_VM Tcells+",
      "CD8+_Naive_Klrg1-_VM Tcells-" = "CD8_Naive_Klrg1-_VM Tcells-",
      "CD8+_Naive_Klrg1+_VM Tcells" = "CD8_Naive_Klrg1+_VM Tcells+",
      "CD8+_Naive_Klrg1+_VM Tcells-" = "CD8_Naive_Klrg1+_VM Tcells-",
      "CD8+_neg_Klrg1-_VM Tcells" = "CD8_neg_Klrg1-_VM Tcells+",
      "CD8+_neg_Klrg1-_VM Tcells-" = "CD8_neg_Klrg1-_VM Tcells-",
      "CD8+_neg_Klrg1+_VM Tcells" = "CD8_neg_Klrg1+_VM Tcells+",
      "CD8+_neg_Klrg1+_VM Tcells-" = "CD8_neg_Klrg1+_VM Tcells-",
      "CD8+_Res_Klrg1-_VM Tcells" = "CD8_Res_Klrg1-_VM Tcells+",
      "CD8+_Res_Klrg1-_VM Tcells-" = "CD8_Res_Klrg1-_VM Tcells-",
      "CD8+_Res_Klrg1+_VM Tcells" = "CD8_Res_Klrg1+_VM Tcells+",
      "CD8+_Res_Klrg1+_VM Tcells-" = "CD8_Res_Klrg1+_VM Tcells-"
    ))

  manual_gating <- diff_som$fs$data %>%
    as.data.frame() %>%
    full_join(cell_types_df) %>%
    na.omit() %>%
    dplyr::select(cell_types) %>%
    unlist() %>%
    as.character() %>%
    factor()

  facs_data_df <- diff_som$fs$data %>%
    as.data.frame() %>%
    dplyr::select(c(1:19))
  # facs_data_df <- diff_som$fs$data %>% as.data.frame() %>% dplyr::select(to_transform)

  facs_data_df <- facs_data_df %>%
    purrr::set_names(str_remove(string = names(facs_data_df), pattern = "FJComp."))

  facs_data_df <- facs_data_df %>%
    mutate(cell_type = manual_gating)
  
  return(facs_data_df)
}

# facs_data_df <- diff_som_2_normalized %>% build_fcs_data_df(cell_types = cell_types)
# 
# facs_data_df <- facs_data_df %>% 
#   mutate(first_gate = case_when(!(cell_type %in% c("clog+", "cells-", "S1-", "S2-", "dead")) ~ "live"))
#   
# facs_data_df <- facs_data_df %>% 
#   mutate(first_gate = if_else(is.na(first_gate), true = "not_live", false = first_gate))
```

```{r}
add_first_gate_column <- function(facs_data_df) {
  facs_data_df <- facs_data_df %>%
    mutate(first_gate = case_when(!(cell_type %in% c("clog+", "cells-", "S1-", "S2-", "dead")) ~ "live"))

  facs_data_df <- facs_data_df %>%
    mutate(first_gate = if_else(is.na(first_gate), true = "not_live", false = first_gate))
  return(facs_data_df)
}
```

```{r}
add_second_gate_column <- function(facs_data_df) {

  facs_data_df <- facs_data_df %>%
    mutate(second_gate = if_else(first_gate %>% str_detect(pattern = "not_live"), true = "not_live", false = as.character(cell_type)))

  facs_data_df <- facs_data_df %>%
    mutate(second_gate = if_else(second_gate %in% c("gdTCR_neg_Klrg1-", "gdTCR_neg_Klrg1+", "NK_neg_Klrg1-", "NK_neg_Klrg1+", "CD4-NKT_neg_Klrg1-", "CD4-NKT_neg_Klrg1+", "CD4+NKT_neg_Klrg1-", "CD4+NKT_neg_Klrg1+", "Tregs_neg_Klrg1-", "Tregs_neg_Klrg1+", "Th_neg_Klrg1-", "Th_neg_Klrg1+", "CD8_neg_Klrg1-_VM Tcells-", "CD8_neg_Klrg1-_VM Tcells+", "CD8_neg_Klrg1+_VM Tcells-", "CD8_neg_Klrg1+_VM Tcells+"), true = "Not_Panel_A_cell_types", false = second_gate))

  facs_data_df <- facs_data_df %>%
    mutate(second_gate = if_else(second_gate %>% str_detect(pattern = "gdTCR"), true = "gdTCR_cells", false = second_gate)) %>%
    mutate(second_gate = if_else(second_gate %>% str_detect(pattern = "NK_"), true = "NK_cells", false = second_gate)) %>%
    mutate(second_gate = if_else(second_gate %>% str_detect(pattern = "CD4\\-NKT_"), true = "CD4-NKT_cells", false = second_gate)) %>%
    mutate(second_gate = if_else(second_gate %>% str_detect(pattern = "CD4\\+NKT_"), true = "CD4+NKT_cells", false = second_gate)) %>%
    mutate(second_gate = if_else(second_gate %>% str_detect(pattern = "Tregs_"), true = "Tregs_CD4+_cells", false = second_gate)) %>%
    mutate(second_gate = if_else(second_gate %>% str_detect(pattern = "Th_"), true = "Th_CD4+_cells", false = second_gate)) %>%
    mutate(second_gate = if_else(second_gate %>% str_detect(pattern = "CD8"), true = "CD8+_cells", false = second_gate))

  return(facs_data_df)
}
# facs_data_df %>% vroom::vroom_write(paste(source_path, "home/trufenc/facs_data_df_complete_step_2.tsv"))
```

```{r}
# facs_data_df <- facs_data_df %>%
#   mutate(second_gate = if_else(first_gate %>% str_detect(pattern = "not_live"), true = "not_live", false =  as.character(cell_type)))
#
# facs_data_df <- facs_data_df %>%
#   mutate(second_gate = if_else(second_gate %in% c("gdTCR_neg_Klrg1-", "gdTCR_neg_Klrg1+", "NK_neg_Klrg1-", "NK_neg_Klrg1+", "CD4-NKT_neg_Klrg1-", "CD4-NKT_neg_Klrg1+", "CD4+NKT_neg_Klrg1-", "CD4+NKT_neg_Klrg1+", "Tregs_neg_Klrg1-", "Tregs_neg_Klrg1+", "Th_neg_Klrg1-", "Th_neg_Klrg1+", "CD8_neg_Klrg1-_VM Tcells-", "CD8_neg_Klrg1-_VM Tcells+", "CD8_neg_Klrg1+_VM Tcells-",  "CD8_neg_Klrg1+_VM Tcells+"), true = "Not_Panel_A_cell_types", false =  second_gate))
#
# facs_data_df <- facs_data_df %>%
#   mutate(second_gate = if_else(second_gate %>% str_detect(pattern = "gdTCR"), true = "gdTCR_cells", false =  second_gate)) %>%
#   mutate(second_gate = if_else(second_gate %>% str_detect(pattern = "NK_"), true = "NK_cells", false =  second_gate)) %>%
#   mutate(second_gate = if_else(second_gate %>% str_detect(pattern = "CD4\\-NKT_"), true = "CD4-NKT_cells", false =  second_gate)) %>%
#   mutate(second_gate = if_else(second_gate %>% str_detect(pattern = "CD4\\+NKT_"), true = "CD4+NKT_cells", false =  second_gate)) %>%
#   mutate(second_gate = if_else(second_gate %>% str_detect(pattern = "Tregs_"), true = "Tregs_CD4+_cells", false =  second_gate)) %>%
#   mutate(second_gate = if_else(second_gate %>% str_detect(pattern = "Th_"), true = "Th_CD4+_cells", false =  second_gate)) %>%
#   mutate(second_gate = if_else(second_gate %>% str_detect(pattern = "CD8"), true = "CD8+_cells", false =  second_gate))

# facs_data_df %>% vroom::vroom_write(paste(source_path, "home/trufenc/facs_data_df_complete_step_2.tsv"))
```

```{r}
# facs_data_df <- diff_som_2_normalized %>% build_fcs_data_df(cell_types = cell_types)
facs_data_df <- diff_som_2 %>% build_fcs_data_df(cell_types = cell_types)

facs_data_df <- facs_data_df %>% add_first_gate_column()

facs_data_df <- facs_data_df %>% add_second_gate_column()

# test_facs_data_df <- test_diff_som_normalized %>% build_fcs_data_df(cell_types = cell_types)
test_facs_data_df <- test_diff_som %>% build_fcs_data_df(cell_types = cell_types)

test_facs_data_df <- test_facs_data_df %>% add_first_gate_column()

test_facs_data_df <- test_facs_data_df %>% add_second_gate_column()

facs_data_df <- facs_data_df %>% bind_rows(test_facs_data_df)

facs_data_df <- facs_data_df %>% dplyr::filter(second_gate != "not_live")
```

```{r}
# facs_data_df <- facs_data_df %>% mutate(second_gate = second_gate %>% dplyr::recode("DN " = "Not_Panel_A_cell_types"))
```


```{r}
freq_df <- facs_data_df$second_gate %>% table() %>% as.data.frame() %>% arrange(desc(Freq))

(100000-62988)*100/40
```


# manage imbalance
```{r}
facs_data_df_DN_and_Not <- facs_data_df %>% 
  dplyr::filter(second_gate %in% c("DN ", "Not_Panel_A_cell_types")) %>% dplyr::select(-c("Time", "cell_type", "first_gate"))

new_synthetic_DN <- facs_data_df_DN_and_Not %>% 
  imbalance::rwo(numInstances = 250000, classAttr = "second_gate")

facs_data_df_CD4_p_NKT_and_Not <- facs_data_df %>% 
  dplyr::filter(second_gate %in% c("CD4+NKT_cells", "Not_Panel_A_cell_types")) %>% dplyr::select(-c("Time", "cell_type", "first_gate"))

new_synthetic_CD4_p_NKT <- facs_data_df_CD4_p_NKT_and_Not %>% 
  imbalance::rwo(numInstances = 40000, classAttr = "second_gate")

facs_data_df_NK_and_Not <- facs_data_df %>% 
  dplyr::filter(second_gate %in% c("NK_cells", "Not_Panel_A_cell_types")) %>% dplyr::select(-c("Time", "cell_type", "first_gate"))

new_synthetic_NK<- facs_data_df_NK_and_Not %>% 
  imbalance::rwo(numInstances = 80000, classAttr = "second_gate")

facs_data_df_gdTCR_and_Not <- facs_data_df %>% 
  dplyr::filter(second_gate %in% c("gdTCR_cells", "Not_Panel_A_cell_types")) %>% dplyr::select(-c("Time", "cell_type", "first_gate"))

new_synthetic_gdTCR <- facs_data_df_gdTCR_and_Not %>% 
  imbalance::rwo(numInstances = 110000, classAttr = "second_gate")

# [1] "17166 samples filtered by NEATER"
# 19224.299 sec elapsed
tic()
DN_neater <- neater(dataset = facs_data_df_DN_and_Not, newSamples = new_synthetic_DN, classAttr = "second_gate", iterations = 5)
toc()

DN_neater %>% vroom::vroom_write(path = paste0(source_path, "home/trufenc/DN_neater.tsv"), delim = "\t")

# [1] "22805 samples filtered by NEATER"
# 2576.583 sec elapsed
tic()
CD4_p_NKT_neater <- neater(dataset = facs_data_df_CD4_p_NKT_and_Not, newSamples = new_synthetic_CD4_p_NKT, classAttr = "second_gate", iterations = 5)
toc()

CD4_p_NKT_neater %>% vroom::vroom_write(path = paste0(source_path, "home/trufenc/CD4_p_NKT_neater.tsv"), delim = "\t")

# [1] "9514 samples filtered by NEATER"
# 5376.886 sec elapsed
tic()
NK_neater <- neater(dataset = facs_data_df_NK_and_Not, newSamples = new_synthetic_NK, classAttr = "second_gate", iterations = 5)
toc()

NK_neater %>% vroom::vroom_write(path = paste0(source_path, "home/trufenc/NK_neater.tsv"), delim = "\t")

# [1] "3728 samples filtered by NEATER"
# 7615.767 sec elapsed
tic()
gdTCR_neater <- neater(dataset = facs_data_df_gdTCR_and_Not, newSamples = new_synthetic_gdTCR, classAttr = "second_gate", iterations = 5)
toc()

gdTCR_neater %>% vroom::vroom_write(path = paste0(source_path, "home/trufenc/gdTCR_neater.tsv"), delim = "\t")
```

```{r}
DN_and_Not_comparison_plot <- plotComparison(dataset = facs_data_df_DN_and_Not, anotherDataset = DN_neater, classAttr = "second_gate", cols = 6, attrs = colnames(facs_data_df_DN_and_Not)[1:18])

CD4_p_NKT_and_Not_comparison_plot <- plotComparison(dataset = facs_data_df_CD4_p_NKT_and_Not, anotherDataset = CD4_p_NKT_neater, classAttr = "second_gate", cols = 6, attrs = colnames(facs_data_df_CD4_p_NKT_and_Not)[1:18])

NK_and_Not_comparison_plot <- plotComparison(dataset = facs_data_df_NK_and_Not, anotherDataset = NK_neater, classAttr = "second_gate", cols = 6, attrs = colnames(facs_data_df_NK_and_Not)[1:18])

gdTCR_and_Not_comparison_plot <- plotComparison(dataset = facs_data_df_gdTCR_and_Not, anotherDataset = gdTCR_neater, classAttr = "second_gate", cols = 6, attrs = colnames(facs_data_df_gdTCR_and_Not)[1:18])
```


# Undersample cell types
# create balanced cell types df with 100,000 events each
```{r}
# DN_neater <- vroom::vroom(file = paste0(source_path, "home/trufenc/DN_neater.tsv"), delim = "\t")

CD4_p_NKT_neater <- vroom::vroom(file = paste0(source_path, "home/trufenc/CD4_p_NKT_neater.tsv"), delim = "\t")

NK_neater <- vroom::vroom(file = paste0(source_path, "home/trufenc/NK_neater.tsv"), delim = "\t")

gdTCR_neater <- vroom::vroom(file = paste0(source_path, "home/trufenc/gdTCR_neater.tsv"), delim = "\t")

facs_data_df_list <- facs_data_df %>% split(f = .$second_gate)

set.seed(123)
facs_data_df_list$Not_Panel_A_cell_types <- facs_data_df_list$Not_Panel_A_cell_types %>% dplyr::slice(sample(100000 - 11688))
facs_data_df_list$Not_Panel_A_cell_types <- facs_data_df_list$Not_Panel_A_cell_types %>% bind_rows(facs_data_df_list$`DN `)
facs_data_df_list$`DN ` <- NULL

set.seed(123)
facs_data_df_list$`CD8+_cells` <- facs_data_df_list$`CD8+_cells` %>% dplyr::slice(sample(100000))

set.seed(123)
facs_data_df_list$`Th_CD4+_cells` <- facs_data_df_list$`Th_CD4+_cells` %>% dplyr::slice(sample(100000))

set.seed(123)
facs_data_df_list$`Tregs_CD4+_cells` <- facs_data_df_list$`Tregs_CD4+_cells` %>% dplyr::slice(sample(100000))

set.seed(123)
facs_data_df_list$`CD4-NKT_cells` <- facs_data_df_list$`CD4-NKT_cells` %>% dplyr::slice(sample(100000))

set.seed(123)
facs_data_df_list$`CD4+NKT_cells` <- CD4_p_NKT_neater %>% dplyr::slice(sample(100000-nrow(facs_data_df_list$`CD4+NKT_cells`))) %>% bind_rows(facs_data_df_list$`CD4+NKT_cells`)

set.seed(123)
facs_data_df_list$`gdTCR_cells` <- gdTCR_neater %>% dplyr::slice(sample(100000-nrow(facs_data_df_list$`gdTCR_cells`))) %>% bind_rows(facs_data_df_list$`gdTCR_cells`)

set.seed(123)
facs_data_df_list$`NK_cells` <- NK_neater %>% dplyr::slice(sample(100000-nrow(facs_data_df_list$`NK_cells`))) %>% bind_rows(facs_data_df_list$`NK_cells`)

# set.seed(123)
# facs_data_df_list$`DN ` <- DN_neater %>% dplyr::slice(sample(100000-nrow(facs_data_df_list$`DN `))) %>% bind_rows(facs_data_df_list$`DN `)

facs_data_df <- facs_data_df_list %>% bind_rows(.id = "second_gate")

facs_data_df <- facs_data_df %>% dplyr::select(-c(Time, cell_type, first_gate))

# facs_data_df %>% vroom::vroom_write(path = paste0(source_path, "home/trufenc/ba;anced_data_9_classes_second_gate.tsv"), delim = "\t")

facs_data_df %>% vroom::vroom_write(path = paste0(source_path, "home/trufenc/ba;anced_data_8_classes_second_gate_v2.tsv"), delim = "\t")
```

# Load balanced df with 9 classes
```{r}
# facs_data_df <- vroom::vroom(file = paste0(source_path, "home/trufenc/ba;anced_data_9_classes_second_gate.tsv"), delim = "\t")
facs_data_df <- vroom::vroom(file = paste0(source_path, "home/trufenc/ba;anced_data_8_classes_second_gate_v2.tsv"), delim = "\t")
```

```{r}
# facs_data_df <- facs_data_df %>% dplyr::filter(second_gate != "DN")
```


# selected features
```{r}
# facs_data_df <- facs_data_df %>% dplyr::select(c("FITC.A", "Qdot.605.A", "Pacific.Blue.A", "APC.A", "PE.Cy7.A", "PE.Texas.Red.A", "BV786.A", "PerCP.Cy5.5.A", "second_gate"))
```


```{r}
# randomize
set.seed(123)
facs_data_df <- facs_data_df[sample(nrow(facs_data_df)), ]

set.seed(123)
test_indices <- sample(nrow(facs_data_df)*.3)

test_df <- facs_data_df[test_indices, ]
train_df <- facs_data_df[-test_indices, ]

# normalize data
# normally_dstributed_test_list <- test_df %>% dplyr::select(-c(second_gate)) %>% purrr::map(bestNormalize::orderNorm)
# normally_dstributed_test_df <- purrr::map(seq_along(normally_dstributed_test_list), function(i) normally_dstributed_test_list[[i]]$x.t) %>% purrr::map(scale, center = TRUE, scale = TRUE) %>% purrr::map(scale_to_range_0_1) %>% bind_cols() %>% purrr::set_names(colnames(test_df)[1:18]) %>% mutate(second_gate = test_df$second_gate)
# test_df <- normally_dstributed_test_df
# 
# normally_dstributed_train_list <- train_df %>% dplyr::select(-c(second_gate)) %>% purrr::map(bestNormalize::orderNorm)
# normally_dstributed_train_df <- purrr::map(seq_along(normally_dstributed_train_list), function(i) normally_dstributed_train_list[[i]]$x.t) %>% purrr::map(scale, center = TRUE, scale = TRUE) %>% purrr::map(scale_to_range_0_1) %>% bind_cols() %>% purrr::set_names(colnames(train_df)[1:18]) %>% mutate(second_gate = train_df$second_gate)
# train_df <- normally_dstributed_train_df

# train_df %>% vroom::vroom_write(path = paste0(source_path, "home/trufenc/train_df.tsv"), delim = "\t")
# test_df %>% vroom::vroom_write(path = paste0(source_path, "home/trufenc/test_df.tsv"), delim = "\t")
```

```{r}
step_2_levels <- facs_data_df$second_gate %>% unique()
n_classes <- length(step_2_levels)
```

```{r}
classes_number <- data.frame(
  classes = step_2_levels,
  Number = 1:length(step_2_levels)
  )
```

```{r}
test_label <- test_df %>% 
  dplyr::select(second_gate) %>% 
  pull() %>% 
  str_replace(pattern = "CD4\\-NKT_cells", replacement = "1") %>% 
  str_replace(pattern = "CD4\\+NKT_cells", replacement = "2") %>% 
  str_replace(pattern = "CD8\\+_cells", replacement = "3") %>% 
  str_replace(pattern = "gdTCR_cells", replacement = "4") %>% 
  str_replace(pattern = "NK_cells", replacement = "5") %>% 
  str_replace(pattern = "Th_CD4\\+_cells", replacement = "6") %>% 
  str_replace(pattern = "Tregs_CD4\\+_cells", replacement = "7") %>% 
  str_replace(pattern = "Not_Panel_A_cell_types", replacement = "8") %>% 
  # str_replace(pattern = "DN", replacement = "9") %>% 
  as.numeric() %>%
  '-'(1) 

test_matrix <- xgb.DMatrix(
  data = test_df %>% 
    # dplyr::select(-c(Time, cell_type, first_gate, second_gate)) %>%
    dplyr::select(-c(second_gate)) %>% 
    as.matrix(), 
  label = test_label
  )
```

```{r}
train_label <- train_df %>% 
  dplyr::select(second_gate) %>% 
  pull() %>% 
  str_replace(pattern = "CD4\\-NKT_cells", replacement = "1") %>% 
  str_replace(pattern = "CD4\\+NKT_cells", replacement = "2") %>% 
  str_replace(pattern = "CD8\\+_cells", replacement = "3") %>% 
  str_replace(pattern = "gdTCR_cells", replacement = "4") %>% 
  str_replace(pattern = "NK_cells", replacement = "5") %>% 
  str_replace(pattern = "Th_CD4\\+_cells", replacement = "6") %>% 
  str_replace(pattern = "Tregs_CD4\\+_cells", replacement = "7") %>% 
  str_replace(pattern = "Not_Panel_A_cell_types", replacement = "8") %>% 
  # str_replace(pattern = "DN", replacement = "9") %>% 
  as.numeric() %>%
  '-'(1) 

train_matrix <- xgb.DMatrix(
  data = train_df %>% 
    # dplyr::select(-c(Time, cell_type, first_gate, second_gate)) %>% 
    dplyr::select(-c(second_gate)) %>% 
    as.matrix(), 
  label = train_label
  )
```

```{r}
k_fold <- 5

n_round <- 100

# xgboost fitting with arbitrary parameters

# parameter to tune: 
# nrounds controls the maximum number of iterations. For classification, it is similar to the number of trees to grow.
# eta controls the learning rate, i.e., the rate at which our model learns patterns in data. Typically, it lies between 0.01 - 0.3
# gamma controls regularization (or prevents overfitting)
# max_depth controls the depth of the tree. Larger data sets require deep trees to learn the rules from data.
# subsample controls the number of samples (observations) supplied to a tree. Typically, its values lie between (0.5-0.8)
# colsample_bytree control the number of features (variables) supplied to a tree. Typically, its values lie between (0.5,0.9)
# lambda controls L2 regularization (equivalent to Ridge regression) on weights. It is used to avoid overfitting.
# alpha controls L1 regularization (equivalent to Lasso regression) on weights. In addition to shrinkage, enabling alpha also results in feature selection. Hence, it's more useful on high dimensional data sets.

# Learning Task Parameters
## Objective
### multi:softmax - multiclassification using softmax objective. It returns predicted class labels.
### multi:softprob - multiclassification using softmax objective. It returns predicted class probabilities.

## eval_metric
### AUC - Area under curve (used in classification)
### Logloss - Negative loglikelihood (used in classification)
### mlogloss - multiclass logloss (used in classification)

# default parameters
# xgb_params <- list(
#   booster = "gbtree",
#   objective = "multi:softprob",
#   eta = 0.1,
#   gamma = 0,
#   max_depth = 6,
#   min_child_weight = 1,
#   subsample = 1,
#   colsample_bytree = 1,
#   num_class = n_classes,
#   nthread = 6
# )

xgb_params <- list(
  # booster = "gbtree",
  booster = "dart",
  objective = "multi:softprob",
  eta = 0.1,
  gamma = 6.22,
  max_depth = 10,
  min_child_weight = 9.11,
  subsample = 0.991,
  colsample_bytree = 0.955,
  num_class = n_classes,
  nthread = 6
)

# fit the model with the arbitrary parameters specified above
# 4201.047 sec elapsed
tic()
xgb_cv_model_1 <- xgb.cv(
  params = xgb_params,
  data = train_matrix,
  nrounds = n_round,
  nfold = k_fold,
  showsd = T,
  stratified = T,
  print_every_n = 1,
  early_stopping_rounds = 10,
  maximize = F,
  prediction = TRUE
)
toc()

# Best iteration: 224
xgb_cv_model_1$best_iteration

xgb_cv_model_1$evaluation_log %>% dplyr::filter(iter == xgb_cv_model_1$best_iteration) %>% dplyr::select(test_merror_mean) %>% pull

# xgb_cv_model_1 %>% saveRDS(file = paste0(source_path, "home/trufenc/xgb_cv_model_standard_parameters.rds"))

xgb_cv_model_1$evaluation_log %>% 
  ggplot(aes(x = iter)) +
  geom_line(aes(y = train_merror_mean, colour = "train")) + 
  geom_line(aes(y = test_merror_mean, colour = "test"))

# first default - model training
tic()
xgb_1 <- xgb.train(
  params = xgb_params, 
  data = train_matrix, 
  nrounds = xgb_cv_model_1$best_iteration, 
  watchlist = list(val = test_matrix, train = train_matrix), 
  print_every_n = 1, 
  early_stopping_rounds = 10, 
  maximize = F , 
  eval_metric = "merror"
  )
toc()

# model prediction
xgb_pred <- predict(xgb_1, test_matrix)

test_prediction_df <- matrix(
  data = xgb_pred,
  nrow = n_classes,
  ncol = length(xgb_pred) / n_classes
  ) %>%
  t() %>%
  data.frame()

test_prediction <- test_prediction_df %>%
  mutate(
    label = test_label %>% as.numeric() + 1,
    max_prob = max.col(., "last")
  )

# xgb_pred <- ifelse(xgb_pred > 0.5, 1, 0)

# confusion matrix
library(caret)
confusion_matrix <- confusionMatrix(factor(test_prediction$label), factor(test_prediction$max_prob))

#view variable importance plot
importance_matrix <- xgb.importance(feature_names = colnames(train_matrix), model = xgb_1)

gp = xgb.ggplot.importance(importance_matrix = importance_matrix)
print(gp)
```

# mlr - xgboost
```{r}
library(mlr)

# Convert characters to factors
train_df <- train_df %>% mutate(second_gate = second_gate %>% factor()) %>% as.data.frame()
test_df <- test_df %>% mutate(second_gate = second_gate %>% factor()) %>% as.data.frame()

# Do one hot encoding`<br/>
train_df <- createDummyFeatures(obj = train_df, target = "second_gate", method = "1-of-n")
test_df <- createDummyFeatures(obj = test_df, target = "second_gate", method = "1-of-n")

# Create tasks
train_task <- makeClassifTask(data = train_df, target = "second_gate")
test_task <- makeClassifTask(data = test_df, target = "second_gate")

# Create learner
lrn <- makeLearner("classif.xgboost", predict.type = "response")
lrn$par.vals <- list(objective = "multi:softprob", eval_metric = "merror", nrounds = 500L, eta = 0.1)

# Set parameter space
params <- makeParamSet(
  makeDiscreteParam("booster", values = c("gbtree", "dart")),
  makeIntegerParam("max_depth", lower = 3L, upper = 10L),
  makeNumericParam("min_child_weight", lower = 1L, upper = 10L),
  makeNumericParam("subsample", lower = 0.5, upper = 1),
  makeNumericParam("colsample_bytree", lower = 0.5, upper = 1),
  makeNumericParam("gamma", lower = 5L, upper = 10L)
)

# set resampling strategy
rdesc <- makeResampleDesc("CV", stratify = T, iters = 5L)

# Search strategy
ctrl <- makeTuneControlRandom(maxit = 10L)

# Set parallel backend
library(parallel)
library(parallelMap) 
parallelStartSocket(cpus = (detectCores()-1))

#parameter tuning
# 440945.636 sec elapsed
tic()
xgb_tuning <- tuneParams(learner = lrn, task = train_task, resampling = rdesc, measures = acc, par.set = params, control = ctrl, show.info = T)
toc()

# xgb_tuning %>% saveRDS("~/Documents/xgb_tuning_step_2_balanced_data.rds")
# xgb_tuning <- readRDS("~/Documents/xgb_tuning_step_2_balanced_data.rds")

xgb_tuning$y

#set hyperparameters
lrn_tune <- setHyperPars(lrn,par.vals = xgb_tuning$x)

#train model
xg_model <- train(learner = lrn_tune, task = train_task)

#predict model
xg_pred <- predict(xg_model, test_task)

confusion_matrix <- confusionMatrix(xg_pred$data$response, xg_pred$data$truth)

conf_df <- confusion_matrix$byClass %>% as.data.frame()

conf_df$F1
```



# Random forest
```{r}
rf_train <- train_df %>% mutate(second_gate = train_label %>% factor())
# rf_train <- train_df %>% dplyr::select(c("FITC.A", "Qdot.605.A", "Pacific.Blue.A", "APC.A", "PE.Cy7.A", "PE.Texas.Red.A", "BV786.A", "PerCP.Cy5.5.A", "second_gate")) %>% mutate(second_gate = train_label %>% factor())

rf_test <- test_df %>% mutate(second_gate = test_label %>% factor())
# rf_test <- test_df %>% dplyr::select(c("FITC.A", "Qdot.605.A", "Pacific.Blue.A", "APC.A", "PE.Cy7.A", "PE.Texas.Red.A", "BV786.A", "PerCP.Cy5.5.A", "second_gate")) %>% mutate(second_gate = test_label %>% factor())

set.seed(123)
tic()
rf_model <- ranger(formula = second_gate ~ ., data = rf_train, num.threads = 50, num.trees = 2000, mtry = 18, splitrule = "extratrees", min.node.size = 11, max.depth = 0)
# rf_model <- ranger(formula = second_gate ~ ., data = rf_train, num.threads = 50, num.trees = 500, mtry = 4, splitrule = "extratrees", min.node.size = 1, max.depth = 0)
toc()

confusionMatrix(rf_train$second_gate, rf_model$predictions)

rf_pred <- predict(rf_model, rf_test %>% dplyr::select(-second_gate))

confusionMatrix(rf_test$second_gate, rf_pred$predictions)
```

```{r}
library(ranger)
  set.seed(123)
  # rf_model <- ranger(data = rf_train, formula = second_gate ~ ., num.threads = 50, num.trees = 500, mtry = 4, splitrule = "extratrees")

  from_to <- seq(from = 26, to = 30, by = 1)
  
  tic()
  rf_model_list <- purrr::map(from_to, function(i) ranger(data = rf_train, formula = second_gate ~ ., num.threads = 50, num.trees = 500, mtry = 18, splitrule = "extratrees", min.node.size = 11, max.depth = i))
  toc()
  
  cm_train_list <- purrr::map(seq_along(rf_model_list), function(i) confusionMatrix(rf_train$second_gate, rf_model_list[[i]]$predictions))

  cm_train_df <- cm_train_list %>% purrr::map(function(x) x %>% .$overall %>% t() %>% as.data.frame()) %>% bind_rows()
  
  rf_pred_list <- purrr::map(seq_along(rf_model_list), function(i) predict(rf_model_list[[i]], rf_test %>% dplyr::select(-second_gate)))

  cm_test_list <- purrr::map(seq_along(rf_model_list), function(i) confusionMatrix(rf_test$second_gate, rf_pred_list[[i]]$predictions))
  
  cm_test_df <- cm_test_list %>% purrr::map(function(x) x %>% .$overall %>% t() %>% as.data.frame()) %>% bind_rows()
  
  acc_data <- data.frame(train_acc = cm_train_df$Accuracy,
             eval_acc = cm_test_df$Accuracy,
             max.depth = from_to)
  
  acc_data %>% tidyr::gather(key = "key", value = "value", -max.depth) %>% ggplot(aes(x = max.depth, y = value, colour = key)) + geom_line()
  
  kappa_data <- data.frame(train_kappa = cm_train_df$Kappa,
             eval_kappa = cm_test_df$Kappa,
             max.depth = from_to)
  
  kappa_data %>% tidyr::gather(key = "key", value = "value", -max.depth) %>% ggplot(aes(x = max.depth, y = value, colour = key)) + geom_line()
```
```{r}
set.seed(123)
tic()
rf_model_step_2 <- ranger(formula = second_gate ~ ., data = facs_data_df, num.threads = 50, num.trees = 2000, mtry = 18, splitrule = "extratrees", min.node.size = 11, max.depth = 0)
toc()

rf_model_step_2 %>% saveRDS("~/PRIMUS/home/trufenc/rf_model_step_2.rds")
```





```{r}
set.seed(123)
tic()
rf_model_list <- purrr::map(seq(from = 500, to = 2000, by = 500), function(i) ranger(formula = second_gate ~ ., data = rf_train, num.threads = 5, num.trees = i, mtry = 4, splitrule = "extratrees"))
toc()

cm_list <- purrr::map(seq_along(rf_model_list[[i]]), function(i) confusionMatrix(rf_train$second_gate, rf_model_list[[i]]$predictions))

rf_pred <- purrr::map(seq_along(rf_model_list[[i]]), function(i) predict(rf_model_list[[i]], rf_test %>% dplyr::select(-second_gate)))

purrr::map(seq_along(rf_model_list[[i]]), confusionMatrix(rf_test$second_gate, rf_model_list[[i]]$predictions))
```


# mlr - random forest
# Grid search for tuned hyperparameters
https://stackoverflow.com/questions/37514603/hyper-parameter-tuning-using-pure-ranger-package-in-r
```{r}
library(mlr)
# library(tuneRanger)

# Convert characters to factors
train_df <- train_df %>% mutate(second_gate = train_label %>% factor()) %>% as.data.frame()
test_df <- test_df %>% mutate(second_gate = test_label %>% factor()) %>% as.data.frame()

# Do one hot encoding`<br/>
train_df <- createDummyFeatures(obj = train_df, target = "second_gate", method = "1-of-n")
test_df <- createDummyFeatures(obj = test_df, target = "second_gate", method = "1-of-n")

# Create tasks
train_task <- makeClassifTask(data = train_df, target = "second_gate")
test_task <- makeClassifTask(data = test_df, target = "second_gate")

# # Rough Estimation of the Tuning time
# estimateTimeTuneRanger(train_task)
# 
# # Tuning process (takes around 1 minute); Tuning measure is the multiclass brier score
# res = tuneRanger(train_task, measure = list(multiclass.brier))
# res

# Create learner
lrn <- makeLearner("classif.ranger", predict.type = "response", num.threads = 40)
lrn$par.vals <- list(regularization.factor = 0.01)
# lrn$par.vals <- list(regularization.factor = 0.01)

# Set parameter space
params <- makeParamSet(
  makeDiscreteParam("splitrule", values = c("gini", "extratrees", "hellinger")),
  makeIntegerParam("num.trees", lower = 500L, upper = 2000L),
  makeIntegerParam("mtry", lower = 1L, upper = 100L)
  # makeIntegerParam("max_depth", lower = 3L, upper = 10L),
  # makeNumericParam("subsample", lower = 0.5, upper = 1),
  # makeNumericParam("colsample_bytree", lower = 0.5, upper = 1)
)

# set resampling strategy
rdesc <- makeResampleDesc("CV", stratify = T, iters = 5L)

# Search strategy
ctrl <- makeTuneControlRandom(maxit = 10)
# ctrl <- makeTuneControlGrid()

# Set parallel backend
library(parallel)
library(parallelMap)
# parallelStartSocket(cpus = (detectCores()-1))
# parallelStartSocket(cpus = 40)
parallelStartMulticore(cpus = 40) 

#parameter tuning
# 440945.636 sec elapsed
tic()
rf_tuning <- tuneParams(learner = lrn, task = train_task, resampling = rdesc, measures = acc, par.set = params, control = ctrl, show.info = T)
toc()

# xgb_tuning %>% saveRDS("~/Documents/xgb_tuning_step_2_balanced_data.rds")
# xgb_tuning <- readRDS("~/Documents/xgb_tuning_step_2_balanced_data.rds")

rf_tuning$y

#set hyperparameters
lrn_tune <- setHyperPars(lrn,par.vals = rf_tuning$x)

#train model
rf_model <- train(learner = lrn_tune, task = train_task)

#predict model
rf_pred <- predict(xg_model, test_task)

confusion_matrix <- confusionMatrix(rf_pred$data$response, rf_pred$data$truth)

conf_df <- confusion_matrix$byClass %>% as.data.frame()

conf_df$F1
```








```{r}
cell_types_control <- c(files_to_load_names_1, files_to_load_names_2, files_to_load_names_4, files_to_load_names_5) %>% 
  str_remove(pattern = ".fcs") %>% 
  str_remove(pattern = "export_Specimen_..._c....._..._..._")

cell_types_ko <- c(ko_files_to_load_names_1, ko_files_to_load_names_2) %>% 
  str_remove(pattern = ".fcs") %>% 
  str_remove(pattern = "export_Specimen_..._tg....._..._..._")

cell_types <- c(cell_types_control, cell_types_ko)
cell_types[cell_types %>% str_which(pattern = "CD8\\+_VM Tcells\\-")] <- NA
cell_types <- cell_types[!is.na(cell_types)]

ds_list <- list(
  df_cA1556 = files_to_load_1,
  df_c90692 = files_to_load_2,
  df_c90695 = files_to_load_3,
  df_c89141 = files_to_load_4,
  df_c90043 = files_to_load_5,
  df_tgE8038 = ko_files_to_load_1,
  df_tgE8040 = ko_files_to_load_2
  )

ds_list <- ds_list %>% purrr::map(load_fcs_files, n_cells = 1e20, filter = TRUE, toFilter = c(1:6), scale = FALSE, transform = TRUE, toTransform = c(1:18))

# ds_list_df <- ds_list %>% purrr::map(function(x) x %>% .[["fs"]] %>% .[["data"]] %>% as.data.frame())

ds_list_df <- ds_list %>% purrr::map(build_fcs_data_df, cell_types = cell_types)

ds_list_df <- ds_list_df %>% purrr::map(add_first_gate_column)

ds_list_df <- ds_list_df %>% purrr::map(add_second_gate_column)

purrr::map(seq_along(ds_list_df), function(i) ds_list_df[[i]] %>% vroom::vroom_write(path = paste0(source_path, "home/trufenc/", names(ds_list_df)[i], ".tsv"), delim = "\t"))

```

```{r}
freq_df <- facs_data_df$second_gate %>% table() %>% as.data.frame() %>% arrange(desc(Freq))
```


# Step 2
Not Panel A cell types
gamma delta T cells
NK cells
CD4+ NKT cells
CD4- NKT cells
Tregs CD4+ T cells
Thelp CD4+ T cells
CD8+ T cells

9 classes to predict at step 2
```{r}
not_live_indices <- facs_data_df$first_gate %>% str_which(pattern = "not_live")

# facs_data_df_step_2 <- facs_data_df %>% dplyr::filter(first_gate == "live")
facs_data_df_step_2 <- facs_data_df %>% dplyr::slice(-not_live_indices)

# facs_data_df_step_2 <- facs_data_df_step_2 %>% dplyr::select(-c(Time, cell_type, first_gate))

facs_data_df_step_2 <- facs_data_df_step_2 %>% mutate(second_gate = second_gate %>% factor)

# facs_data_df_step_2 %>% vroom::vroom_write(path = paste(source_path, "home/trufenc/facs_data_df_step_2.tsv"), delim = "\t")

diff_som_2_df_filtered <- diff_som_2$fs$data %>% as.data.frame() %>% dplyr::slice(-not_live_indices)

# diff_som_2_df_filtered %>% vroom::vroom_write(path = paste(source_path, "home/trufenc/facs_data_df_not_filtered_step_2.tsv"), delim = "\t")
```

```{r}
test_facs_data_df <- test_diff_som_normalized %>% build_fcs_data_df(cell_types = cell_types)

test_facs_data_df <- test_facs_data_df %>% 
  mutate(first_gate = case_when(!(cell_type %in% c("clog+", "cells-", "S1-", "S2-", "dead")) ~ "live"))
  
test_facs_data_df <- test_facs_data_df %>% 
  mutate(first_gate = if_else(is.na(first_gate), true = "not_live", false = first_gate))

test_facs_data_df <- test_facs_data_df %>% 
  mutate(second_gate = if_else(first_gate %>% str_detect(pattern = "not_live"), true = "not_live", false =  as.character(cell_type)))

test_facs_data_df <- test_facs_data_df %>% 
  mutate(second_gate = if_else(second_gate %in% c("gdTCR_neg_Klrg1-", "gdTCR_neg_Klrg1+", "NK_neg_Klrg1-", "NK_neg_Klrg1+", "CD4-NKT_neg_Klrg1-", "CD4-NKT_neg_Klrg1+", "CD4+NKT_neg_Klrg1-", "CD4+NKT_neg_Klrg1+", "Tregs_neg_Klrg1-", "Tregs_neg_Klrg1+", "Th_neg_Klrg1-", "Th_neg_Klrg1+", "CD8_neg_Klrg1-_VM Tcells-", "CD8_neg_Klrg1-_VM Tcells+", "CD8_neg_Klrg1+_VM Tcells-",  "CD8_neg_Klrg1+_VM Tcells+"), true = "Not_Panel_A_cell_types", false =  second_gate))

test_facs_data_df <- test_facs_data_df %>% 
  mutate(second_gate = if_else(second_gate %>% str_detect(pattern = "gdTCR"), true = "gdTCR_cells", false =  second_gate)) %>% 
  mutate(second_gate = if_else(second_gate %>% str_detect(pattern = "NK_"), true = "NK_cells", false =  second_gate)) %>% 
  mutate(second_gate = if_else(second_gate %>% str_detect(pattern = "CD4\\-NKT_"), true = "CD4-NKT_cells", false =  second_gate)) %>% 
  mutate(second_gate = if_else(second_gate %>% str_detect(pattern = "CD4\\+NKT_"), true = "CD4+NKT_cells", false =  second_gate)) %>% 
  mutate(second_gate = if_else(second_gate %>% str_detect(pattern = "Tregs_"), true = "Tregs_CD4+_cells", false =  second_gate)) %>% 
  mutate(second_gate = if_else(second_gate %>% str_detect(pattern = "Th_"), true = "Th_CD4+_cells", false =  second_gate)) %>% 
  mutate(second_gate = if_else(second_gate %>% str_detect(pattern = "CD8"), true = "CD8+_cells", false =  second_gate))
```

```{r}
freq_df <- test_facs_data_df$second_gate %>% table() %>% as.data.frame() %>% arrange(desc(Freq))
```
```{r}
test_not_live_indices <- test_facs_data_df$first_gate %>% str_which(pattern = "not_live")

# test_facs_data_df_step_2 <- test_facs_data_df %>% dplyr::filter(first_gate == "live")
test_facs_data_df_step_2 <- test_facs_data_df %>% dplyr::slice(-test_not_live_indices)

# test_facs_data_df_step_2 <- test_facs_data_df_step_2 %>% dplyr::select(-c(Time, cell_type, first_gate))

test_facs_data_df_step_2 <- test_facs_data_df_step_2 %>% mutate(second_gate = second_gate %>% factor)

# test_facs_data_df_step_2 %>% vroom::vroom_write(path = paste0(source_path, "home/trufenc/test_facs_data_df_step_2.tsv"), delim = "\t")

test_diff_som_2_df_filtered <- test_diff_som$fs$data %>% as.data.frame() %>% dplyr::slice(-test_not_live_indices)

# test_diff_som_2_df_filtered %>% vroom::vroom_write(path = paste0(source_path, "home/trufenc/test_facs_data_df_not_filtered_step_2.tsv"), delim = "\t")
```



Load table
```{r}
# facs_data_df_step_2 %>% vroom::vroom_write(path = paste0(source_path, "home/trufenc/imbalanced_facs_data_df_step_2.tsv"), delim = "\t")

tic()
facs_data_df_step_2 <- vroom::vroom(file = paste0(source_path, "/home/trufenc/imbalanced_facs_data_df_step_2.tsv"), delim = "\t")
toc()

facs_data_df_step_2 <- facs_data_df_step_2 %>%  dplyr::select(-c(Time, cell_type, first_gate))

step_2_levels <- facs_data_df_step_2$second_gate %>% unique()

test_facs_data_df_step_2 <- vroom::vroom(file = paste0(source_path, "home/trufenc/test_facs_data_df_step_2.tsv"), delim = "\t")

test_df <- test_facs_data_df_step_2 %>% dplyr::select(-c(second_gate))
```



Obs: Huge class imbalance
```{r}
freq_df <- facs_data_df_step_2$second_gate %>% table() %>% as.data.frame() %>% arrange(desc(Freq))
mean_classes <- freq_df$Freq %>% mean() %>% ceiling()
```

# Oversampling strategies
```{r}
library(ROSE)
library(imbalance)
# ovun.sample(second_gate ~ ., data = facs_data_df_step_2, method = "both", N = mean_classes)$data
```

imabalance::pdfos
Probability Distribution density Function estimation based Oversampling
```{r}
# 519.878 sec elapsed
tic()
DN_new_pdfos <- facs_data_df_step_2 %>% imbalance::pdfos(numInstances = mean_classes, classAttr = "second_gate")
toc()

# DN_new_pdfos %>% write.table("~/Documents/DN_new_pdfos.tsv", sep = "\t", row.names = FALSE, col.names = TRUE, quote = FALSE)

# 37580.5 sec elapsed
tic()
neater_results <- neater(dataset = facs_data_df_step_2, newSamples = DN_new_pdfos, classAttr = "second_gate", iterations = 10)
toc()

# neater_results %>% write.table("~/Documents/neater_results_DN_new_pdfos.tsv", sep = "\t", row.names = FALSE, col.names = TRUE, quote = FALSE)
```

Results for DN 29134 out of 197000 (~ 15%) could be used, taking over 10 hour for neater to finish.


imabalance::rwo
Random Walk Oversampling
```{r}
# 0.667 sec elapsed
tic()
DN_new_rwo <- facs_data_df_step_2 %>% imbalance::rwo(numInstances = 100000, classAttr = "second_gate")
toc()

# DN_new_pdfos %>% write.table("~/Documents/DN_new_pdfos.tsv", sep = "\t", row.names = FALSE, col.names = TRUE, quote = FALSE)

# 28951.977 sec elapsed
tic()
DN_rwo_neater_results <- neater(dataset = facs_data_df_step_2, newSamples = DN_new_rwo, classAttr = "second_gate", iterations = 10)
toc()

# DN_rwo_neater_results %>% write.table("~/Documents/neater_results_DN_new_rwo.tsv", sep = "\t", row.names = FALSE, col.names = TRUE, quote = FALSE)
```
Results for DN 76355 out of 197000 (~ 39%) could be used, taking over 8 hour for neater to finish.

imabalance::mwmote
Majority Weighted Minority Oversampling Technique
```{r}
# 
tic()
DN_new_mwmote <- facs_data_df_step_2 %>% imbalance::mwmote(numInstances = mean_classes, classAttr = "second_gate")
toc()

# DN_new_mwmote %>% write.table("~/Documents/DN_new_mwmote.tsv", sep = "\t", row.names = FALSE, col.names = TRUE, quote = FALSE)

# 
tic()
DN_mwmote_neater_results <- neater(dataset = facs_data_df_step_2, newSamples = DN_new_mwmote, classAttr = "second_gate", iterations = 10)
toc()

# DN_mwmote_neater_results %>% write.table("~/Documents/neater_results_DN_new_mwmote.tsv", sep = "\t", row.names = FALSE, col.names = TRUE, quote = FALSE)
```

Results for DN 78626 out of 197000 (~ 40%) could be used, taking over 8 hour for neater to finish.

imabalance::racog
Majority Weighted Minority Oversampling Technique
```{r}
# # 5469.323 sec elapsed
# tic()
# DN_new_racog <- facs_data_df_step_2 %>% imbalance::racog(numInstances = mean_classes, classAttr = "second_gate")
# toc()
# 
# # DN_new_racog %>% write.table("~/Documents/DN_new_racog.tsv", sep = "\t", row.names = FALSE, col.names = TRUE, quote = FALSE)
# 
# # 28814.031 sec elapsed
# tic()
# DN_racog_neater_results <- neater(dataset = facs_data_df_step_2, newSamples = DN_new_racog, classAttr = "second_gate", iterations = 10)
# toc()
# 
# # DN_racog_neater_results %>% write.table("~/Documents/neater_results_DN_new_racog.tsv", sep = "\t", row.names = FALSE, col.names = TRUE, quote = FALSE)
```

ROSE::ROSE

```{r}
DN_original <- facs_data_df_step_2 %>% dplyr::filter(second_gate %in% c("Th_CD4+_cells", "DN "))

# 1.219 sec elapsed
tic()
DN_new_rose <- DN_original %>% ROSE::ROSE(formula = second_gate ~ ., N = 2*mean_classes)
toc()

DN_new_rose <- DN_new_rose$data %>% dplyr::filter(second_gate == "DN ")

# DN_new_rose %>% write.table("~/Documents/DN_new_rose.tsv", sep = "\t", row.names = FALSE, col.names = TRUE, quote = FALSE)

# 28814.031 sec elapsed
tic()
DN_rose_neater_results <- neater(dataset = facs_data_df_step_2, newSamples = DN_new_rose, classAttr = "second_gate", iterations = 10)
toc()

# DN_rose_neater_results %>% write.table("~/Documents/neater_results_DN_new_rose.tsv", sep = "\t", row.names = FALSE, col.names = TRUE, quote = FALSE)
```


RWO foi o escolhido

imabalance::rwo
Random Walk Oversampling
```{r}
# 0.743 sec elapsed
tic()
DN_new_rwo <- facs_data_df_step_2 %>% imbalance::rwo(numInstances = 300000, classAttr = "second_gate")
toc()

# DN_new_pdfos %>% write.table("~/Documents/DN_new_pdfos.tsv", sep = "\t", row.names = FALSE, col.names = TRUE, quote = FALSE)

# 48388.984
tic()
DN_rwo_neater_results <- neater(dataset = facs_data_df_step_2, newSamples = DN_new_rwo, classAttr = "second_gate", iterations = 10)
toc()

DN_rwo_neater_results %>% write.table("~/Documents/neater_results_DN_new_rwo_for_step_2.tsv", sep = "\t", row.names = FALSE, col.names = TRUE, quote = FALSE)
```


# Combine datasets
```{r}
facs_data_df_step_2 <- facs_data_df_step_2 %>% mutate(second_gate = second_gate %>% as.character)

facs_data_df_step_2_list <- facs_data_df_step_2 %>% split(f = .$second_gate)

set.seed(123)
facs_data_df_step_2_list$`DN ` <- DN_rwo_neater_results %>% dplyr::slice(sample(100000-nrow(facs_data_df_step_2_list$`DN `))) %>% bind_rows(facs_data_df_step_2_list$`DN `)

set.seed(123)
rows_list <- facs_data_df_step_2_list %>% purrr::map(function(x) sample(nrow(x)))
facs_data_df_step_2_list <- purrr::map(seq_along(rows_list), function(i) facs_data_df_step_2_list[[i]][rows_list[[i]], ]) %>% purrr::set_names(names(facs_data_df_step_2_list))

balanced_facs_data_df_step_2_list <- facs_data_df_step_2_list %>% purrr::map(dplyr::slice, sample(100000), 
.preserve = TRUE)

balanced_facs_data_df_step_2 <- balanced_facs_data_df_step_2_list %>% bind_rows(.id = "second_gate")

balanced_facs_data_df_step_2 %>% write.table(paste0(source_path, "home/trufenc/balanced_facs_data_df_step_2.tsv"), sep = "\t", row.names = FALSE, col.names = TRUE, quote = FALSE)
```

# Load diff_som and test_diff_som
```{r}
diff_som_2 <- readRDS(file = paste0(source_path, "home/trufenc/diff_som_1_2020_07_10.rds"))
test_diff_som <- readRDS(file = paste0(source_path, "home/trufenc/test_diff_som_2020_07_10.rds"))
test_facs_data_df_step_2 <- vroom::vroom(file = paste0(source_path, "home/trufenc/test_facs_data_df_step_2.tsv"), delim = "\t")
test_df <- test_facs_data_df_step_2 %>% dplyr::select(-c(second_gate))
```

Load balanced data for step 2
```{r}
# 4.314 sec elapsed
# tic()
# balanced_facs_data_df_step_2 <- read_delim(file = "~/Documents/balanced_facs_data_df_step_2.tsv", delim = "\t")
# toc()

library(vroom)
# 0.23 sec elapsed
tic()
balanced_facs_data_df_step_2 <- vroom::vroom(file = paste0(source_path, "home/trufenc/balanced_facs_data_df_step_2.tsv"), delim = "\t")
toc()
facs_data_df_step_2 <- balanced_facs_data_df_step_2
step_2_levels <- facs_data_df_step_2$second_gate %>% unique()
```

```{r}
# diff_som_2$fs$data <- balanced_facs_data_df_step_2 %>% as.matrix()
diff_som_2$fs$data <- facs_data_df_step_2 %>% as.matrix()

k_fold <- 5

# Create 5 equally size folds
reseed()
folds <- cut(x = seq(1, nrow(diff_som_2$fs$data)), breaks = k_fold, labels = FALSE)
# Perform 10 fold cross validation
# Segement your data by fold using the which() function
test_indices <- purrr::map(seq_len(k_fold), function(i) which(folds == i, arr.ind = TRUE))

# Use the test and train data partitions however you desire...
test_data <- purrr::map(seq_len(k_fold), function(i) diff_som_2$fs$data[test_indices[[i]], ])
train_data <- purrr::map(seq_len(k_fold), function(i) diff_som_2$fs$data[-test_indices[[i]], ])

diff_som_2_test <- list(test_1 = diff_som_2,
                        test_2 = diff_som_2,
                        test_3 = diff_som_2,
                        test_4 = diff_som_2,
                        test_5 = diff_som_2)

diff_som_2_test[[1]]$fs$data <- diff_som_2_test[[1]]$fs$data %>% as.data.frame() %>% dplyr::slice(test_indices[[1]]) %>% dplyr::select(-c("second_gate")) %>% as.matrix() %>% apply(MARGIN = c(2), as.numeric)
diff_som_2_test[[2]]$fs$data <- diff_som_2_test[[2]]$fs$data %>% as.data.frame() %>% dplyr::slice(test_indices[[2]]) %>% dplyr::select(-c("second_gate")) %>% as.matrix() %>% apply(MARGIN = c(2), as.numeric)
diff_som_2_test[[3]]$fs$data <- diff_som_2_test[[3]]$fs$data %>% as.data.frame() %>% dplyr::slice(test_indices[[3]]) %>% dplyr::select(-c("second_gate")) %>% as.matrix() %>% apply(MARGIN = c(2), as.numeric)
diff_som_2_test[[4]]$fs$data <- diff_som_2_test[[4]]$fs$data %>% as.data.frame() %>% dplyr::slice(test_indices[[4]]) %>% dplyr::select(-c("second_gate")) %>% as.matrix() %>% apply(MARGIN = c(2), as.numeric)
diff_som_2_test[[5]]$fs$data <- diff_som_2_test[[5]]$fs$data %>% as.data.frame() %>% dplyr::slice(test_indices[[5]]) %>% dplyr::select(-c("second_gate")) %>% as.matrix() %>% apply(MARGIN = c(2), as.numeric)

# purrr::map(seq_len(k_fold), function(i) diff_som_2_test[[i]]$fs$data = diff_som_2_test[[i]]$fs$data %>% as.data.frame() %>% dplyr::slice(test_indices[[i]]) %>% as.matrix() )


diff_som_2_train <- list(train_1 = diff_som_2,
                        train_2 = diff_som_2,
                        train_3 = diff_som_2,
                        train_4 = diff_som_2,
                        train_5 = diff_som_2)

diff_som_2_train[[1]]$fs$data <- diff_som_2_train[[1]]$fs$data %>% as.data.frame() %>% dplyr::slice(-test_indices[[1]]) %>% dplyr::select(-c("second_gate")) %>% as.matrix() %>% apply(MARGIN = c(2), as.numeric)
diff_som_2_train[[2]]$fs$data <- diff_som_2_train[[2]]$fs$data %>% as.data.frame() %>% dplyr::slice(-test_indices[[2]]) %>% dplyr::select(-c("second_gate")) %>% as.matrix() %>% apply(MARGIN = c(2), as.numeric)
diff_som_2_train[[3]]$fs$data <- diff_som_2_train[[3]]$fs$data %>% as.data.frame() %>% dplyr::slice(-test_indices[[3]]) %>% dplyr::select(-c("second_gate")) %>% as.matrix() %>% apply(MARGIN = c(2), as.numeric)
diff_som_2_train[[4]]$fs$data <- diff_som_2_train[[4]]$fs$data %>% as.data.frame() %>% dplyr::slice(-test_indices[[4]]) %>% dplyr::select(-c("second_gate")) %>% as.matrix() %>% apply(MARGIN = c(2), as.numeric)
diff_som_2_train[[5]]$fs$data <- diff_som_2_train[[5]]$fs$data %>% as.data.frame() %>% dplyr::slice(-test_indices[[5]]) %>% dplyr::select(-c("second_gate")) %>% as.matrix() %>% apply(MARGIN = c(2), as.numeric)

# purrr::map(seq_len(k_fold), function(i) diff_som_2_train[[i]]$fs$data = diff_som_2_train[[i]]$fs$data[-test_indices[[i]], ])

# train_data_list <- purrr::map(seq_len(k_fold), function(i) list(measurements = train_data[[i]] %>% dplyr::select(-cell_type) %>% as.matrix(), classes_col = train_data[[i]] %>% dplyr::select(cell_type) %>% unlist()))

# test_data_list <- purrr::map(seq_len(k_fold), function(i) list(measurements = test_data[[i]] %>% dplyr::select(-cell_type) %>% as.matrix(), classes_col = test_data[[i]] %>% dplyr::select(cell_type) %>% unlist()))
```

```{r}
perform_SOM <- function(diff_som, facs_data_df, columns_to_use = c("FITC.A", "Qdot.605.A", "Pacific.Blue.A", "APC.A", "PE.Cy7.A", "PE.Texas.Red.A", "BV786.A", "PerCP.Cy5.5.A"), importance = rep(1, 8), normalize_weights = TRUE, class_column, ...) {
  
  scale_to_range_0_1 <- function(x, ...){(x - min(x, ...)) / (max(x, ...) - min(x, ...))}
  
  diff_som = diff_som
  
  # calculate optimal grid
  vesanto_dim <- diff_som$fs$data %>%
    nrow() %>%
    sqrt() %>%
    "*"(5)
  
  grid_dim <- vesanto_dim %>%
    sqrt() %>%
    ceiling() %>%
    "+"(20)

  # SOM
  reseed()
  ds <- diff_som %>% Embed(xdim = grid_dim, ydim = grid_dim, colsToUse = columns_to_use, importance = importance, nclust = grid_dim * grid_dim, rlen = 5)

  # Optional to normalize weights
  if (normalize_weights) {
    ds$map$codes <- purrr::map(seq_len(ncol(ds$map$codes)), function(i) {ds$map$codes[, i] %>% bestNormalize::orderNorm() %>% .[["x.t"]] %>% scale_to_range_0_1()}) %>% purrr::set_names(colnames(ds$map$codes)) %>% bind_cols()
  }

  grid_clustering_df <- ds$map$grid %>%
    as.data.frame() %>%
    rownames_to_column() %>%
    mutate(cluster = ds$clust) %>%
    mutate(rowname = rowname %>% as.numeric()) %>%
    bind_cols(as.data.frame(ds$map$codes))

  EmbedSOM_results_df <- ds$fs$data %>%
    as.data.frame() %>%
    mutate(mapping = ds$map$mapping[, 1]) %>%
    left_join(grid_clustering_df, by = c("mapping" = "rowname")) %>%
    mutate(!!class_column := facs_data_df[[class_column]])
  
    EmbedSOM_results_df <- EmbedSOM_results_df %>% 
    dplyr::select(c(dplyr::contains(".y"), class_column)) %>% 
    purrr::set_names(str_remove(string = colnames(.), pattern = ".y$"))
  
  output <- list(weights_df = EmbedSOM_results_df,
                 diff_som = ds)
  
  return(output)
}
```



```{r}
# # diff_som <- diff_som_1_train[[1]]
# perform_SOM_step_2 <- function(diff_som, facs_data_df, columns_to_use = c("FITC.A", "Qdot.605.A", "Pacific.Blue.A", "APC.A", "PE.Cy7.A", "PE.Texas.Red.A", "BV786.A", "PerCP.Cy5.5.A"), importance = rep(1, 8), normalize_weights = TRUE) {
#   
#   scale_to_range_0_1 <- function(x, ...){(x - min(x, ...)) / (max(x, ...) - min(x, ...))}
#   
#   diff_som = diff_som
#   
#   # calculate optimal grid
#   vesanto_dim <- diff_som$fs$data %>%
#     nrow() %>%
#     sqrt() %>%
#     "*"(5)
#   
#   grid_dim <- vesanto_dim %>%
#     sqrt() %>%
#     ceiling() %>%
#     "+"(20)
# 
#   # SOM
#   reseed()
#   ds_step_2 <- diff_som %>% Embed(xdim = grid_dim, ydim = grid_dim, colsToUse = columns_to_use, importance = importance, nclust = grid_dim * grid_dim, rlen = 5)
# 
#   # Optional to normalize weights
#   if (normalize_weights) {
#     ds_step_2$map$codes <- purrr::map(seq_len(ncol(ds_step_2$map$codes)), function(i) {ds_step_2$map$codes[, i] %>% bestNormalize::orderNorm() %>% .[["x.t"]] %>% scale_to_range_0_1()}) %>% purrr::set_names(colnames(ds_step_2$map$codes)) %>% bind_cols()
#   }
# 
#   grid_clustering_df <- ds_step_2$map$grid %>%
#     as.data.frame() %>%
#     rownames_to_column() %>%
#     mutate(cluster = ds_step_2$clust) %>%
#     mutate(rowname = rowname %>% as.numeric()) %>%
#     bind_cols(as.data.frame(ds_step_2$map$codes))
# 
#   EmbedSOM_results_df <- ds_step_2$fs$data %>%
#     as.data.frame() %>%
#     mutate(mapping = ds_step_2$map$mapping[, 1]) %>%
#     left_join(grid_clustering_df, by = c("mapping" = "rowname")) %>%
#     mutate(second_gate = facs_data_df$second_gate)
# 
#   output <- list(EmbedSOM_results_df = EmbedSOM_results_df,
#                  diff_som = ds_step_2)
#   
#   return(output)
# }
```


# SOM - Selected features
```{r}
# registerDoParallel(cores = 5)
# 
# # 2347.756 sec elapsed - imbalanced data
# # 1029.137 sec elapsed - balanced data
# tic()
# # EmbedSOM_results_train <- purrr::map(seq_along(diff_som_2_train), function(i) perform_SOM_step_2(diff_som = diff_som_2_train[[i]], facs_data_df_step_2[-test_indices[[i]], ], columns_to_use = c("FITC.A", "Qdot.605.A", "Pacific.Blue.A", "APC.A", "PE.Cy7.A", "PE.Texas.Red.A", "BV786.A", "PerCP.Cy5.5.A"), importance = rep(1, 8), normalize_weights = FALSE))
# EmbedSOM_results_train <- purrr::map(seq_along(diff_som_2_train), function(i) perform_SOM_step_2(diff_som = diff_som_2_train[[i]], facs_data_df_step_2[-test_indices[[i]], ], columns_to_use = c(1:18), importance = rep(1, 18), normalize_weights = TRUE))
# toc()
# 
# # EmbedSOM_results_train %>% saveRDS("~/Documents/imbalanced_EmbedSOM_results_train_step_2.rds")
# # EmbedSOM_results_train %>% saveRDS("~/Documents/balanced_all_features_EmbedSOM_results_train_step_2.rds")
# 
# # 393.943 sec elapsed
# # 188.726 sec elapsed
# tic()
# # EmbedSOM_results_test <- purrr::map(seq_along(diff_som_2_test), function(i) perform_SOM_step_2(diff_som = diff_som_2_test[[i]], facs_data_df_step_2[test_indices[[i]], ], columns_to_use = c("FITC.A", "Qdot.605.A", "Pacific.Blue.A", "APC.A", "PE.Cy7.A", "PE.Texas.Red.A", "BV786.A", "PerCP.Cy5.5.A"), importance = rep(1, 8), normalize_weights = FALSE))
# EmbedSOM_results_test <- purrr::map(seq_along(diff_som_2_test), function(i) perform_SOM_step_2(diff_som = diff_som_2_test[[i]], facs_data_df_step_2[test_indices[[i]], ], columns_to_use = c(1:18), importance = rep(1, 18), normalize_weights = TRUE))
# toc()
# 
# # EmbedSOM_results_test %>% saveRDS("~/Documents/imbalanced_EmbedSOM_results_test_step_2.rds")
# # EmbedSOM_results_test %>% saveRDS("~/Documents/balanced_all_features_EmbedSOM_results_test_step_2.rds")
```

# SOM - Selected features
```{r}
registerDoParallel(cores = 5)

#  - imbalanced data
# 1834.927 sec elapsed- balanced data
tic()
EmbedSOM_results_train <- purrr::map(seq_along(diff_som_2_train), function(i) perform_SOM(diff_som = diff_som_2_train[[i]], facs_data_df_step_2[-test_indices[[i]], ], columns_to_use = c(1:18), importance = rep(1, 18), normalize_weights = TRUE, class_column = "second_gate"))
toc()

# EmbedSOM_results_train %>% saveRDS(paste0(source_path, "home/trufenc/imbalanced_EmbedSOM_results_train_step_2.rds"))
EmbedSOM_results_train %>% saveRDS(paste0(source_path, "home/trufenc/balanced_all_features_EmbedSOM_results_train_step_2.rds"))

# 318
tic()
EmbedSOM_results_test <- purrr::map(seq_along(diff_som_2_test), function(i) perform_SOM(diff_som = diff_som_2_test[[i]], facs_data_df_step_2[test_indices[[i]], ], columns_to_use = c(1:18), importance = rep(1, 18), normalize_weights = TRUE, class_column = "second_gate"))
toc()

# EmbedSOM_results_test %>% saveRDS("~/Documents/imbalanced_EmbedSOM_results_test_step_2.rds")
EmbedSOM_results_test %>% saveRDS(paste0(source_path, "home/trufenc/balanced_all_features_EmbedSOM_results_test_step_2.rds"))
```



```{r}
# EmbedSOM_results_train <- readRDS("~/Documents/EmbedSOM_results_train_step_2.rds")
# EmbedSOM_results_test <- readRDS("~/Documents/EmbedSOM_results_test_step_2.rds")
```

```{r}
# EmbedSOM_results_train <- readRDS("~/Documents/imbalanced_EmbedSOM_results_train_step_2.rds")
# EmbedSOM_results_test <- readRDS("~/Documents/imbalanced_EmbedSOM_results_test_step_2.rds")
```

```{r}
EmbedSOM_results_train <- readRDS(paste0(source_path, "home/trufenc/balanced_all_features_EmbedSOM_results_train_step_2.rds"))
EmbedSOM_results_test <- readRDS(paste0(source_path, "home/trufenc/balanced_all_features_EmbedSOM_results_test_step_2.rds"))
```


# C5.0 on SOM
```{r}
# process_C5_from_SOM <- function(df, features, ...){  
#   library(tidyverse, warn.conflicts = FALSE)
#   library(caret, warn.conflicts = FALSE)
#   library(C50, warn.conflicts = FALSE)
# 
#   weights_df <- df %>% dplyr::select(features)
#   
#   classes <- df$second_gate %>% factor()
#   
#   rules_model <- C5.0(x = weights_df, y = classes, trials = 1, rules = TRUE)
# 
#   return(rules_model)
# }
```

```{r}
process_C5_from_SOM <- function(df, class_column, ...){  
  library(tidyverse, warn.conflicts = FALSE)
  library(caret, warn.conflicts = FALSE)
  library(C50, warn.conflicts = FALSE)

  classes <- df[[class_column]] %>% factor()
  
  weights_df <- df %>% dplyr::select(-class_column)
  
  rules_model <- C5.0(x = weights_df, y = classes, trials = 1, rules = TRUE)

  return(rules_model)
}
```


```{r}
registerDoParallel(cores = 5)

# 93.705 sec elapsed
tic()
rules_models_SOM_selected_features <- foreach(i = seq_along(EmbedSOM_results_train)) %dopar% process_C5_from_SOM(df = EmbedSOM_results_train[[i]]$weights_df, class_column = "second_gate")
toc()

# EmbedSOM_results_train[[1]]$diff_som$map$codes
# EmbedSOM_results_train[[1]]$EmbedSOM_results_df

rules_models_SOM_selected_features %>% saveRDS(file = paste0(source_path, "home/trufenc/rules_models_SOM_selected_features_balanced.rds"))
# rules_models_SOM_selected_features %>% saveRDS(file = paste0(source_path, "home/trufenc/rules_models_SOM_selected_features_imbalanced.rds"))
```

# Validate
```{r}
# 13.426 sec elapsed
# 31.484 sec elapsed - imbalanced
tic()
selected_features_SOM_predictions_validation <- purrr::map(seq_along(rules_models_SOM_selected_features), function(i) predict(rules_models_SOM_selected_features[[i]], newdata = EmbedSOM_results_test[[i]]$weights_df %>% dplyr::select(-second_gate)))
toc()
```

# Confusion matrix
```{r}
confusion_matrix_selected_features_SOM_results <- purrr::map(seq_along(selected_features_SOM_predictions_validation), function(i) caret::confusionMatrix(selected_features_SOM_predictions_validation[[i]] %>% factor(levels = step_2_levels), EmbedSOM_results_test[[i]]$weights_df$second_gate %>% factor(levels = step_2_levels)))

mean_selected_features_SOM_accuracy <- confusion_matrix_selected_features_SOM_results %>% purrr::map(function(x) x %>% .[["overall"]] %>% .["Accuracy"]) %>% unlist() %>% mean()

sd_selected_features_SOM_accuracy <- confusion_matrix_selected_features_SOM_results %>% purrr::map(function(x) x %>% .[["overall"]] %>% .["Accuracy"]) %>% unlist() %>% sd()

mean_selected_features_SOM_kappa <- confusion_matrix_selected_features_SOM_results %>% purrr::map(function(x) x %>% .[["overall"]] %>% .["Kappa"]) %>% unlist() %>% mean()

# purrr::map(seq_along(selected_features_SOM_predictions_validation), function(i) pROC::multiclass.roc(selected_features_SOM_predictions_validation[[i]], EmbedSOM_results_test[[i]]$EmbedSOM_results_df$second_gate %>% factor(levels = step_2_levels), levels = step_2_levels))
```

# Test if cross-validation really works with new data
```{r}
# test_diff_som$fs$data <- test_diff_som$fs$data %>% 
#   as.data.frame() %>% 
#   purrr::set_names(str_remove(string = colnames(test_diff_som$fs$data), pattern = "FJComp.")) %>% 
#   as.matrix()

test_diff_som$fs$data <- test_facs_data_df_step_2 %>% dplyr::select(-second_gate) %>% as.matrix()

# EmbedSOM_results_testing <- perform_SOM_step_2(diff_som = test_diff_som, facs_data_df = test_facs_data_df_step_2, columns_to_use = c("FITC.A", "Qdot.605.A", "Pacific.Blue.A", "APC.A", "PE.Cy7.A", "PE.Texas.Red.A", "BV786.A", "PerCP.Cy5.5.A"), importance = rep(1, 8), normalize_weights = FALSE)

EmbedSOM_results_testing <- perform_SOM(diff_som = test_diff_som, facs_data_df = test_facs_data_df_step_2, columns_to_use = c(1:18), importance = rep(1, 18), normalize_weights = TRUE, class_column = "second_gate")

test_selected_features_SOM_results <- purrr::map(seq_along(rules_models_SOM_selected_features), function(i) predict(rules_models_SOM_selected_features[[i]], newdata = EmbedSOM_results_testing$weights_df))

confusion_matrix_test_selected_SOM_features_results <- purrr::map(seq_along(test_selected_features_SOM_results), function(i) caret::confusionMatrix(test_selected_features_SOM_results[[i]], test_facs_data_df_step_2$second_gate %>% factor()))

confusion_matrix_test_selected_SOM_features_results %>% purrr::map(function(x) x %>% .[["overall"]] %>% .[["Kappa"]]) %>% unlist() %>% mean()
```







```{r}
library(xgboost)
library(Ckmeans.1d.dp)
```

```{r}
library(vroom)
# 0.23 sec elapsed
# tic()
# balanced_facs_data_df_step_2 <- vroom::vroom(file = paste0(source_path, "home/trufenc/balanced_facs_data_df_step_2.tsv"), delim = "\t")
# toc()
# facs_data_df_step_2 <- balanced_facs_data_df_step_2

tic()
facs_data_df_step_2 <- vroom::vroom(file = paste0(source_path, "/home/trufenc/imbalanced_facs_data_df_step_2.tsv"), delim = "\t")
toc()

# selected features
facs_data_df_step_2 <- facs_data_df_step_2 %>% dplyr::select(c("FITC.A", "Qdot.605.A", "Pacific.Blue.A", "APC.A", "PE.Cy7.A", "PE.Texas.Red.A", "BV786.A", "PerCP.Cy5.5.A", "second_gate"))

step_2_levels <- facs_data_df_step_2$second_gate %>% unique()

train_df <- facs_data_df_step_2 %>% dplyr::select(-second_gate)
```


```{r}
# test_diff_som <- readRDS(file = paste0(source_path, "home/trufenc/test_diff_som_2020_07_10.rds"))
test_facs_data_df_step_2 <- vroom::vroom(file = paste0(source_path, "home/trufenc/test_facs_data_df_step_2.tsv"), delim = "\t")

# selected features
test_facs_data_df_step_2 <- test_facs_data_df_step_2 %>% dplyr::select(c("FITC.A", "Qdot.605.A", "Pacific.Blue.A", "APC.A", "PE.Cy7.A", "PE.Texas.Red.A", "BV786.A", "PerCP.Cy5.5.A", "second_gate"))

test_df <- test_facs_data_df_step_2 %>% dplyr::select(-c(second_gate))

test_label <- test_facs_data_df_step_2 %>% 
  dplyr::select(second_gate) %>% 
  pull() %>% 
  str_replace(pattern = "CD4\\-NKT_cells", replacement = "1") %>% 
  str_replace(pattern = "CD4\\+NKT_cells", replacement = "2") %>% 
  str_replace(pattern = "CD8\\+_cells", replacement = "3") %>% 
  str_replace(pattern = "DN", replacement = "4") %>% 
  str_replace(pattern = "gdTCR_cells", replacement = "5") %>% 
  str_replace(pattern = "NK_cells", replacement = "6") %>% 
  str_replace(pattern = "Th_CD4\\+_cells", replacement = "7") %>% 
  str_replace(pattern = "Tregs_CD4\\+_cells", replacement = "8") %>% 
  as.numeric() %>%
  '-'(1)
```

```{r}
# train_diff_som <- test_diff_som
# train_diff_som$fs$data <- facs_data_df_step_2 %>% dplyr::select(-c(second_gate)) %>% as.matrix()
```


```{r}
# 456.667 sec elapsed
tic()
EmbedSOM_results_train <- perform_SOM(diff_som = train_diff_som, facs_data_df = facs_data_df_step_2, columns_to_use = c(1:18), importance = rep(1, 18), normalize_weights = FALSE, class_column = "second_gate")
toc()

# EmbedSOM_results_train %>% saveRDS("~/Documents/EmbedSOM_results_train_from_balanced_data_normalized_weights.rds")
# EmbedSOM_results_train %>% saveRDS("~/Documents/EmbedSOM_results_train_from_balanced_data_not_normalized_weights.rds")
```

```{r}
EmbedSOM_results_train$weights_df

EmbedSOM_results_train$weights_df <- EmbedSOM_results_train$weights_df %>% purrr::set_names(str_remove(string = colnames(.), pattern = ".y$"))
```


```{r}
classes_number <- data.frame(
  classes = step_2_levels,
  Number = 1:length(step_2_levels)
  )
```

```{r}
test_matrix <- xgb.DMatrix(
  data = test_df %>% as.matrix(), 
  label = test_label
  )
```

```{r}
n_classes <- length(step_2_levels)

train_label <- facs_data_df_step_2 %>% 
  dplyr::select(second_gate) %>% 
  pull() %>% 
  str_replace(pattern = "CD4\\-NKT_cells", replacement = "1") %>% 
  str_replace(pattern = "CD4\\+NKT_cells", replacement = "2") %>% 
  str_replace(pattern = "CD8\\+_cells", replacement = "3") %>% 
  str_replace(pattern = "DN", replacement = "4") %>% 
  str_replace(pattern = "gdTCR_cells", replacement = "5") %>% 
  str_replace(pattern = "NK_cells", replacement = "6") %>% 
  str_replace(pattern = "Th_CD4\\+_cells", replacement = "7") %>% 
  str_replace(pattern = "Tregs_CD4\\+_cells", replacement = "8") %>% 
  str_replace(pattern = "Not_Panel_A_cell_types", replacement = "9") %>% 
  as.numeric() %>%
  '-'(1) 
```


```{r}
k_fold <- 10

n_round <- 50

xgb_params <- list(objective = "multi:softprob",
                   eval_metric = "merror",
                   num_class = n_classes)

train_matrix <- xgb.DMatrix(
  data = train_df %>% as.matrix(), 
  label = train_label
  )

# train_SOM_matrix <- xgb.DMatrix(
#   data = EmbedSOM_results_train$weights_df %>% dplyr::select(-second_gate) %>% as.matrix(), 
#   label = train_label
#   )

# 1418.739 sec elapsed
# 1203.969 sec elapsed
tic()
cv_model <- xgb.cv(params = xgb_params,
                   data = train_matrix, 
                   nrounds = n_round,
                   nfold = k_fold,
                   verbose = TRUE,
                   prediction = TRUE)
toc()


# 299.04 sec elapsed
# 266.052 sec elapsed
# tic()
# cv_model <- xgb.cv(params = xgb_params,
#                    data = train_SOM_matrix, 
#                    nrounds = n_round,
#                    nfold = k_fold,
#                    verbose = TRUE,
#                    prediction = TRUE)
# toc()


OOF_prediction <- data.frame(cv_model$pred) %>%
  mutate(max_prob = max.col(., ties.method = "last"),
         label = train_label + 1)

OOF_prediction <- OOF_prediction %>%
  mutate(max_prob = max_prob %>% recode(
    "1" = "CD4-NKT_cells",
    "2" = "CD4+NKT_cells",
    "3" = "CD8+_cells",
    "4" = "DN ",
    "5" = "gdTCR_cells",
    "6" = "NK_cells",
    "7" = "Th_CD4+_cells",
    "8" = "Tregs_CD4+_cells",
    "9" = "Not_Panel_A_cell_types"
  ))

OOF_prediction <- OOF_prediction %>%
  mutate(label = label %>% recode(
    "1" = "CD4-NKT_cells",
    "2" = "CD4+NKT_cells",
    "3" = "CD8+_cells",
    "4" = "DN ",
    "5" = "gdTCR_cells",
    "6" = "NK_cells",
    "7" = "Th_CD4+_cells",
    "8" = "Tregs_CD4+_cells",
    "9" = "Not_Panel_A_cell_types"
  ))

# confusion matrix
confusionMatrix(factor(OOF_prediction$max_prob),
                factor(OOF_prediction$label),
                mode = "everything")

# 130.408 sec elapsed
tic()
best_model <- xgb.train(params = xgb_params,
                       data = train_matrix,
                       nrounds = n_round)
toc()

# tic()
# best_model <- xgb.train(params = xgb_params,
#                        data = train_SOM_matrix,
#                        nrounds = n_round)
# toc()

# Predict hold-out test set
test_pred <- predict(best_model, newdata = test_matrix)

test_prediction_df <- matrix(
  data = test_pred,
  nrow = n_classes,
  ncol = length(test_pred) / n_classes
  ) %>%
  t() %>%
  data.frame()

test_prediction <- test_prediction_df %>%
  mutate(
    label = test_label %>% as.numeric() + 1,
    max_prob = max.col(., "last")
  )

# confusion matrix of test set
confusionMatrix(factor(test_prediction$max_prob),
                factor(test_prediction$label),
                mode = "everything")
```



```{r}
k_fold <- 10

n_round <- 1000

train_matrix <- xgb.DMatrix(
  data = train_df %>% as.matrix(), 
  label = train_label
  )

# xgboost fitting with arbitrary parameters

# parameter to tune: 
# nrounds controls the maximum number of iterations. For classification, it is similar to the number of trees to grow.
# eta controls the learning rate, i.e., the rate at which our model learns patterns in data. Typically, it lies between 0.01 - 0.3
# gamma controls regularization (or prevents overfitting)
# max_depth controls the depth of the tree. Larger data sets require deep trees to learn the rules from data.
# subsample controls the number of samples (observations) supplied to a tree. Typically, its values lie between (0.5-0.8)
# colsample_bytree control the number of features (variables) supplied to a tree. Typically, its values lie between (0.5,0.9)
# lambda controls L2 regularization (equivalent to Ridge regression) on weights. It is used to avoid overfitting.
# alpha controls L1 regularization (equivalent to Lasso regression) on weights. In addition to shrinkage, enabling alpha also results in feature selection. Hence, it's more useful on high dimensional data sets.

# Learning Task Parameters
## Objective
### multi:softmax - multiclassification using softmax objective. It returns predicted class labels.
### multi:softprob - multiclassification using softmax objective. It returns predicted class probabilities.

## eval_metric
### AUC - Area under curve (used in classification)
### Logloss - Negative loglikelihood (used in classification)
### mlogloss - multiclass logloss (used in classification)

# default parameters
xgb_params <- list(
  booster = "gbtree",
  objective = "multi:softprob", 
  eta = 0.01,
  gamma = 0,
  max_depth = 6,
  min_child_weight = 1, 
  subsample = 1, 
  colsample_bytree = 1,
  # eval_metric = "merror",
  num_class = n_classes
)

# fit the model with the arbitrary parameters specified above
# 1331.292 sec elapsed
# tic()
# xgb_cv_model <- xgb.cv(
#   params = xgb_params,
#   data = train_matrix,
#   nrounds = 100,
#   nfold = 5,
#   showsd = T,
#   stratified = T,
#   print_every_n = 1,
#   early_stopping_rounds = 20,
#   maximize = F,
#   prediction = TRUE
# )
# toc()

# 4201.047 sec elapsed
tic()
xgb_cv_model_1 <- xgb.cv(
  params = xgb_params,
  data = train_matrix,
  nrounds = n_round,
  nfold = k_fold,
  showsd = T,
  stratified = T,
  print_every_n = 1,
  early_stopping_rounds = 10,
  maximize = F,
  prediction = TRUE
)
toc()

# Best iteration: 224
xgb_cv_model_1$best_iteration

xgb_cv_model_1$evaluation_log %>% dplyr::filter(iter == xgb_cv_model_1$best_iteration) %>% dplyr::select(test_merror_mean) %>% pull

# xgb_cv_model_1 %>% saveRDS(file = paste0(source_path, "home/trufenc/xgb_cv_model_standard_parameters.rds"))

xgb_cv_model_1$evaluation_log %>% 
  ggplot(aes(x = iter)) +
  geom_line(aes(y = train_merror_mean, colour = "train")) + 
  geom_line(aes(y = test_merror_mean, colour = "test"))

# first default - model training
tic()
xgb_1 <- xgb.train(
  params = xgb_params, 
  data = train_matrix, 
  nrounds = xgb_cv_model_1$best_iteration, 
  watchlist = list(val = test_matrix, train = train_matrix), 
  print_every_n = 1, 
  early_stopping_rounds = 10, 
  maximize = F , 
  eval_metric = "merror"
  )
toc()

# model prediction
xgb_pred <- predict(xgb_1, test_matrix)

test_prediction_df <- matrix(
  data = xgb_pred,
  nrow = n_classes,
  ncol = length(xgb_pred) / n_classes
  ) %>%
  t() %>%
  data.frame()

test_prediction <- test_prediction_df %>%
  mutate(
    label = test_label %>% as.numeric() + 1,
    max_prob = max.col(., "last")
  )

# xgb_pred <- ifelse(xgb_pred > 0.5, 1, 0)

# confusion matrix
library(caret)
confusionMatrix(factor(test_prediction$label), factor(test_prediction$max_prob))

#view variable importance plot
importance_matrix <- xgb.importance(feature_names = colnames(train_matrix), model = xgb_1)

gp = xgb.ggplot.importance(importance_matrix = importance_matrix)
print(gp) 
```

```{r}
library(mlr)

# Convert characters to factors
train_df <- facs_data_df_step_2 %>% mutate(second_gate = second_gate %>% factor()) %>% as.data.frame()
test_df <- test_facs_data_df_step_2 %>% mutate(second_gate = second_gate %>% factor()) %>% as.data.frame()

# Do one hot encoding`<br/>
train_df <- createDummyFeatures(obj = train_df, target = "second_gate", method = "1-of-n")
test_df <- createDummyFeatures(obj = test_df, target = "second_gate", method = "1-of-n")

# Create tasks
train_task <- makeClassifTask(data = train_df, target = "second_gate")
test_task <- makeClassifTask(data = test_facs_data_df_step_2, target = "second_gate")

# Create learner
lrn <- makeLearner("classif.xgboost", predict.type = "response")
lrn$par.vals <- list(objective = "multi:softprob", eval_metric = "merror", nrounds = 500L, eta = 0.1)

# Set parameter space
params <- makeParamSet(
  makeDiscreteParam("booster", values = c("gbtree", "dart")),
  makeIntegerParam("max_depth", lower = 3L, upper = 10L),
  makeNumericParam("min_child_weight", lower = 1L, upper = 10L),
  makeNumericParam("subsample", lower = 0.5, upper = 1),
  makeNumericParam("colsample_bytree", lower = 0.5, upper = 1),
  makeNumericParam("gamma", lower = 5L, upper = 10L)
)

# set resampling strategy
rdesc <- makeResampleDesc("CV", stratify = T, iters = 5L)

# Search strategy
ctrl <- makeTuneControlRandom(maxit = 10L)

# Set parallel backend
library(parallel)
library(parallelMap) 
parallelStartSocket(cpus = (detectCores()-1))

#parameter tuning
# 440945.636 sec elapsed
tic()
xgb_tuning <- tuneParams(learner = lrn, task = train_task, resampling = rdesc, measures = acc, par.set = params, control = ctrl, show.info = T)
toc()

# xgb_tuning %>% saveRDS("~/Documents/xgb_tuning_step_2_balanced_data.rds")
# xgb_tuning <- readRDS("~/Documents/xgb_tuning_step_2_balanced_data.rds")
xgb_tuning <- readRDS(paste0(source_path, "home/trufenc/xgb_tuning_step_2_balanced_data.rds"))

xgb_tuning$y

#set hyperparameters
lrn_tune <- setHyperPars(lrn,par.vals = xgb_tuning$x)

#train model
xg_model <- train(learner = lrn_tune, task = train_task)

#predict model
xg_pred <- predict(xg_model, test_task)

confusion_matrix <- confusionMatrix(xg_pred$data$response, xg_pred$data$truth)

conf_df <- confusion_matrix$byClass %>% as.data.frame()

conf_df$F1
```



















# Split data for Cross-validation
```{r}
second_gate_table <- table(balanced_facs_data_df_step_2$second_gate)

# sort data
reseed()
balanced_facs_data_df_step_2 <- balanced_facs_data_df_step_2 %>% dplyr::slice(sample(nrow(balanced_facs_data_df_step_2)))

k_fold <- 5

# Create 5 equally size folds
reseed()
folds <- cut(x = seq(1, nrow(balanced_facs_data_df_step_2)), breaks = k_fold, labels = FALSE)
# Perform 10 fold cross validation
# Segement your data by fold using the which() function
test_indices <- purrr::map(seq_len(k_fold), function(i) which(folds == i, arr.ind = TRUE))

# Use the test and train data partitions however you desire...
test_data <- purrr::map(seq_len(k_fold), function(i) balanced_facs_data_df_step_2[test_indices[[i]], ]) %>% purrr::set_names(paste0("test_", 1:k_fold))
train_data <- purrr::map(seq_len(k_fold), function(i) balanced_facs_data_df_step_2[-test_indices[[i]], ]) %>% purrr::set_names(paste0("train_", 1:k_fold))
  
train_data_list <- purrr::map(seq_len(k_fold), function(i) list(measurements = train_data[[i]] %>% as.matrix(), classes_col = train_data[[i]] %>% dplyr::select(second_gate) %>% unlist()))
  
test_data_list <- purrr::map(seq_len(k_fold), function(i) list(measurements = test_data[[i]] %>% dplyr::select(-second_gate) %>% as.matrix(), classes_col = test_data[[i]] %>% dplyr::select(second_gate) %>% unlist()))
```



```{r}
# process_C5 <- function(input = facs_data_df, n_clusters, ...){
process_C5 <- function(df, features, ...){  
  library(tidyverse, warn.conflicts = FALSE)
  library(caret, warn.conflicts = FALSE)
  library(C50, warn.conflicts = FALSE)
  # library(doParallel, warn.conflicts = FALSE)
  # EmbedSOM_results_df_all = process_step_1_output$EmbedSOM_results_df_all
  # EmbedSOM_results_df = process_step_1_output$EmbedSOM_results_df
  # facs_data_df = process_step_1_output$facs_data_df
  # 
  # features_all_from_SOM <- EmbedSOM_results_df_all %>% dplyr::select(dplyr::contains(".y"))
  # features_selected_from_SOM <- df %>% dplyr::select(dplyr::contains(".y"))
  # 
  
  df <- df %>% as.data.frame()
  
  features_df <- df %>% 
    dplyr::select(-c(second_gate)) %>% 
    dplyr::select(features) %>% 
    apply(FUN = as.numeric, MARGIN = c(2)) %>% 
    as.data.frame()
  
  # features_selected_no_SOM <- df %>% dplyr::select(-c(first_gate, cell_type)) %>% dplyr::select(c(FSC.A, SSC.A, FSC.H, SSC.W, Indo.1..Violet..A))
  
  classes <- df$second_gate %>% factor()
  
  # rules_model_selected
  # rules_model <- C5.0(x = features_df, y = classes, trials = 20, rules = TRUE)
  # tree_model <- C5.0(x = features_df, y = classes, trials = 20, rules = FALSE)
  
  # rules_model_all
  rules_model <- C5.0(x = features_df, y = classes, trials = 20, rules = TRUE)
  # tree_model <- C5.0(x = features_df, y = classes, trials = 20, rules = FALSE)
  
  # rules_model_from_SOM
  # rules_model <- C5.0(x = features_selected_from_SOM, y = classes, trials = 1, rules = TRUE)
  # tree_model <- C5.0(x = features_selected_from_SOM, y = classes, trials = 1, rules = FALSE)
  
  # tree_model_from_SOM_all_features
  # tree_model <- C5.0(x = features_all_from_SOM, y = classes, trials = 1, rules = FALSE)
  # rules_model <- C5.0(x = features_all_from_SOM, y = classes, trials = 1, rules = TRUE)

    return(rules_model)
}


# df_1 <- train_data[[1]] %>% 
#   as.data.frame() %>% 
#   dplyr::select(-c(first_gate, cell_type)) %>% 
#   dplyr::select(c(1:18)) %>% 
#   apply(FUN = as.numeric, MARGIN = c(2)) %>% 
#   as.data.frame()
```

# No SOM - use data directly
```{r}
registerDoParallel(cores = 5)

# 
tic()
rules_models_step_2 <- foreach(i = seq_along(train_data)) %dopar% process_C5(df = train_data[[i]], features = c("FITC.A", "Qdot.605.A", "Pacific.Blue.A", "APC.A", "PE.Cy7.A", "PE.Texas.Red.A", "BV786.A", "PerCP.Cy5.5.A"))
toc()
```

Validate
```{r}
# 48.722 sec elapsed
tic()
predictions_validation <- purrr::map(seq_along(rules_models_step_2_results), function(i) predict(rules_models_step_2[[i]], newdata = test_data_list[[i]]$measurements))
toc()
```

# Confusion matrix
```{r}
confusion_matrix_results <- purrr::map(seq_along(predictions_validation), function(i) caret::confusionMatrix(predictions_validation[[i]], test_data_list[[i]]$classes_col %>% factor()))

mean_accuracy <- confusion_matrix_results %>% purrr::map(function(x) x %>% .[["overall"]] %>% .["Accuracy"]) %>% unlist() %>% mean()

sd_accuracy <- confusion_matrix_results %>% purrr::map(function(x) x %>% .[["overall"]] %>% .["Accuracy"]) %>% unlist() %>% sd()

mean_kappa <- confusion_matrix_results %>% purrr::map(function(x) x %>% .[["overall"]] %>% .["Kappa"]) %>% unlist() %>% mean()
```


```{r}
# diff_som <- diff_som_1_train[[1]]

perform_SOM <- function(diff_som, facs_data_df, columns_to_use = c("FSC.A", "FSC.H", "SSC.A", "SSC.W", "Indo.1..Violet..A"), importance = c(1, 1, 1, 1, 1), normalize_weights = TRUE) {

  diff_som = diff_som
  
  # calculate optimal grid
  vesanto_dim <- diff_som$fs$data %>%
    nrow() %>%
    sqrt() %>%
    "*"(5)
  
  grid_dim <- vesanto_dim %>%
    sqrt() %>%
    ceiling() %>%
    "+"(20)

  # SOM
  reseed()
  ds_step_1 <- diff_som %>% Embed(xdim = grid_dim, ydim = grid_dim, colsToUse = columns_to_use, importance = importance, nclust = grid_dim * grid_dim, rlen = 5)

  # Optional to normalize weights
  if (normalize_weights) {
    ds_step_1$map$codes <- purrr::map(seq_len(ncol(ds_step_1$map$codes)), function(i) {ds_step_1$map$codes[, i] %>% bestNormalize::orderNorm() %>% .[["x.t"]] %>% scale_to_range_0_1()}) %>% purrr::set_names(colnames(ds_step_1$map$codes)) %>% bind_cols()
  }

  grid_clustering_df <- ds_step_1$map$grid %>%
    as.data.frame() %>%
    rownames_to_column() %>%
    mutate(cluster = ds_step_1$clust) %>%
    mutate(rowname = rowname %>% as.numeric()) %>%
    bind_cols(as.data.frame(ds_step_1$map$codes))

  EmbedSOM_results_df <- ds_step_1$fs$data %>%
    as.data.frame() %>%
    mutate(mapping = ds_step_1$map$mapping[, 1]) %>%
    left_join(grid_clustering_df, by = c("mapping" = "rowname")) %>%
    mutate(first_gate = facs_data_df$first_gate)

  output <- list(EmbedSOM_results_df = EmbedSOM_results_df,
                 diff_som = ds_step_1)
  
  return(output)
}

```


# SOM - Selected features
```{r}
registerDoParallel(cores = 5)
# 175.813 sec elapsed - serial
tic()
# EmbedSOM_results_train <- purrr::map(seq_along(diff_som_1_train), function(i) perform_SOM(diff_som = diff_som_1_train[[i]], facs_data_subset_df[-test_indices[[i]], ], columns_to_use = c("FSC.A", "FSC.H", "SSC.A", "SSC.W", "Indo.1..Violet..A"), importance = c(1, 1, 1, 1, 1), normalize_weights = TRUE))
EmbedSOM_results_train <- purrr::map(seq_along(diff_som_1_train), function(i) perform_SOM(diff_som = diff_som_1_train[[i]], facs_data_subset_df[-test_indices[[i]], ], columns_to_use = c("FSC.A", "FSC.H", "SSC.A", "SSC.W", "Indo.1..Violet..A"), importance = c(1, 1, 1, 1, 1), normalize_weights = FALSE))
toc()

# 40.863 sec elapsed
tic()
# EmbedSOM_results_test <- purrr::map(seq_along(diff_som_1_test), function(i) perform_SOM(diff_som = diff_som_1_test[[i]], facs_data_subset_df[test_indices[[i]], ], columns_to_use = c("FSC.A", "FSC.H", "SSC.A", "SSC.W", "Indo.1..Violet..A"), importance = c(1, 1, 1, 1, 1), normalize_weights = TRUE))
EmbedSOM_results_test <- purrr::map(seq_along(diff_som_1_test), function(i) perform_SOM(diff_som = diff_som_1_test[[i]], facs_data_subset_df[test_indices[[i]], ], columns_to_use = c("FSC.A", "FSC.H", "SSC.A", "SSC.W", "Indo.1..Violet..A"), importance = c(1, 1, 1, 1, 1), normalize_weights = FALSE))
toc()
```

# C5.0 on SOM
```{r}
process_C5_from_SOM <- function(df, features, ...){  
  library(tidyverse, warn.conflicts = FALSE)
  library(caret, warn.conflicts = FALSE)
  library(C50, warn.conflicts = FALSE)
  # EmbedSOM_results_df_all = process_step_1_output$EmbedSOM_results_df_all
  # EmbedSOM_results_df = process_step_1_output$EmbedSOM_results_df
  # facs_data_df = process_step_1_output$facs_data_df
  # 
  # features_all_from_SOM <- EmbedSOM_results_df_all %>% dplyr::select(dplyr::contains(".y"))
  weights_df <- df %>% dplyr::select(features)
  # 
  # features_all_no_SOM <- facs_data_df %>% dplyr::select(-c(first_gate, cell_type))
  # features_selected_no_SOM <- facs_data_df %>% dplyr::select(-c(first_gate, cell_type)) %>% dplyr::select(c(FSC.A, SSC.A, FSC.H, SSC.W, Indo.1..Violet..A))
  
  classes <- df$first_gate %>% factor()

  # rules_model_selected
  # rules_model <- C5.0(x = features_df, y = classes, trials = 20, rules = TRUE)
  # tree_model <- C5.0(x = features_df, y = classes, trials = 20, rules = FALSE)
  
  # rules_model_all
  # rules_model <- C5.0(x = features_df, y = classes, trials = 20, rules = TRUE)
  # tree_model <- C5.0(x = features_df, y = classes, trials = 20, rules = FALSE)
  
  # rules_model_from_SOM
  rules_model <- C5.0(x = weights_df, y = classes, trials = 1, rules = TRUE)
  # tree_model <- C5.0(x = weights_df, y = classes, trials = 1, rules = FALSE)
  
  # tree_model_from_SOM_all_features
  # tree_model <- C5.0(x = weights_df, y = classes, trials = 1, rules = FALSE)
  # rules_model <- C5.0(x = weights_df, y = classes, trials = 1, rules = TRUE)
  return(rules_model)
}

# 78.039 sec elapsed - serial
tic()
# rules_models_SOM_selected_features <- EmbedSOM_results_train %>% purrr::map(function(x) x %>% .[["EmbedSOM_results_df"]] %>% process_C5(dplyr::contains(".y")))
# rules_models_SOM_selected_features <- EmbedSOM_results_train %>% purrr::map(function(x) x %>% .[["diff_som"]] %>% .[["map"]] %>% .[["codes"]] %>% process_C5(n_clusters = 6))
# rules_models_SOM_selected_features <- purrr::map(seq_along(EmbedSOM_results_train), function(i) EmbedSOM_results_train[[i]]$EmbedSOM_results_df %>% process_C5(n_clusters = 6))

rules_models_SOM_selected_features <- foreach(i = seq_along(EmbedSOM_results_train)) %dopar% process_C5_from_SOM(df = EmbedSOM_results_train[[i]]$EmbedSOM_results_df, features = dplyr::contains(".y"))
toc()

# EmbedSOM_results_train[[1]]$diff_som$map$codes
# EmbedSOM_results_train[[1]]$EmbedSOM_results_df

# rules_models_SOM_selected_features %>% saveRDS(file = "~/Downloads/rules_models_SOM_selected_features.rds")
```


# Validate
```{r}
# 2.862 sec elapsed
tic()
selected_features_SOM_predictions_validation <- purrr::map(seq_along(rules_models_SOM_selected_features), function(i) predict(rules_models_SOM_selected_features[[i]], newdata = EmbedSOM_results_test[[i]]$EmbedSOM_results_df %>% dplyr::select(dplyr::contains(".y"))))
toc()
```

# Confusion matrix
```{r}
confusion_matrix_selected_features_SOM_results <- purrr::map(seq_along(selected_features_SOM_predictions_validation), function(i) caret::confusionMatrix(selected_features_SOM_predictions_validation[[i]], EmbedSOM_results_test[[i]]$EmbedSOM_results_df$first_gate %>% factor()))

mean_selected_features_SOM_accuracy <- confusion_matrix_selected_features_SOM_results %>% purrr::map(function(x) x %>% .[["overall"]] %>% .["Accuracy"]) %>% unlist() %>% mean()

sd_selected_features_SOM_accuracy <- confusion_matrix_selected_features_SOM_results %>% purrr::map(function(x) x %>% .[["overall"]] %>% .["Accuracy"]) %>% unlist() %>% sd()

mean_selected_features_SOM_kappa <- confusion_matrix_selected_features_SOM_results %>% purrr::map(function(x) x %>% .[["overall"]] %>% .["Kappa"]) %>% unlist() %>% mean()
```





























# Data oversampling for the rare classes (here, DN)

# https://cran.r-project.org/web/packages/imbalance/vignettes/imbalance.pdf
```{r}
CD4_pos_NKT_total <- (freq_df %>% dplyr::filter(. == "Th_CD4+_cells") %>% dplyr::select(Freq) %>% pull())
DN_total <- (freq_df %>% dplyr::filter(. == "DN ") %>% dplyr::select(Freq) %>% pull())
gdTCR_total <- (freq_df %>% dplyr::filter(. == "gdTCR_cells") %>% dplyr::select(Freq) %>% pull())
NK_total <- (freq_df %>% dplyr::filter(. == "NK_cells") %>% dplyr::select(Freq) %>% pull())
CD4_neg_NKT_total <- (freq_df %>% dplyr::filter(. == "CD4-NKT_cells") %>% dplyr::select(Freq) %>% pull())
```

```{r}
DN_original <- facs_data_df_step_2 %>% dplyr::filter(second_gate %in% c("Th_CD4+_cells", "DN "))
```

```{r}
DN_original_table <- table(DN_original$second_gate)

# sort data
reseed()
DN_original <- DN_original %>% dplyr::slice(sample(nrow(facs_data_df)))

k_fold <- 10

# Create 5 equally size folds
reseed()
folds <- cut(x = seq(1, nrow(DN_original)), breaks = k_fold, labels = FALSE)
# Perform 10 fold cross validation
# Segement your data by fold using the which() function
test_indices <- purrr::map(seq_len(k_fold), function(i) which(folds == i, arr.ind = TRUE))

# Use the test and train data partitions however you desire...
# test_data <- purrr::map(seq_len(k_fold), function(i) DN_original[test_indices[[i]], ]) %>% purrr::set_names(paste0("test_", 1:k_fold))
# train_data <- purrr::map(seq_len(k_fold), function(i) DN_original[-test_indices[[i]], ]) %>% purrr::set_names(paste0("train_", 1:k_fold))

test_data <- purrr::map(seq_len(k_fold), function(i) facs_data_df_step_2[test_indices[[i]], ]) %>% purrr::set_names(paste0("test_", 1:k_fold))
train_data <- purrr::map(seq_len(k_fold), function(i) facs_data_df_step_2[-test_indices[[i]], ]) %>% purrr::set_names(paste0("train_", 1:k_fold))

train_data_list <- purrr::map(seq_len(k_fold), function(i) list(measurements = train_data[[i]] %>% as.matrix(), classes_col = train_data[[i]] %>% dplyr::select(second_gate) %>% unlist()))
  
test_data_list <- purrr::map(seq_len(k_fold), function(i) list(measurements = test_data[[i]] %>% dplyr::select(-c(second_gate)) %>% as.matrix(), classes_col = test_data[[i]] %>% dplyr::select(second_gate) %>% unlist()))
```




# mldr package
```{r}
# library(mldr)
# library(pROC)
# library(dummies)
# 
# facs_data_df_step_2_dummy <- dummy.data.frame(facs_data_df_step_2, sep = ".")
# 
# facs_data_mldr <- mldr_from_dataframe(facs_data_df_step_2_dummy, labelIndices = c(19:26), name = "facs_data")
# summary(facs_data_mldr)
# plot(facs_data_mldr, type = "LB")
# plot(facs_data_mldr, type = "CH")
# plot(facs_data_mldr, type = "LSB")
# plot(facs_data_mldr, type = "AT")
# plot(facs_data_mldr, type = "LSH")
```






```{r}
# library(rpart)
# 
# tree_imb <- rpart(second_gate ~ ., data = train_data[[1]])
# 
# pred_tree_imb <- predict(tree_imb, newdata = test_data[[1]])
# 
# accuracy.meas(test_data[[1]]$second_gate, pred_tree_imb[,2])
# 
# roc.curve(test_data[[1]]$second_gate, pred_tree_imb[,2], plotit = T)
```

```{r}
freq_train_Th_CD4_pos_cells <- train_data[[1]] %>% group_by(second_gate) %>% tally() %>% dplyr::filter(second_gate == "Th_CD4+_cells") %>% dplyr::select(n) %>% pull()
freq_train_DN_cells <- train_data[[1]] %>% group_by(second_gate) %>% tally() %>% dplyr::filter(second_gate == "DN ") %>% dplyr::select(n) %>% pull()
```

# over sampling
```{r}
library(C50)
# data_balanced_over <- ovun.sample(second_gate ~ ., data = train_data[[1]], method = "over", N = 2*freq_train_Th_CD4_pos_cells)$data
# data_balanced_under <- ovun.sample(second_gate ~ ., data = train_data[[1]], method = "under", N = 2*freq_train_DN_cells)$data
data_balanced_both <- ovun.sample(second_gate ~ ., data = train_data[[1]], method = "both", N = mean_classes)$data
data_rose <- ovun.sample(second_gate ~ ., data = train_data[[1]], seed = 123)$data

data_balanced_both <- ovun.sample(second_gate ~ ., data = train_data[[1]], method = "both", N = mean_classes)$data


#build decision tree models
# tree_rose <- rpart(second_gate ~ ., data = data_rose)
# tree_over <- rpart(second_gate ~ ., data = data_balanced_over)
# tree_under <- rpart(second_gate ~ ., data = data_balanced_under)
# tree_both <- rpart(second_gate ~ ., data = data_balanced_both)

tree_rose <- C5.0(x = data_rose %>% dplyr::select(-second_gate), y = factor(data_rose$second_gate), trials = 20, rules = TRUE)
# tree_over <- C5.0(x = data_balanced_over %>% dplyr::select(-second_gate), y = factor(data_balanced_over$second_gate), trials = 20, rules = TRUE)
# tree_under <- C5.0(x = data_balanced_under %>% dplyr::select(-second_gate), y = factor(data_balanced_under$second_gate), trials = 20, rules = TRUE)
tree_both <- C5.0(x = data_balanced_both %>% dplyr::select(-second_gate), y = factor(data_balanced_both$second_gate), trials = 20, rules = TRUE)

# make predictions on unseen data
pred_tree_rose <- predict(tree_rose, newdata = test_data[[1]] %>% dplyr::select(-second_gate))
# pred_tree_over <- predict(tree_over, newdata = test_data[[1]] %>% dplyr::select(-second_gate))
# pred_tree_under <- predict(tree_under, newdata = test_data[[1]] %>% dplyr::select(-second_gate))
pred_tree_both <- predict(tree_both, newdata = test_data[[1]] %>% dplyr::select(-second_gate))

# AUC ROSE
roc.curve(test_data[[1]]$second_gate, pred_tree_rose, plot = TRUE)
# AUC Oversampling
# roc.curve(test_data[[1]]$second_gate, pred_tree_over, plot = TRUE)
# AUC Undersampling
# roc.curve(test_data[[1]]$second_gate, pred_tree_under, plot = TRUE)
# AUC Both
roc.curve(test_data[[1]]$second_gate, pred_tree_both, plot = TRUE)
```

```{r}
# data_balanced_over_list <- purrr::map(seq_along(train_data_list), function(i) ovun.sample(second_gate ~ ., data = train_data[[i]], method = "over", N = 2*freq_train_Th_CD4_pos_cells)$data)

# data_balanced_over_list <- list(
#   ovun.sample(second_gate ~ ., data = train_data[[1]], method = "over", N = 2 * freq_train_Th_CD4_pos_cells)$data,
#   ovun.sample(second_gate ~ ., data = train_data[[2]], method = "over", N = 2 * freq_train_Th_CD4_pos_cells)$data,
#   ovun.sample(second_gate ~ ., data = train_data[[3]], method = "over", N = 2 * freq_train_Th_CD4_pos_cells)$data,
#   ovun.sample(second_gate ~ ., data = train_data[[4]], method = "over", N = 2 * freq_train_Th_CD4_pos_cells)$data,
#   ovun.sample(second_gate ~ ., data = train_data[[5]], method = "over", N = 2 * freq_train_Th_CD4_pos_cells)$data
# )

# data_balanced_under_list <- purrr::map(seq_along(train_data_list), function(i) ovun.sample(second_gate ~ ., data = train_data[[i]], method = "under", N = 2*freq_train_DN_cells)$data)

# data_balanced_under_list <- list(
#   ovun.sample(second_gate ~ ., data = train_data[[1]], method = "under", N = 2 * freq_train_DN_cells)$data,
#   ovun.sample(second_gate ~ ., data = train_data[[2]], method = "under", N = 2 * freq_train_DN_cells)$data,
#   ovun.sample(second_gate ~ ., data = train_data[[3]], method = "under", N = 2 * freq_train_DN_cells)$data,
#   ovun.sample(second_gate ~ ., data = train_data[[4]], method = "under", N = 2 * freq_train_DN_cells)$data,
#   ovun.sample(second_gate ~ ., data = train_data[[5]], method = "under", N = 2 * freq_train_DN_cells)$data
# )

# data_balanced_both_list <- purrr::map(seq_along(train_data_list), function(i) ovun.sample(second_gate ~ ., data = train_data[[i]], method = "both", N = mean(freq_train_Th_CD4_pos_cells, freq_train_DN_cells))$data)

data_balanced_both_list <- list(
  ovun.sample(second_gate ~ ., data = train_data[[1]], method = "both", N = mean(freq_train_Th_CD4_pos_cells, freq_train_DN_cells))$data,
  ovun.sample(second_gate ~ ., data = train_data[[2]], method = "both", N = mean(freq_train_Th_CD4_pos_cells, freq_train_DN_cells))$data,
  ovun.sample(second_gate ~ ., data = train_data[[3]], method = "both", N = mean(freq_train_Th_CD4_pos_cells, freq_train_DN_cells))$data,
  ovun.sample(second_gate ~ ., data = train_data[[4]], method = "both", N = mean(freq_train_Th_CD4_pos_cells, freq_train_DN_cells))$data,
  ovun.sample(second_gate ~ ., data = train_data[[5]], method = "both", N = mean(freq_train_Th_CD4_pos_cells, freq_train_DN_cells))$data,
  ovun.sample(second_gate ~ ., data = train_data[[6]], method = "both", N = mean(freq_train_Th_CD4_pos_cells, freq_train_DN_cells))$data,
  ovun.sample(second_gate ~ ., data = train_data[[7]], method = "both", N = mean(freq_train_Th_CD4_pos_cells, freq_train_DN_cells))$data,
  ovun.sample(second_gate ~ ., data = train_data[[8]], method = "both", N = mean(freq_train_Th_CD4_pos_cells, freq_train_DN_cells))$data,
  ovun.sample(second_gate ~ ., data = train_data[[9]], method = "both", N = mean(freq_train_Th_CD4_pos_cells, freq_train_DN_cells))$data,
  ovun.sample(second_gate ~ ., data = train_data[[10]], method = "both", N = mean(freq_train_Th_CD4_pos_cells, freq_train_DN_cells))$data
)

# data_rose_list <- purrr::map(seq_along(train_data_list), function(i) ovun.sample(second_gate ~ ., data = train_data[[i]], seed = 123)$data)

data_rose_list <- list(
  ovun.sample(second_gate ~ ., data = train_data[[1]], seed = 123)$data,
  ovun.sample(second_gate ~ ., data = train_data[[2]], seed = 123)$data,
  ovun.sample(second_gate ~ ., data = train_data[[3]], seed = 123)$data,
  ovun.sample(second_gate ~ ., data = train_data[[4]], seed = 123)$data,
  ovun.sample(second_gate ~ ., data = train_data[[5]], seed = 123)$data,
  ovun.sample(second_gate ~ ., data = train_data[[6]], seed = 123)$data,
  ovun.sample(second_gate ~ ., data = train_data[[7]], seed = 123)$data,
  ovun.sample(second_gate ~ ., data = train_data[[8]], seed = 123)$data,
  ovun.sample(second_gate ~ ., data = train_data[[9]], seed = 123)$data,
  ovun.sample(second_gate ~ ., data = train_data[[10]], seed = 123)$data
)
```

```{r}
tree_rose_list <- purrr::map(seq_along(train_data_list), function(i) C5.0(x = data_rose_list[[i]] %>% dplyr::select(-second_gate), y = factor(data_rose_list[[i]]$second_gate), trials = 20, rules = TRUE))

# tree_rose_list <- list(
#   C5.0(x = data_rose_list[[1]] %>% dplyr::select(-second_gate), y = factor(data_rose_list[[1]]$second_gate), trials = 20, rules = TRUE),
#   C5.0(x = data_rose_list[[2]] %>% dplyr::select(-second_gate), y = factor(data_rose_list[[2]]$second_gate), trials = 20, rules = TRUE),
#   C5.0(x = data_rose_list[[3]] %>% dplyr::select(-second_gate), y = factor(data_rose_list[[3]]$second_gate), trials = 20, rules = TRUE),
#   C5.0(x = data_rose_list[[4]] %>% dplyr::select(-second_gate), y = factor(data_rose_list[[4]]$second_gate), trials = 20, rules = TRUE),
#   C5.0(x = data_rose_list[[5]] %>% dplyr::select(-second_gate), y = factor(data_rose_list[[5]]$second_gate), trials = 20, rules = TRUE)
# )

# tree_over_list <- purrr::map(seq_along(train_data_list), function(i) C5.0(x = data_balanced_over_list[[i]] %>% dplyr::select(-second_gate), y = factor(data_balanced_over_list[[i]]$second_gate), trials = 20, rules = TRUE))

#     tree_over_list <- list(
#   C5.0(x = data_balanced_over_list[[1]] %>% dplyr::select(-second_gate), y = factor(data_balanced_over_list[[1]]$second_gate), trials = 20, rules = TRUE),
#   C5.0(x = data_balanced_over_list[[2]] %>% dplyr::select(-second_gate), y = factor(data_balanced_over_list[[2]]$second_gate), trials = 20, rules = TRUE),
#   C5.0(x = data_balanced_over_list[[3]] %>% dplyr::select(-second_gate), y = factor(data_balanced_over_list[[3]]$second_gate), trials = 20, rules = TRUE),
#   C5.0(x = data_balanced_over_list[[4]] %>% dplyr::select(-second_gate), y = factor(data_balanced_over_list[[4]]$second_gate), trials = 20, rules = TRUE),
#   C5.0(x = data_balanced_over_list[[5]] %>% dplyr::select(-second_gate), y = factor(data_balanced_over_list[[5]]$second_gate), trials = 20, rules = TRUE)
# )

# tree_under_list <- purrr::map(seq_along(train_data_list), function(i) C5.0(x = data_balanced_under_list[[i]] %>% dplyr::select(-second_gate), y = factor(data_balanced_under_list[[i]]$second_gate), trials = 20, rules = TRUE))

# tree_under_list <- list(
#   C5.0(x = data_balanced_under_list[[1]] %>% dplyr::select(-second_gate), y = factor(data_balanced_under_list[[1]]$second_gate), trials = 20, rules = TRUE),
#   C5.0(x = data_balanced_under_list[[2]] %>% dplyr::select(-second_gate), y = factor(data_balanced_under_list[[2]]$second_gate), trials = 20, rules = TRUE),
#   C5.0(x = data_balanced_under_list[[3]] %>% dplyr::select(-second_gate), y = factor(data_balanced_under_list[[3]]$second_gate), trials = 20, rules = TRUE),
#   C5.0(x = data_balanced_under_list[[4]] %>% dplyr::select(-second_gate), y = factor(data_balanced_under_list[[4]]$second_gate), trials = 20, rules = TRUE),
#   C5.0(x = data_balanced_under_list[[5]] %>% dplyr::select(-second_gate), y = factor(data_balanced_under_list[[5]]$second_gate), trials = 20, rules = TRUE)
# )

tree_both_list <- purrr::map(seq_along(train_data_list), function(i) C5.0(x = data_balanced_both_list[[i]] %>% dplyr::select(-second_gate), y = factor(data_balanced_both_list[[i]]$second_gate), trials = 20, rules = TRUE))

# tree_rose_list <- list(
#   C5.0(x = data_balanced_both_list[[1]] %>% dplyr::select(-second_gate), y = factor(data_balanced_both_list[[1]]$second_gate), trials = 20, rules = TRUE),
#   C5.0(x = data_balanced_both_list[[2]] %>% dplyr::select(-second_gate), y = factor(data_balanced_both_list[[2]]$second_gate), trials = 20, rules = TRUE),
#   C5.0(x = data_balanced_both_list[[3]] %>% dplyr::select(-second_gate), y = factor(data_balanced_both_list[[3]]$second_gate), trials = 20, rules = TRUE),
#   C5.0(x = data_balanced_both_list[[4]] %>% dplyr::select(-second_gate), y = factor(data_balanced_both_list[[4]]$second_gate), trials = 20, rules = TRUE),
#   C5.0(x = data_balanced_both_list[[5]] %>% dplyr::select(-second_gate), y = factor(data_balanced_both_list[[5]]$second_gate), trials = 20, rules = TRUE)
# )

# make predictions on unseen data
pred_tree_rose_list <- purrr::map(seq_along(train_data_list), function(i) predict(tree_rose_list[[i]], newdata = test_data[[i]] %>% dplyr::select(-second_gate)))
# pred_tree_over_list <- purrr::map(seq_along(train_data_list), function(i) predict(tree_over_list[[i]], newdata = test_data[[i]] %>% dplyr::select(-second_gate)))
# pred_tree_under_list <- purrr::map(seq_along(train_data_list), function(i) predict(tree_under_list[[i]], newdata = test_data[[i]] %>% dplyr::select(-second_gate)))
pred_tree_both_list <- purrr::map(seq_along(train_data_list), function(i) predict(tree_both_list[[i]], newdata = test_data[[i]] %>% dplyr::select(-second_gate)))

# AUC ROSE
purrr::map(seq_along(train_data_list), function(i) roc.curve(test_data[[i]]$second_gate, pred_tree_rose_list[[i]], plot = TRUE))
# AUC Oversampling
# purrr::map(seq_along(train_data_list), function(i) roc.curve(test_data[[i]]$second_gate, pred_tree_over_list[[i]], plot = TRUE))
# AUC Undersampling
# purrr::map(seq_along(train_data_list), function(i) roc.curve(test_data[[i]]$second_gate, pred_tree_under_list[[i]], plot = TRUE))
# AUC Both
purrr::map(seq_along(train_data_list), function(i) roc.curve(test_data[[i]]$second_gate, pred_tree_both_list[[i]], plot = TRUE))
```

```{r}
library(randomForest)
doParallel::registerDoParallel(cores = 5)

# tree_rose_list <- purrr::map(seq_along(train_data_list), function(i) randomForest(x = data_rose_list[[i]] %>% dplyr::select(-second_gate), y = factor(data_rose_list[[i]]$second_gate), importance = TRUE))

tic()
rf_rose_list <- foreach(i = seq_along(train_data)) %dopar% randomForest(x = data_rose_list[[i]] %>% dplyr::select(-second_gate), y = factor(data_rose_list[[i]]$second_gate), importance = TRUE )
toc()

# tree_over_list <- purrr::map(seq_along(train_data_list), function(i) randomForest(x = data_balanced_over_list[[i]] %>% dplyr::select(-second_gate), y = factor(data_balanced_over_list[[i]]$second_gate), importance = TRUE))

# tic()
# rf_over_list <- foreach(i = seq_along(train_data)) %dopar% randomForest(x = data_balanced_over_list[[i]] %>% dplyr::select(-second_gate), y = factor(data_balanced_over_list[[i]]$second_gate), importance = TRUE)
# toc()

# tree_under_list <- purrr::map(seq_along(train_data_list), function(i) randomForest(x = data_balanced_under_list[[i]] %>% dplyr::select(-second_gate), y = factor(data_balanced_under_list[[i]]$second_gate), importance = TRUE))

# tic()
# rf_under_list <- foreach(i = seq_along(train_data)) %dopar% randomForest(x = data_balanced_under_list[[i]] %>% dplyr::select(-second_gate), y = factor(data_balanced_under_list[[i]]$second_gate), importance = TRUE)
# toc()

# tree_both_list <- purrr::map(seq_along(train_data_list), function(i) randomForest(x = data_balanced_both_list[[i]] %>% dplyr::select(-second_gate), y = factor(data_balanced_both_list[[i]]$second_gate), importance = TRUE))

tic()
rf_both_list <- foreach(i = seq_along(train_data)) %dopar% randomForest(x = data_balanced_both_list[[i]] %>% dplyr::select(-second_gate), y = factor(data_balanced_both_list[[i]]$second_gate), importance = TRUE)
toc()

# make predictions on unseen data
pred_rf_rose_list <- purrr::map(seq_along(train_data_list), function(i) predict(rf_rose_list[[i]], newdata = test_data[[i]] %>% dplyr::select(-second_gate)))
# pred_rf_over_list <- purrr::map(seq_along(train_data_list), function(i) predict(rf_over_list[[i]], newdata = test_data[[i]] %>% dplyr::select(-second_gate)))
# pred_rf_under_list <- purrr::map(seq_along(train_data_list), function(i) predict(rf_under_list[[i]], newdata = test_data[[i]] %>% dplyr::select(-second_gate)))
pred_rf_both_list <- purrr::map(seq_along(train_data_list), function(i) predict(rf_both_list[[i]], newdata = test_data[[i]] %>% dplyr::select(-second_gate)))

# AUC ROSE
purrr::map(seq_along(train_data_list), function(i) roc.curve(test_data[[i]]$second_gate, pred_rf_rose_list[[i]], plot = TRUE))
# AUC Oversampling
# purrr::map(seq_along(train_data_list), function(i) roc.curve(test_data[[i]]$second_gate, pred_rf_over_list[[i]], plot = TRUE))
# AUC Undersampling
# purrr::map(seq_along(train_data_list), function(i) roc.curve(test_data[[i]]$second_gate, pred_rf_under_list[[i]], plot = TRUE))
# AUC Both
purrr::map(seq_along(train_data_list), function(i) roc.curve(test_data[[i]]$second_gate, pred_rf_both_list[[i]], plot = TRUE))
```



```{r}
tic()
neater_results <- neater(dataset = train_data[[1]], newSamples = data_balanced_over, classAttr = "second_gate", iterations = 10)
toc()
```






```{r}
library(imbalance)
```





```{r}
# 99.497 sec elapsed
tic()
DN_new_pdfos <- DN_original %>% imbalance::pdfos(numInstances = mean_classes, classAttr = "second_gate")
toc()
```

```{r}
# 0.141 sec elapsed
tic()
DN_new_rwo <- DN_original %>% imbalance::rwo(numInstances = mean_classes, classAttr = "second_gate")
toc()
```

```{r}
tic()
DN_new_racog <- DN_original %>% imbalance::racog(numInstances = mean_classes, classAttr = "second_gate")
toc()
```


```{r}

```


```{r}
# 2340.303 sec elapsed
tic()
neater_results <- neater(dataset = DN_original, newSamples = DN_new_pdfos, classAttr = "second_gate", iterations = 10)
toc()
```

```{r}
oversample_cell_types <- function(df, n_instances, class_attr = "second_gate", ...){
  while((DN_original %>% group_by(second_gate) %>% tally() %>% dplyr::filter(second_gate %in% "DN ") %>% dplyr::select(n) %>% pull()) < n_instances){
    tic()
    df_new <- df %>% pdfos(numInstances = 1000, classAttr = class_attr) 
    df_filtered <- neater(dataset = df, newSamples = df_new, classAttr = class_attr, iterations = 10)
    toc()
  }
  return(df_filtered)
}

tic()
df_new <- DN_original %>% oversample_cell_types(n_instances = mean_classes, class_attr = "second_gate")
toc()

DN_original %>% pdfos(numInstances = mean_classes, classAttr = "second_gate") %>% neater(dataset = DN_original, newSamples = DN_new_pdfos, classAttr = "second_gate", iterations = 10)
```


```{r}
tic()
new_DN <- DN_original %>% oversample(ratio =  1, classAttr = "second_gate", method = "RWO")
toc()
```


RWO - Random Walk Oversampling
```{r}
# tic()
# new_DN <- DN_original %>% oversample(ratio =  1, classAttr = "second_gate", method = "RWO")
# toc()

tic()
DN_new <- DN_original %>% rwo(numInstances = reference - gdTCR_total, classAttr = "second_gate")
toc()

tic()
neater_results <- neater(dataset = DN_original, newSamples = DN_new, classAttr = "second_gate", iterations = 10)
toc()

comparison_plot <- plotComparison(dataset = DN_original, anotherDataset = neater_results, classAttr = "second_gate", cols = 6, attrs = colnames(DN_original)[1:18])

purrr::map(1:18, function(i) ks.test(x = facs_data_df_step_2[[i]], y = new_DN[[i]])) %>% purrr::map(tidy) %>% bind_rows()
```



```{r}
tic()
new_gdTCR <- facs_data_df_step_2 %>% dplyr::filter(second_gate %in% c("Th_CD4+_cells", "gdTCR_cells")) %>% pdfos(numInstances = reference - gdTCR_total, classAttr = "second_gate")
toc()
```

```{r}
toc()
new_NK <- facs_data_df_step_2 %>% dplyr::filter(second_gate %in% c("Th_CD4+_cells", "NK_cells")) %>% pdfos(numInstances = reference - NK_total, classAttr = "second_gate")
toc()
```

```{r}
tic()
new_NK <- facs_data_df_step_2 %>% dplyr::filter(second_gate %in% c("Th_CD4+_cells", "CD4-NKT_cells")) %>% pdfos(numInstances = reference - CD4_neg_NKT_total, classAttr = "second_gate")
toc()
```









# cell types test data
```{r}
cell_types_test <- c(files_to_load_names_3) %>% 
  str_remove(pattern = ".fcs") %>% 
  str_remove(pattern = "export_Specimen_..._c....._..._..._")

facs_test_data_df <- test_diff_som %>% build_fcs_data_df(cell_types = cell_types_test)

facs_test_data_df <- facs_test_data_df %>% 
  mutate(first_gate = case_when(!(cell_type %in% c("clog+", "clog-_cells-", "S1-", "S2-", "dead")) ~ "live"))
  
facs_test_data_df <- facs_test_data_df %>% 
  mutate(first_gate = if_else(is.na(first_gate), true = "not_live", false = first_gate))
```

# Split data for Cross-validation
```{r}
first_gate_table <- table(facs_data_df$first_gate)

# sort data
reseed()
facs_data_df <- facs_data_df %>% dplyr::slice(sample(nrow(facs_data_df)))

# balance data
reseed()
facs_data_subset_df <- facs_data_df %>% split(f = .$first_gate) %>% purrr::map(dplyr::slice, sample(120000)) %>% bind_rows()

# sort data
reseed()
facs_data_subset_df <- facs_data_subset_df %>% dplyr::slice(sample(nrow(facs_data_subset_df)))

k_fold <- 5

# Create 5 equally size folds
reseed()
folds <- cut(x = seq(1, nrow(facs_data_subset_df)), breaks = k_fold, labels = FALSE)
# Perform 10 fold cross validation
# Segement your data by fold using the which() function
test_indices <- purrr::map(seq_len(k_fold), function(i) which(folds == i, arr.ind = TRUE))

# Use the test and train data partitions however you desire...
test_data <- purrr::map(seq_len(k_fold), function(i) facs_data_subset_df[test_indices[[i]], ]) %>% purrr::set_names(paste0("test_", 1:k_fold))
train_data <- purrr::map(seq_len(k_fold), function(i) facs_data_subset_df[-test_indices[[i]], ]) %>% purrr::set_names(paste0("train_", 1:k_fold))
  
train_data_list <- purrr::map(seq_len(k_fold), function(i) list(measurements = train_data[[i]] %>% dplyr::select(-cell_type) %>% as.matrix(), classes_col = train_data[[i]] %>% dplyr::select(cell_type) %>% unlist()))
  
test_data_list <- purrr::map(seq_len(k_fold), function(i) list(measurements = test_data[[i]] %>% dplyr::select(-c(cell_type, first_gate)) %>% as.matrix(), classes_col = test_data[[i]] %>% dplyr::select(first_gate) %>% unlist()))
```


```{r}
diff_som_1$fs$data <- facs_data_subset_df %>% as.matrix()

k_fold <- 5

# Create 5 equally size folds
reseed()
folds <- cut(x = seq(1, nrow(diff_som_1$fs$data)), breaks = k_fold, labels = FALSE)
# Perform 10 fold cross validation
# Segement your data by fold using the which() function
test_indices <- purrr::map(seq_len(k_fold), function(i) which(folds == i, arr.ind = TRUE))

# Use the test and train data partitions however you desire...
test_data <- purrr::map(seq_len(k_fold), function(i) diff_som_1$fs$data[test_indices[[i]], ])
train_data <- purrr::map(seq_len(k_fold), function(i) diff_som_1$fs$data[-test_indices[[i]], ])

diff_som_1_test <- list(test_1 = diff_som_1,
                        test_2 = diff_som_1,
                        test_3 = diff_som_1,
                        test_4 = diff_som_1,
                        test_5 = diff_som_1)

diff_som_1_test[[1]]$fs$data <- diff_som_1_test[[1]]$fs$data %>% as.data.frame() %>% dplyr::slice(test_indices[[1]]) %>% dplyr::select(-c("cell_type", "first_gate")) %>% as.matrix() %>% apply(MARGIN = c(2), as.numeric)
diff_som_1_test[[2]]$fs$data <- diff_som_1_test[[2]]$fs$data %>% as.data.frame() %>% dplyr::slice(test_indices[[2]]) %>% dplyr::select(-c("cell_type", "first_gate")) %>% as.matrix() %>% apply(MARGIN = c(2), as.numeric)
diff_som_1_test[[3]]$fs$data <- diff_som_1_test[[3]]$fs$data %>% as.data.frame() %>% dplyr::slice(test_indices[[3]]) %>% dplyr::select(-c("cell_type", "first_gate")) %>% as.matrix() %>% apply(MARGIN = c(2), as.numeric)
diff_som_1_test[[4]]$fs$data <- diff_som_1_test[[4]]$fs$data %>% as.data.frame() %>% dplyr::slice(test_indices[[4]]) %>% dplyr::select(-c("cell_type", "first_gate")) %>% as.matrix() %>% apply(MARGIN = c(2), as.numeric)
diff_som_1_test[[5]]$fs$data <- diff_som_1_test[[5]]$fs$data %>% as.data.frame() %>% dplyr::slice(test_indices[[5]]) %>% dplyr::select(-c("cell_type", "first_gate")) %>% as.matrix() %>% apply(MARGIN = c(2), as.numeric)

# purrr::map(seq_len(k_fold), function(i) diff_som_1_test[[i]]$fs$data = diff_som_1_test[[i]]$fs$data %>% as.data.frame() %>% dplyr::slice(test_indices[[i]]) %>% as.matrix() )


diff_som_1_train <- list(train_1 = diff_som_1,
                        train_2 = diff_som_1,
                        train_3 = diff_som_1,
                        train_4 = diff_som_1,
                        train_5 = diff_som_1)

diff_som_1_train[[1]]$fs$data <- diff_som_1_train[[1]]$fs$data %>% as.data.frame() %>% dplyr::slice(-test_indices[[1]]) %>% dplyr::select(-c("cell_type", "first_gate")) %>% as.matrix() %>% apply(MARGIN = c(2), as.numeric)
diff_som_1_train[[2]]$fs$data <- diff_som_1_train[[2]]$fs$data %>% as.data.frame() %>% dplyr::slice(-test_indices[[2]]) %>% dplyr::select(-c("cell_type", "first_gate")) %>% as.matrix() %>% apply(MARGIN = c(2), as.numeric)
diff_som_1_train[[3]]$fs$data <- diff_som_1_train[[3]]$fs$data %>% as.data.frame() %>% dplyr::slice(-test_indices[[3]]) %>% dplyr::select(-c("cell_type", "first_gate")) %>% as.matrix() %>% apply(MARGIN = c(2), as.numeric)
diff_som_1_train[[4]]$fs$data <- diff_som_1_train[[4]]$fs$data %>% as.data.frame() %>% dplyr::slice(-test_indices[[4]]) %>% dplyr::select(-c("cell_type", "first_gate")) %>% as.matrix() %>% apply(MARGIN = c(2), as.numeric)
diff_som_1_train[[5]]$fs$data <- diff_som_1_train[[5]]$fs$data %>% as.data.frame() %>% dplyr::slice(-test_indices[[5]]) %>% dplyr::select(-c("cell_type", "first_gate")) %>% as.matrix() %>% apply(MARGIN = c(2), as.numeric)

# purrr::map(seq_len(k_fold), function(i) diff_som_1_train[[i]]$fs$data = diff_som_1_train[[i]]$fs$data[-test_indices[[i]], ])

# train_data_list <- purrr::map(seq_len(k_fold), function(i) list(measurements = train_data[[i]] %>% dplyr::select(-cell_type) %>% as.matrix(), classes_col = train_data[[i]] %>% dplyr::select(cell_type) %>% unlist()))

# test_data_list <- purrr::map(seq_len(k_fold), function(i) list(measurements = test_data[[i]] %>% dplyr::select(-cell_type) %>% as.matrix(), classes_col = test_data[[i]] %>% dplyr::select(cell_type) %>% unlist()))
```

```{r}
# process_C5 <- function(input = facs_data_df, n_clusters, ...){
process_C5 <- function(df, features, ...){  
  library(tidyverse, warn.conflicts = FALSE)
  library(caret, warn.conflicts = FALSE)
  library(C50, warn.conflicts = FALSE)
  # library(doParallel, warn.conflicts = FALSE)
  # EmbedSOM_results_df_all = process_step_1_output$EmbedSOM_results_df_all
  # EmbedSOM_results_df = process_step_1_output$EmbedSOM_results_df
  # facs_data_df = process_step_1_output$facs_data_df
  # 
  # features_all_from_SOM <- EmbedSOM_results_df_all %>% dplyr::select(dplyr::contains(".y"))
  # features_selected_from_SOM <- df %>% dplyr::select(dplyr::contains(".y"))
  # 
  
  df <- df %>% as.data.frame()
  
  features_df <- df %>% 
    dplyr::select(-c(first_gate, cell_type)) %>% 
    dplyr::select(features) %>% 
    apply(FUN = as.numeric, MARGIN = c(2)) %>% 
    as.data.frame()
  
  # features_selected_no_SOM <- df %>% dplyr::select(-c(first_gate, cell_type)) %>% dplyr::select(c(FSC.A, SSC.A, FSC.H, SSC.W, Indo.1..Violet..A))
  
  classes <- df$first_gate %>% factor()
  
  # rules_model_selected
  # rules_model <- C5.0(x = features_df, y = classes, trials = 20, rules = TRUE)
  # tree_model <- C5.0(x = features_df, y = classes, trials = 20, rules = FALSE)
  
  # rules_model_all
  rules_model <- C5.0(x = features_df, y = classes, trials = 20, rules = TRUE)
  # tree_model <- C5.0(x = features_df, y = classes, trials = 20, rules = FALSE)
  
  # rules_model_from_SOM
  # rules_model <- C5.0(x = features_selected_from_SOM, y = classes, trials = 1, rules = TRUE)
  # tree_model <- C5.0(x = features_selected_from_SOM, y = classes, trials = 1, rules = FALSE)
  
  # tree_model_from_SOM_all_features
  # tree_model <- C5.0(x = features_all_from_SOM, y = classes, trials = 1, rules = FALSE)
  # rules_model <- C5.0(x = features_all_from_SOM, y = classes, trials = 1, rules = TRUE)

    return(rules_model)
}


df_1 <- train_data[[1]] %>% 
  as.data.frame() %>% 
  dplyr::select(-c(first_gate, cell_type)) %>% 
  dplyr::select(c(1:18)) %>% 
  apply(FUN = as.numeric, MARGIN = c(2)) %>% 
  as.data.frame()
```

# No SOM - use data directly
```{r}
registerDoParallel(cores = 5)

# 1945.741 sec elapsed
tic()
rules_models <- foreach(i = seq_along(train_data)) %dopar% process_C5(df = train_data[[i]], features = c(1:18))
toc()

# tic()
# rules_models <- train_data %>% purrr::map(function(x) x %>% process_C5(features = c(1:18)))
# toc()

# 66784.289 sec elapsed
# tic()
# rules_models <- train_data %>% purrr::map(function(x) x %>% process_C5())
# toc()
# rules_models %>% saveRDS(file = "~/Downloads/rules_models_2020_06_09.rds")
```

# save

```{r}
summary(rules_models[[3]])

rules_models_results <- rules_models %>% purrr::map(summary) %>%  purrr::map(capture.output)

purrr::map(seq_along(rules_models_results), function(i) rules_models_results[[i]] %>% cat(file = paste0("~/Downloads/rules_models_results_", i, ".txt")))
```


Validate
```{r}
# 48.722 sec elapsed
tic()
predictions_validation <- purrr::map(seq_along(rules_models_results), function(i) predict(rules_models[[i]], newdata = test_data_list[[i]]$measurements))
toc()
```

# Confusion matrix
```{r}
confusion_matrix_results <- purrr::map(seq_along(predictions_validation), function(i) caret::confusionMatrix(predictions_validation[[i]], test_data_list[[i]]$classes_col %>% factor()))

mean_accuracy <- confusion_matrix_results %>% purrr::map(function(x) x %>% .[["overall"]] %>% .["Accuracy"]) %>% unlist() %>% mean()

sd_accuracy <- confusion_matrix_results %>% purrr::map(function(x) x %>% .[["overall"]] %>% .["Accuracy"]) %>% unlist() %>% sd()

mean_kappa <- confusion_matrix_results %>% purrr::map(function(x) x %>% .[["overall"]] %>% .["Kappa"]) %>% unlist() %>% mean()
```

# Test if cross-validation really works with new data
```{r}
test_df <- facs_test_data_df %>% dplyr::select(-c(cell_type, first_gate))

test_results <- purrr::map(seq_along(rules_models_results), function(i) predict(rules_models[[i]], newdata = test_df))

confusion_matrix_test_results <- purrr::map(seq_along(test_results), function(i) caret::confusionMatrix(test_results[[i]], facs_test_data_df$first_gate %>% factor()))

confusion_matrix_test_results %>% purrr::map(function(x) x %>% .[["overall"]] %>% .["Accuracy"]) %>% unlist() %>% mean()
confusion_matrix_test_results %>% purrr::map(function(x) x %>% .[["overall"]] %>% .["Kappa"]) %>% unlist() %>% mean()
```





# No SOM - Selected features
```{r}
registerDoParallel(cores = 5)

# 184.415 sec elapsed
tic()
rules_models_selected_features <- foreach(i = seq_along(train_data)) %dopar% process_C5(df = train_data[[i]], features = c("FSC.A", "SSC.A", "FSC.H", "SSC.W", "Indo.1..Violet..A"))
toc()

# 67283.483 sec elapsed
# tic()
# rules_models_selected_features <- train_data %>% purrr::map(dplyr::select, c(FSC.A, SSC.A, FSC.H, SSC.W, Indo.1..Violet..A)) %>% purrr::map(function(x) x %>% process_C5(n_clusters = 6))
# toc()

# rules_models_selected_features %>% saveRDS(file = "~/Downloads/rules_models_selected_features_results_2020_06_10.rds")
```

```{r}
rules_models_selected_features_results <- rules_models_selected_features %>% purrr::map(summary) %>%  purrr::map(capture.output)

purrr::map(seq_along(rules_models_selected_features_results), function(i) rules_models_selected_features_results[[i]] %>% cat(file = paste0("~/Downloads/rules_models_selected_features_results_", i, ".txt")))
```

# Validate
```{r}
# 12.661 sec elapsed
tic()
selected_features_predictions_validation <- purrr::map(seq_along(rules_models_selected_features_results), function(i) predict(rules_models_selected_features[[i]], newdata = test_data_list[[i]]$measurements))
toc()
```

# Confusion matrix
```{r}
confusion_matrix_selected_features_results <- purrr::map(seq_along(selected_features_predictions_validation), function(i) caret::confusionMatrix(selected_features_predictions_validation[[i]], test_data_list[[i]]$classes_col %>% factor()))

mean_selected_features_accuracy <- confusion_matrix_selected_features_results %>% purrr::map(function(x) x %>% .[["overall"]] %>% .["Accuracy"]) %>% unlist() %>% mean()

sd_selected_features_accuracy <- confusion_matrix_selected_features_results %>% purrr::map(function(x) x %>% .[["overall"]] %>% .["Accuracy"]) %>% unlist() %>% sd()

confusion_matrix_selected_features_results %>% purrr::map(function(x) x %>% .[["overall"]] %>% .["Kappa"]) %>% unlist() %>% mean()
```

# Test if cross-validation really works with new data
```{r}
test_df <- facs_test_data_df %>% dplyr::select(-c(cell_type, first_gate))

test_selected_features_results <- purrr::map(seq_along(rules_models_results), function(i) predict(rules_models_selected_features[[i]], newdata = test_df))

confusion_matrix_test_selected_features_results <- purrr::map(seq_along(test_selected_features_results), function(i) caret::confusionMatrix(test_selected_features_results[[i]], facs_test_data_df$first_gate %>% factor()))

confusion_matrix_test_selected_features_results %>% purrr::map(function(x) x %>% .[["overall"]] %>% .["Accuracy"]) %>% unlist() %>% mean()

confusion_matrix_test_selected_features_results %>% purrr::map(function(x) x %>% .[["overall"]] %>% .["Kappa"]) %>% unlist() %>% mean()
```












```{r}
# diff_som <- diff_som_1_train[[1]]

perform_SOM <- function(diff_som, facs_data_df, columns_to_use = c("FSC.A", "FSC.H", "SSC.A", "SSC.W", "Indo.1..Violet..A"), importance = c(1, 1, 1, 1, 1), normalize_weights = TRUE) {

  scale_to_range_0_1 <- function(x, ...){(x - min(x, ...)) / (max(x, ...) - min(x, ...))}
  
  diff_som = diff_som
  
  # calculate optimal grid
  vesanto_dim <- diff_som$fs$data %>%
    nrow() %>%
    sqrt() %>%
    "*"(5)
  
  grid_dim <- vesanto_dim %>%
    sqrt() %>%
    ceiling() %>%
    "+"(20)

  # SOM
  reseed()
  ds_step_1 <- diff_som %>% Embed(xdim = grid_dim, ydim = grid_dim, colsToUse = columns_to_use, importance = importance, nclust = grid_dim * grid_dim, rlen = 5)

  # Optional to normalize weights
  if (normalize_weights) {
    ds_step_1$map$codes <- purrr::map(seq_len(ncol(ds_step_1$map$codes)), function(i) {ds_step_1$map$codes[, i] %>% bestNormalize::orderNorm() %>% .[["x.t"]] %>% scale_to_range_0_1()}) %>% purrr::set_names(colnames(ds_step_1$map$codes)) %>% bind_cols()
  }

  grid_clustering_df <- ds_step_1$map$grid %>%
    as.data.frame() %>%
    rownames_to_column() %>%
    mutate(cluster = ds_step_1$clust) %>%
    mutate(rowname = rowname %>% as.numeric()) %>%
    bind_cols(as.data.frame(ds_step_1$map$codes))

  EmbedSOM_results_df <- ds_step_1$fs$data %>%
    as.data.frame() %>%
    mutate(mapping = ds_step_1$map$mapping[, 1]) %>%
    left_join(grid_clustering_df, by = c("mapping" = "rowname")) %>%
    mutate(first_gate = facs_data_df$first_gate)

  output <- list(EmbedSOM_results_df = EmbedSOM_results_df,
                 diff_som = ds_step_1)
  
  return(output)
}

```


# SOM - Selected features
```{r}
registerDoParallel(cores = 5)
# 175.813 sec elapsed - serial
tic()
# EmbedSOM_results_train <- purrr::map(seq_along(diff_som_1_train), function(i) perform_SOM(diff_som = diff_som_1_train[[i]], facs_data_subset_df[-test_indices[[i]], ], columns_to_use = c("FSC.A", "FSC.H", "SSC.A", "SSC.W", "Indo.1..Violet..A"), importance = c(1, 1, 1, 1, 1), normalize_weights = TRUE))
EmbedSOM_results_train <- purrr::map(seq_along(diff_som_1_train), function(i) perform_SOM(diff_som = diff_som_1_train[[i]], facs_data_subset_df[-test_indices[[i]], ], columns_to_use = c("FSC.A", "FSC.H", "SSC.A", "SSC.W", "Indo.1..Violet..A"), importance = c(1, 1, 1, 1, 1), normalize_weights = FALSE))
toc()

# 40.863 sec elapsed
tic()
# EmbedSOM_results_test <- purrr::map(seq_along(diff_som_1_test), function(i) perform_SOM(diff_som = diff_som_1_test[[i]], facs_data_subset_df[test_indices[[i]], ], columns_to_use = c("FSC.A", "FSC.H", "SSC.A", "SSC.W", "Indo.1..Violet..A"), importance = c(1, 1, 1, 1, 1), normalize_weights = TRUE))
EmbedSOM_results_test <- purrr::map(seq_along(diff_som_1_test), function(i) perform_SOM(diff_som = diff_som_1_test[[i]], facs_data_subset_df[test_indices[[i]], ], columns_to_use = c("FSC.A", "FSC.H", "SSC.A", "SSC.W", "Indo.1..Violet..A"), importance = c(1, 1, 1, 1, 1), normalize_weights = FALSE))
toc()
```

# C5.0 on SOM
```{r}
process_C5_from_SOM <- function(df, features, ...){  
  library(tidyverse, warn.conflicts = FALSE)
  library(caret, warn.conflicts = FALSE)
  library(C50, warn.conflicts = FALSE)
  # EmbedSOM_results_df_all = process_step_1_output$EmbedSOM_results_df_all
  # EmbedSOM_results_df = process_step_1_output$EmbedSOM_results_df
  # facs_data_df = process_step_1_output$facs_data_df
  # 
  # features_all_from_SOM <- EmbedSOM_results_df_all %>% dplyr::select(dplyr::contains(".y"))
  weights_df <- df %>% dplyr::select(features)
  # 
  # features_all_no_SOM <- facs_data_df %>% dplyr::select(-c(first_gate, cell_type))
  # features_selected_no_SOM <- facs_data_df %>% dplyr::select(-c(first_gate, cell_type)) %>% dplyr::select(c(FSC.A, SSC.A, FSC.H, SSC.W, Indo.1..Violet..A))
  
  classes <- df$first_gate %>% factor()

  # rules_model_selected
  # rules_model <- C5.0(x = features_df, y = classes, trials = 20, rules = TRUE)
  # tree_model <- C5.0(x = features_df, y = classes, trials = 20, rules = FALSE)
  
  # rules_model_all
  # rules_model <- C5.0(x = features_df, y = classes, trials = 20, rules = TRUE)
  # tree_model <- C5.0(x = features_df, y = classes, trials = 20, rules = FALSE)
  
  # rules_model_from_SOM
  rules_model <- C5.0(x = weights_df, y = classes, trials = 1, rules = TRUE)
  # tree_model <- C5.0(x = weights_df, y = classes, trials = 1, rules = FALSE)
  
  # tree_model_from_SOM_all_features
  # tree_model <- C5.0(x = weights_df, y = classes, trials = 1, rules = FALSE)
  # rules_model <- C5.0(x = weights_df, y = classes, trials = 1, rules = TRUE)
  return(rules_model)
}
```

```{r}
# 78.039 sec elapsed - serial
tic()
# rules_models_SOM_selected_features <- EmbedSOM_results_train %>% purrr::map(function(x) x %>% .[["EmbedSOM_results_df"]] %>% process_C5(dplyr::contains(".y")))
# rules_models_SOM_selected_features <- EmbedSOM_results_train %>% purrr::map(function(x) x %>% .[["diff_som"]] %>% .[["map"]] %>% .[["codes"]] %>% process_C5(n_clusters = 6))
# rules_models_SOM_selected_features <- purrr::map(seq_along(EmbedSOM_results_train), function(i) EmbedSOM_results_train[[i]]$EmbedSOM_results_df %>% process_C5(n_clusters = 6))

rules_models_SOM_selected_features <- foreach(i = seq_along(EmbedSOM_results_train)) %dopar% process_C5_from_SOM(df = EmbedSOM_results_train[[i]]$EmbedSOM_results_df, features = dplyr::contains(".y"))
toc()

# EmbedSOM_results_train[[1]]$diff_som$map$codes
# EmbedSOM_results_train[[1]]$EmbedSOM_results_df

# rules_models_SOM_selected_features %>% saveRDS(file = "~/Downloads/rules_models_SOM_selected_features.rds")
```

# Validate
```{r}
# 2.862 sec elapsed
tic()
selected_features_SOM_predictions_validation <- purrr::map(seq_along(rules_models_SOM_selected_features), function(i) predict(rules_models_SOM_selected_features[[i]], newdata = EmbedSOM_results_test[[i]]$EmbedSOM_results_df %>% dplyr::select(dplyr::contains(".y"))))
toc()
```

# Confusion matrix
```{r}
confusion_matrix_selected_features_SOM_results <- purrr::map(seq_along(selected_features_SOM_predictions_validation), function(i) caret::confusionMatrix(selected_features_SOM_predictions_validation[[i]], EmbedSOM_results_test[[i]]$EmbedSOM_results_df$first_gate %>% factor()))

mean_selected_features_SOM_accuracy <- confusion_matrix_selected_features_SOM_results %>% purrr::map(function(x) x %>% .[["overall"]] %>% .["Accuracy"]) %>% unlist() %>% mean()

sd_selected_features_SOM_accuracy <- confusion_matrix_selected_features_SOM_results %>% purrr::map(function(x) x %>% .[["overall"]] %>% .["Accuracy"]) %>% unlist() %>% sd()

mean_selected_features_SOM_kappa <- confusion_matrix_selected_features_SOM_results %>% purrr::map(function(x) x %>% .[["overall"]] %>% .["Kappa"]) %>% unlist() %>% mean()
```

# Test if cross-validation really works with new data
```{r}
# facs_test_data_df
# test_diff_som

# test_diff_som$fs$data <- test_diff_som$fs$data %>% as.data.frame() %>% dplyr::select(-c("cell_type", "first_gate")) %>% as.matrix() %>% apply(MARGIN = c(2), as.numeric)

test_diff_som$fs$data <- test_diff_som$fs$data %>% 
  as.data.frame() %>% 
  purrr::set_names(str_remove(string = colnames(test_diff_som$fs$data), pattern = "FJComp.")) %>% 
  as.matrix()

test_df <- facs_test_data_df %>% dplyr::select(-c(cell_type, first_gate))

EmbedSOM_results_testing <- perform_SOM(diff_som = test_diff_som, facs_data_df = facs_test_data_df, columns_to_use = c("FSC.A", "FSC.H", "SSC.A", "SSC.W", "Indo.1..Violet..A"), importance = c(1, 1, 1, 1, 1), normalize_weights = TRUE)

test_selected_features_SOM_results <- purrr::map(seq_along(rules_models_SOM_selected_features), function(i) predict(rules_models_SOM_selected_features[[i]], newdata = EmbedSOM_results_testing$EmbedSOM_results_df %>% dplyr::select(dplyr::contains(".y"))))

confusion_matrix_test_selected_SOM_features_results <- purrr::map(seq_along(test_selected_features_SOM_results), function(i) caret::confusionMatrix(test_selected_features_SOM_results[[i]], facs_test_data_df$first_gate %>% factor()))

confusion_matrix_test_selected_SOM_features_results %>% purrr::map(function(x) x %>% .[["overall"]] %>% .["Accuracy"]) %>% unlist() %>% mean()

confusion_matrix_test_selected_SOM_features_results %>% purrr::map(function(x) x %>% .[["overall"]] %>% .["Kappa"]) %>% unlist() %>% mean()
```








# SOM - all features
```{r}
# 344.531 sec elapsed
# 360.017 sec elapsed
tic()
# EmbedSOM_all_features_results_train <- purrr::map(seq_along(diff_som_1_train), function(i) perform_SOM(diff_som = diff_som_1_train[[i]], facs_data_subset_df[-test_indices[[i]], ], columns_to_use = c(1:18), importance = rep(1, 18), normalize_weights = TRUE))
EmbedSOM_all_features_results_train <- purrr::map(seq_along(diff_som_1_train), function(i) perform_SOM(diff_som = diff_som_1_train[[i]], facs_data_subset_df[-test_indices[[i]], ], columns_to_use = c(1:18), importance = rep(1, 18), normalize_weights = FALSE))
toc()

# 65.526 sec elapsed
# 67.667 sec elapsed
tic()
# EmbedSOM_all_features_results_test <- purrr::map(seq_along(diff_som_1_test), function(i) perform_SOM(diff_som = diff_som_1_test[[i]], facs_data_subset_df[test_indices[[i]], ], columns_to_use = c(1:18), importance = rep(1, 18), normalize_weights = TRUE))
EmbedSOM_all_features_results_test <- purrr::map(seq_along(diff_som_1_test), function(i) perform_SOM(diff_som = diff_som_1_test[[i]], facs_data_subset_df[test_indices[[i]], ], columns_to_use = c(1:18), importance = rep(1, 18), normalize_weights = FALSE))
toc()
```

# C5.0 on SOM
```{r}
registerDoParallel(cores = 5)
# 104.557 sec elapsed
tic()
rules_models_SOM_all_features <- EmbedSOM_all_features_results_train %>% purrr::map(function(x) x %>% .[["EmbedSOM_results_df"]] %>% process_C5_from_SOM(features = dplyr::contains(".y")))

# rules_models_SOM_all_features <- foreach(i = seq_along(EmbedSOM_all_features_results_train)) %dopar% process_C5_from_SOM(df = EmbedSOM_all_features_results_train[[i]]$EmbedSOM_results_df, features = dplyr::contains(".y"))
toc()

# EmbedSOM_results_train[[1]]$diff_som$map$codes
# EmbedSOM_results_train[[1]]$EmbedSOM_results_df

# rules_models_SOM_all_features %>% saveRDS(file = "~/Downloads/rules_models_SOM_all_features.rds")
```


# Validate
```{r}
# 8.65 sec elapsed
tic()
all_features_SOM_predictions_validation <- purrr::map(seq_along(rules_models_SOM_all_features), function(i) predict(rules_models_SOM_all_features[[i]], newdata = EmbedSOM_all_features_results_test[[i]]$EmbedSOM_results_df %>% dplyr::select(dplyr::contains(".y"))))
toc()
```

# Confusion matrix
```{r}
confusion_matrix_all_features_SOM_results <- purrr::map(seq_along(all_features_SOM_predictions_validation), function(i) caret::confusionMatrix(all_features_SOM_predictions_validation[[i]], EmbedSOM_all_features_results_test[[i]]$EmbedSOM_results_df$first_gate %>% factor()))

mean_all_features_SOM_accuracy <- confusion_matrix_all_features_SOM_results %>% purrr::map(function(x) x %>% .[["overall"]] %>% .["Accuracy"]) %>% unlist() %>% mean()

sd_all_features_SOM_accuracy <- confusion_matrix_all_features_SOM_results %>% purrr::map(function(x) x %>% .[["overall"]] %>% .["Accuracy"]) %>% unlist() %>% sd()

mean_all_features_SOM_kappa <- confusion_matrix_all_features_SOM_results %>% purrr::map(function(x) x %>% .[["overall"]] %>% .["Kappa"]) %>% unlist() %>% mean()
```

# Test if cross-validation really works with new data
```{r}
# facs_test_data_df
# test_diff_som

# test_diff_som$fs$data <- test_diff_som$fs$data %>% as.data.frame() %>% dplyr::select(-c("cell_type", "first_gate")) %>% as.matrix() %>% apply(MARGIN = c(2), as.numeric)

test_diff_som$fs$data <- test_diff_som$fs$data %>% 
  as.data.frame() %>% 
  purrr::set_names(str_remove(string = colnames(test_diff_som$fs$data), pattern = "FJComp.")) %>% 
  as.matrix()

test_df <- facs_test_data_df %>% dplyr::select(-c(cell_type, first_gate))

EmbedSOM_all_features_results_testing <- perform_SOM(diff_som = test_diff_som, facs_data_df = facs_test_data_df, columns_to_use = c(1:18), importance = rep(1, 18), normalize_weights = FALSE)

test_all_features_SOM_results <- purrr::map(seq_along(rules_models_SOM_all_features), function(i) predict(rules_models_SOM_all_features[[i]], newdata = EmbedSOM_all_features_results_testing$EmbedSOM_results_df %>% dplyr::select(dplyr::contains(".y"))))

confusion_matrix_test_all_SOM_features_results <- purrr::map(seq_along(test_all_features_SOM_results), function(i) caret::confusionMatrix(test_all_features_SOM_results[[i]], facs_test_data_df$first_gate %>% factor()))






mean_selected_all_features_SOM_accuracy <- confusion_matrix_test_all_SOM_features_results %>% purrr::map(function(x) x %>% .[["overall"]] %>% .["Accuracy"]) %>% unlist() %>% mean()

sd_selected_all_features_SOM_accuracy <- confusion_matrix_test_all_SOM_features_results %>% purrr::map(function(x) x %>% .[["overall"]] %>% .["Accuracy"]) %>% unlist() %>% sd()

mean_selected_all_features_SOM_kappa <- confusion_matrix_test_all_SOM_features_results %>% purrr::map(function(x) x %>% .[["overall"]] %>% .["Kappa"]) %>% unlist() %>% mean()
```




# SOM - Selected features was selected for Step 1
```{r}
diff_som_1$fs$data <- diff_som_1$fs$data %>% as.data.frame() %>% dplyr::select(-c("cell_type", "first_gate")) %>% as.matrix() %>% apply(MARGIN = c(2), as.numeric)

tic()
# EmbedSOM_results_train <- purrr::map(seq_along(diff_som_1_train), function(i) perform_SOM(diff_som = diff_som_1_train[[i]], facs_data_subset_df[-test_indices[[i]], ], columns_to_use = c("FSC.A", "FSC.H", "SSC.A", "SSC.W", "Indo.1..Violet..A"), importance = c(1, 1, 1, 1, 1), normalize_weights = TRUE))
EmbedSOM_results_step_1 <- perform_SOM(diff_som = diff_som_1, facs_data_subset_df, columns_to_use = c("FSC.A", "FSC.H", "SSC.A", "SSC.W", "Indo.1..Violet..A"), importance = c(1, 1, 1, 1, 1), normalize_weights = FALSE)
toc()

tic()
rules_model <- process_C5_from_SOM(df = EmbedSOM_results_step_1$EmbedSOM_results_df, features = dplyr::contains(".y"))
toc()

test_diff_som$fs$data <- test_diff_som$fs$data %>% 
  as.data.frame() %>% 
  purrr::set_names(str_remove(string = colnames(test_diff_som$fs$data), pattern = "FJComp.")) %>% 
  as.matrix()

test_df <- facs_test_data_df %>% dplyr::select(-c(cell_type, first_gate))

EmbedSOM_results_testing <- perform_SOM(diff_som = test_diff_som, facs_data_df = facs_test_data_df, columns_to_use = c("FSC.A", "FSC.H", "SSC.A", "SSC.W", "Indo.1..Violet..A"), importance = c(1, 1, 1, 1, 1), normalize_weights = TRUE)

test_rules_model <- predict(rules_model, newdata = EmbedSOM_results_testing$EmbedSOM_results_df %>% dplyr::select(dplyr::contains(".y")))

confusion_matrix <- caret::confusionMatrix(test_rules_model, facs_test_data_df$first_gate %>% factor())

confusion_matrix %>% .[["overall"]] %>% .["Accuracy"]

confusion_matrix %>% .[["overall"]] %>% .["Kappa"]
```


