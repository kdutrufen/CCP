---
title: "Automated_immunology_analysis_Rules_step_4"
author: "Carlos Eduardo Madureira Trufen"
date: "8/25/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## R Markdown

# Load libraries
```{r, message=FALSE, warning=FALSE, cache=TRUE}
library(bestNormalize, warn.conflicts = FALSE)
library(C50, warn.conflicts = FALSE)
library(caret, warn.conflicts = FALSE)
library(corrplot, warn.conflicts = FALSE)
library(Ckmeans.1d.dp, warn.conflicts = FALSE)
library(clusterCrit, warn.conflicts = FALSE)
library(CytoML, warn.conflicts = FALSE)
library(DiffSOM, warn.conflicts = FALSE)
library(doParallel, warn.conflicts = FALSE)
library(EmbedSOM, warn.conflicts = FALSE)
library(FactoMineR, warn.conflicts = FALSE)
library(factoextra, warn.conflicts = FALSE)
library(flowClean, warn.conflicts = FALSE)
library(flowCore, warn.conflicts = FALSE)
library(flowClust, warn.conflicts = FALSE)
library(flowStats, warn.conflicts = FALSE)
library(flowViz, warn.conflicts = FALSE)
library(flowWorkspace, warn.conflicts = FALSE)
library(FlowSOM, warn.conflicts = FALSE)
library(furrr, warn.conflicts = FALSE)
library(ggcyto, warn.conflicts = FALSE)
library(HDclassif, warn.conflicts = FALSE)
library(imbalance, warn.conflicts = FALSE)
library(kohonen, warn.conflicts = FALSE)
library(microbenchmark, warn.conflicts = FALSE)
library(parallel, warn.conflicts = FALSE)
library(parallelMap, warn.conflicts = FALSE)
library(profvis, warn.conflicts = FALSE)
library(RColorBrewer, warn.conflicts = FALSE)
library(Rcpp11, warn.conflicts = FALSE)
library(ROSE, warn.conflicts = FALSE)
library(tictoc, warn.conflicts = FALSE)
library(tidyverse, warn.conflicts = FALSE)
library(xgboost, warn.conflicts = FALSE)
library(yasomi, warn.conflicts = FALSE)

# source("~/PRIMUS/home/trufenc/new_SOM_functions.R")
# source("/run/user/1002/gvfs/smb-share:server=primus.img.cas.cz,share=home/trufenc/new_SOM_functions.R")

# source_path <- "~/PRIMUS/"
source_path <- "/run/user/1002/gvfs/smb-share:server=primus.img.cas.cz,share="

source(paste0(source_path, "home/trufenc/new_SOM_functions.R"))
```


# path_to_files
```{r path_to_files}
path_to_gold_standard_control_files_1 <- paste0(source_path, "home/trufenc/fcs_files/c122/Specimen_001_c02672_fcs_2020_09_25")

path_to_gold_standard_control_files_2 <- paste0(source_path, "home/trufenc/fcs_files/c122/Specimen_001_c02676_fcs_2020_09_25")

# path_to_gold_standard_control_files_3 <- paste0(source_path, "home/trufenc/fcs_files/c122/Specimen_001_c02677_fcs_2020_09_25")

path_to_gold_standard_control_files_3 <- paste0(source_path, "home/trufenc/fcs_files/c122/Specimen_001_c02678_fcs_2020_09_25")

path_to_gold_standard_control_files_4 <- paste0(source_path, "home/trufenc/fcs_files/c122/Specimen_001_c02679_fcs_2020_09_25")

path_to_gold_standard_control_files_5 <- paste0(source_path, "home/trufenc/fcs_files/c122/Specimen_001_c02683_fcs_2020_09_25")

path_to_gold_standard_control_files_6 <- paste0(source_path, "home/trufenc/fcs_files/c122/Specimen_001_c02684_fcs_2020_09_25")

path_to_gold_standard_control_files_7 <- paste0(source_path, "home/trufenc/fcs_files/c146/Specimen_001_c03540_fcs")

path_to_gold_standard_control_files_8 <- paste0(source_path, "home/trufenc/fcs_files/c146/Specimen_001_c03541_fcs")

path_to_gold_standard_control_files_9 <- paste0(source_path, "home/trufenc/fcs_files/c146/Specimen_001_c03542_fcs")

path_to_gold_standard_control_files_10 <- paste0(source_path, "home/trufenc/fcs_files/c146/Specimen_001_c03564_fcs")

path_to_gold_standard_control_files_11 <- paste0(source_path, "home/trufenc/fcs_files/c145/Specimen_001_c02020_fcs")

path_to_gold_standard_control_files_12 <- paste0(source_path, "home/trufenc/fcs_files/c145/Specimen_001_c02027_fcs")

path_to_gold_standard_control_files_13 <- paste0(source_path, "home/trufenc/fcs_files/c145/Specimen_001_c02042_fcs")

path_to_gold_standard_control_files_14 <- paste0(source_path, "home/trufenc/fcs_files/c145/Specimen_001_c02043_fcs")

path_to_gold_standard_control_files_15 <- paste0(source_path, "home/trufenc/fcs_files/c145/Specimen_001_c02044_fcs")

path_to_gold_standard_control_files_16 <- paste0(source_path, "home/trufenc/fcs_files/c145/Specimen_001_c02045_fcs")

path_to_gold_standard_control_files_17 <- paste0(source_path, "home/trufenc/fcs_files/c145/Specimen_001_c02046_fcs")

path_to_gold_standard_control_files_18 <- paste0(source_path, "home/trufenc/fcs_files/c145/Specimen_001_c02055_fcs")

path_to_gold_standard_control_files_19 <- paste0(source_path, "home/trufenc/fcs_files/c145/Specimen_001_c02056_fcs")

path_to_gold_standard_control_files_20 <- paste0(source_path, "home/trufenc/fcs_files/c145/Specimen_001_c02057_fcs")



path_to_files <- list(path_to_gold_standard_control_files_1,
                      path_to_gold_standard_control_files_2,
                      path_to_gold_standard_control_files_3,
                      path_to_gold_standard_control_files_4,
                      path_to_gold_standard_control_files_5,
                      path_to_gold_standard_control_files_6,
                      path_to_gold_standard_control_files_7,
                      path_to_gold_standard_control_files_8,
                      path_to_gold_standard_control_files_9,
                      path_to_gold_standard_control_files_10,
                      path_to_gold_standard_control_files_11,
                      path_to_gold_standard_control_files_12,
                      path_to_gold_standard_control_files_13,
                      path_to_gold_standard_control_files_14,
                      path_to_gold_standard_control_files_15,
                      path_to_gold_standard_control_files_16,
                      path_to_gold_standard_control_files_17,
                      path_to_gold_standard_control_files_18
                      # path_to_gold_standard_control_files_19,
                      # path_to_gold_standard_control_files_20
                      )

files <- path_to_files %>% purrr::map(list.files, pattern = ".fcs", full.names = TRUE)

file_names <- path_to_files %>% purrr::map(list.files, pattern = ".fcs")

indices_list <- purrr::map(seq_along(files), function(j) purrr::map(seq_along(panel_A_classes), function(i) files[[j]] %>% str_which(pattern = panel_A_classes[i])) %>% unlist())
files_to_load_list <- purrr::map(seq_along(files), function(j) files[[j]][indices_list[[j]]])
files_to_load_names_list <- purrr::map(seq_along(files), function(j) file_names[[j]][indices_list[[j]]])
files_to_load_list[[9]] <- files_to_load_list[[9]][-c(56)]
files_to_load_names_list[[9]] <- files_to_load_names_list[[9]][-c(56)]
files_to_load_list[[13]] <- files_to_load_list[[9]][-c(56)]
files_to_load_names_list[[13]] <- files_to_load_names_list[[9]][-c(56)]
# files_to_load_list[[4]] <- files_to_load_list[[4]][-c(6, 24, 28, 48)]
# files_to_load_names_list[[4]] <- files_to_load_names_list[[4]][-c(6, 24, 28, 48)]

tic()
diff_som_1 <- files_to_load_list %>% unlist() %>% load_fcs_files(n_cells = 1e20, filter = TRUE, to_filter = c(1:6), scale = FALSE, transform = TRUE, to_transform = c(1:18))
toc()

cell_types_control <- diff_som_1$files %>% 
  unlist() %>% 
  str_remove(pattern = ".fcs") %>% 
  str_remove(pattern = "export_Specimen_..._c....._..._..._")

cell_types <- cell_types_control
# cell_types[cell_types %>% str_which(pattern = "CD8\\+_VM Tcells\\-")] <- NA
cell_types <- cell_types[!is.na(cell_types)]
# files_to_load_list %>% unlist()

# facs_data_df <- diff_som_1_normalized %>% build_fcs_data_df(cell_types = cell_types)
facs_data_df <- diff_som_1 %>% build_fcs_data_df(cell_types = cell_types)

facs_data_df <- facs_data_df %>% add_first_gate_column()

facs_data_df <- facs_data_df %>% add_second_gate_column()

facs_data_df <- facs_data_df %>% add_Res_Eff_Naive_gate_column()

facs_data_df <- facs_data_df %>% add_Klrg1_gate_column()

facs_data_df <- facs_data_df %>% add_fourth_gate_column()

facs_data_df_step_4 <- facs_data_df %>% dplyr::filter(first_gate != "not_live") %>% dplyr::filter(second_gate == "CD8+_cells") %>% dplyr::filter(Res_Eff_Naive_gate != "Neg")

fourth_gate_table <- facs_data_df_step_4 %>% group_by(fourth_gate) %>% tally()

train_df_step_4 <- facs_data_df_step_4
```

```{r}
val_path_to_files <- list(
  # path_to_gold_standard_control_files_1,
  #                       path_to_gold_standard_control_files_2,
  #                       path_to_gold_standard_control_files_3,
  #                       path_to_gold_standard_control_files_4,
  #                       path_to_gold_standard_control_files_5,
  #                       path_to_gold_standard_control_files_6,
  #                       path_to_gold_standard_control_files_7,
  #                       path_to_gold_standard_control_files_8,
  #                       path_to_gold_standard_control_files_9,
  #                       path_to_gold_standard_control_files_10,
  #                       path_to_gold_standard_control_files_11,
  #                       path_to_gold_standard_control_files_12,
  #                       path_to_gold_standard_control_files_13,
  #                       path_to_gold_standard_control_files_14,
  #                       path_to_gold_standard_control_files_15,
  #                       path_to_gold_standard_control_files_16,
  #                       path_to_gold_standard_control_files_17,
  #                       path_to_gold_standard_control_files_18
  path_to_gold_standard_control_files_19,
  path_to_gold_standard_control_files_20
)

val_files <- val_path_to_files %>% purrr::map(list.files, pattern = ".fcs", full.names = TRUE)

val_file_names <- val_path_to_files %>% purrr::map(list.files, pattern = ".fcs")

val_indices_list <- purrr::map(seq_along(val_files), function(j) purrr::map(seq_along(panel_A_classes), function(i) val_files[[j]] %>% str_which(pattern = panel_A_classes[i])) %>% unlist())
val_files_to_load_list <- purrr::map(seq_along(val_files), function(j) val_files[[j]][val_indices_list[[j]]])
val_files_to_load_names_list <- purrr::map(seq_along(val_files), function(j) val_file_names[[j]][val_indices_list[[j]]])

tic()
val_diff_som_1 <- val_files_to_load_list %>% unlist() %>% load_fcs_files(n_cells = 1e20, filter = TRUE, to_filter = c(1:6), scale = FALSE, transform = TRUE, to_transform = c(1:18))
toc()

val_cell_types_control <- val_diff_som_1$files %>% 
  unlist() %>% 
  str_remove(pattern = ".fcs") %>% 
  str_remove(pattern = "export_Specimen_..._c....._..._..._")

val_cell_types <- val_cell_types_control
# cell_types[cell_types %>% str_which(pattern = "CD8\\+_VM Tcells\\-")] <- NA
val_cell_types <- val_cell_types[!is.na(val_cell_types)]
# files_to_load_list %>% unlist()

# val_facs_data_df <- val_diff_som_1_normalized %>% build_fcs_data_df(cell_types = cell_types)
val_facs_data_df <- val_diff_som_1 %>% build_fcs_data_df(cell_types = val_cell_types)

val_facs_data_df <- val_facs_data_df %>% add_first_gate_column()

val_facs_data_df <- val_facs_data_df %>% add_second_gate_column()

val_facs_data_df <- val_facs_data_df %>% add_Res_Eff_Naive_gate_column()

val_facs_data_df <- val_facs_data_df %>% add_Klrg1_gate_column()

val_facs_data_df <- val_facs_data_df %>% add_fourth_gate_column()

val_facs_data_df_step_4 <- val_facs_data_df %>% dplyr::filter(first_gate != "not_live") %>% dplyr::filter(second_gate == "CD8+_cells") %>% dplyr::filter(Res_Eff_Naive_gate != "Neg")

val_fourth_gate_table <- val_facs_data_df_step_4 %>% group_by(fourth_gate) %>% tally()

val_df_step_4 <- val_facs_data_df_step_4
```

```{r}
# path_to_gold_standard_control_files_1 <- paste0(source_path, "home/trufenc/fcs_files/c122/Specimen_001_c02672_fcs_2020_09_25")
# 
# path_to_gold_standard_control_files_2 <- paste0(source_path, "home/trufenc/fcs_files/c122/Specimen_001_c02676_fcs_2020_09_25")
# 
# # path_to_gold_standard_control_files_3 <- paste0(source_path, "home/trufenc/fcs_files/c122/Specimen_001_c02677_fcs_2020_09_25")
# 
# path_to_gold_standard_control_files_3 <- paste0(source_path, "home/trufenc/fcs_files/c122/Specimen_001_c02678_fcs_2020_09_25")
# 
# path_to_gold_standard_control_files_4 <- paste0(source_path, "home/trufenc/fcs_files/c122/Specimen_001_c02679_fcs_2020_09_25")
# 
# path_to_gold_standard_control_files_5 <- paste0(source_path, "home/trufenc/fcs_files/c122/Specimen_001_c02683_fcs_2020_09_25")
# 
# path_to_gold_standard_control_files_6 <- paste0(source_path, "home/trufenc/fcs_files/c122/Specimen_001_c02684_fcs_2020_09_25")
# 
# path_to_gold_standard_control_files_7 <- paste0(source_path, "home/trufenc/fcs_files/c146/Specimen_001_c03540_fcs")
# 
# path_to_gold_standard_control_files_8 <- paste0(source_path, "home/trufenc/fcs_files/c146/Specimen_001_c03541_fcs")
# 
# path_to_gold_standard_control_files_9 <- paste0(source_path, "home/trufenc/fcs_files/c146/Specimen_001_c03542_fcs")
# 
# path_to_gold_standard_control_files_10 <- paste0(source_path, "home/trufenc/fcs_files/c146/Specimen_001_c03564_fcs")
# 
# path_to_gold_standard_control_files_11 <- paste0(source_path, "home/trufenc/fcs_files/c145/Specimen_001_c02020_fcs")
# 
# path_to_gold_standard_control_files_12 <- paste0(source_path, "home/trufenc/fcs_files/c145/Specimen_001_c02027_fcs")
# 
# path_to_gold_standard_control_files_13 <- paste0(source_path, "home/trufenc/fcs_files/c145/Specimen_001_c02042_fcs")
# 
# path_to_gold_standard_control_files_14 <- paste0(source_path, "home/trufenc/fcs_files/c145/Specimen_001_c02043_fcs")
# 
# path_to_gold_standard_control_files_15 <- paste0(source_path, "home/trufenc/fcs_files/c145/Specimen_001_c02044_fcs")
# 
# path_to_gold_standard_control_files_16 <- paste0(source_path, "home/trufenc/fcs_files/c145/Specimen_001_c02045_fcs")
# 
# path_to_gold_standard_control_files_17 <- paste0(source_path, "home/trufenc/fcs_files/c145/Specimen_001_c02046_fcs")
# 
# path_to_gold_standard_control_files_18 <- paste0(source_path, "home/trufenc/fcs_files/c145/Specimen_001_c02055_fcs")
# 
# path_to_gold_standard_control_files_19 <- paste0(source_path, "home/trufenc/fcs_files/c145/Specimen_001_c02056_fcs")
# 
# path_to_gold_standard_control_files_20 <- paste0(source_path, "home/trufenc/fcs_files/c145/Specimen_001_c02057_fcs")
# 
# 
# 
# path_to_files <- list(path_to_gold_standard_control_files_1,
#                       path_to_gold_standard_control_files_2,
#                       path_to_gold_standard_control_files_3,
#                       path_to_gold_standard_control_files_4,
#                       path_to_gold_standard_control_files_5,
#                       path_to_gold_standard_control_files_6,
#                       path_to_gold_standard_control_files_7,
#                       path_to_gold_standard_control_files_8,
#                       path_to_gold_standard_control_files_9,
#                       path_to_gold_standard_control_files_10,
#                       path_to_gold_standard_control_files_11,
#                       path_to_gold_standard_control_files_12,
#                       path_to_gold_standard_control_files_13,
#                       path_to_gold_standard_control_files_14,
#                       path_to_gold_standard_control_files_15,
#                       path_to_gold_standard_control_files_16,
#                       path_to_gold_standard_control_files_17,
#                       path_to_gold_standard_control_files_18,
#                       path_to_gold_standard_control_files_19,
#                       path_to_gold_standard_control_files_20
#                       )
# 
# files <- path_to_files %>% purrr::map(list.files, pattern = ".fcs", full.names = TRUE)
# 
# file_names <- path_to_files %>% purrr::map(list.files, pattern = ".fcs")
# 
# indices_list <- purrr::map(seq_along(files), function(j) purrr::map(seq_along(panel_A_classes), function(i) files[[j]] %>% str_which(pattern = panel_A_classes[i])) %>% unlist())
# files_to_load_list <- purrr::map(seq_along(files), function(j) files[[j]][indices_list[[j]]])
# files_to_load_names_list <- purrr::map(seq_along(files), function(j) file_names[[j]][indices_list[[j]]])
# files_to_load_list[[9]] <- files_to_load_list[[9]][-c(56)]
# files_to_load_names_list[[9]] <- files_to_load_names_list[[9]][-c(56)]
# files_to_load_list[[13]] <- files_to_load_list[[9]][-c(56)]
# files_to_load_names_list[[13]] <- files_to_load_names_list[[9]][-c(56)]
# 
# # to_load <- files_to_load_list[[6]][53:58] %>% unlist()
# to_load <- files_to_load_list %>% unlist()
# # to_load_names <- files_to_load_names_list[[6]][53:58] %>% unlist()
# to_load_names <- files_to_load_names_list %>% unlist()
# 
# diff_som_1 <- readRDS(file = paste0(source_path, "home/trufenc/diff_som_12_million_events.rds"))
# 
# diff_som_1_normalized <- diff_som_1 %>% pre_process_data()
# 
# cell_types_control <- diff_som_1$files %>% 
#   str_remove(pattern = ".fcs") %>% 
#   str_remove(pattern = "export_Specimen_..._c....._..._..._") 
# 
# cell_types <- cell_types_control
# # cell_types[cell_types %>% str_which(pattern = "CD8\\+_VM Tcells\\-")] <- NA
# cell_types <- cell_types[!is.na(cell_types)]
# # files_to_load_list %>% unlist()
# 
# # facs_data_df <- diff_som_1_normalized %>% build_fcs_data_df(cell_types = cell_types)
# facs_data_df <- diff_som_1 %>% build_fcs_data_df(cell_types = cell_types)
# 
# facs_data_df <- facs_data_df %>% mutate(cell_type = cell_type %>% dplyr::recode("CD8+_Eff_Klrg1-_VM Tcells" = "CD8+_Eff_Klrg1-_VM Tcells+"))
# 
# facs_data_df <- facs_data_df %>% add_first_gate_column()
# 
# facs_data_df <- facs_data_df %>% add_second_gate_column()
# 
# facs_data_df <- facs_data_df %>% add_third_gate_column()
# 
# facs_data_df <- facs_data_df %>% add_fourth_gate_column()
# 
# facs_data_df_step_4 <- facs_data_df %>% dplyr::filter(second_gate == "CD8+_cells")
# 
# fourth_gate_table <- facs_data_df_step_4 %>% group_by(fourth_gate) %>% tally()
# 
# # Manage imbalance
# facs_data_df_step_4_list <- facs_data_df_step_4 %>% split(f = .$fourth_gate)
# 
# set.seed(123)
# facs_data_df_step_4_list$VM_neg <- facs_data_df_step_4_list$VM_neg %>% dplyr::slice(sample(200000))
# 
# set.seed(123)
# facs_data_df_step_4_list$VM_pos <- facs_data_df_step_4_list$VM_pos %>% dplyr::slice(sample(200000))
# 
# facs_data_df_step_4 <- facs_data_df_step_4_list %>% bind_rows(.id = "fourth_gate")
# 
# facs_data_df_step_4 <- facs_data_df_step_4 %>% dplyr::select(-c(Time, File, File_scattered, cell_type, first_gate, second_gate, third_gate))
# 
# facs_data_df_step_4 %>% vroom::vroom_write(path = paste0(source_path, "home/trufenc/balanced_data_2_classes_fourth_gate_2020_10_07.tsv"), delim = "\t")
# 
# # sort data
# reseed()
# facs_data_df_step_4 <- facs_data_df_step_4 %>% dplyr::slice(sample(nrow(facs_data_df_step_4)))
# 
# # Set train and test dfs
# train_index_step_4 <- sample(1:nrow(facs_data_df_step_4), 0.7 * nrow(facs_data_df_step_4))
# 
# train_df_step_4 <- facs_data_df_step_4[train_index_step_4, ]
# test_df_step_4 <- facs_data_df_step_4[-train_index_step_4, ]
# 
# # rf_train_step_4 <- train_df_step_4 %>% mutate(fourth_gate = fourth_gate %>% factor(levels = c("VM_neg", "VM_pos")))

```


# Xgboost step 4
```{r}
library(xgboost)
step_4_levels <- train_df_step_4$fourth_gate %>% unique()

n_classes <- length(step_4_levels)

classes_number <- data.frame(
  classes = step_4_levels,
  Number = 1:length(step_4_levels)
)

val_label_step_4 <- val_df_step_4 %>%
  dplyr::select(fourth_gate) %>%
  pull() %>%
  str_replace(pattern = "VM_neg", replacement = "1") %>%
  str_replace(pattern = "VM_pos", replacement = "2") %>%
  as.numeric() %>%
  "-"(1)

train_label_step_4 <- train_df_step_4 %>%
  dplyr::select(fourth_gate) %>%
  pull() %>%
  str_replace(pattern = "VM_neg", replacement = "1") %>%
  str_replace(pattern = "VM_pos", replacement = "2") %>%
  as.numeric() %>%
  "-"(1)

train_matrix_step_4 <- xgb.DMatrix(
  data = train_df_step_4 %>%  
    dplyr::select(-c(Time, File, File_scattered, cell_type, first_gate, second_gate, Res_Eff_Naive_gate, Klrg1_gate, fourth_gate)) %>%
    as.matrix(),
  label = train_label_step_4
  )

val_matrix_step_4 <- xgb.DMatrix(
  data = val_df_step_4 %>%  
    dplyr::select(-c(Time, File, File_scattered, cell_type, first_gate, second_gate, Res_Eff_Naive_gate, Klrg1_gate, fourth_gate)) %>%
    as.matrix(),
  label = val_label_step_4
  )

k_fold <- 10

n_round <- 100

# xgb_params <- list(
#   booster = "gbtree",
#   # booster = "dart",
#   objective = "multi:softprob",
#   eta = 0.1,
#   gamma = 6.22,
#   max_depth = 10,
#   min_child_weight = 9.11,
#   subsample = 0.991,
#   colsample_bytree = 0.955,
#   num_class = n_classes,
#   nthread = 6
# )

xgb_params <- list(
  booster = "gbtree",
  # booster = "dart",
  objective = "multi:softprob",
  alpha = 0,
  eta = 0.3,
  gamma = 1.09,
  max_depth = 8,
  min_child_weight = 3.53,
  subsample = 0.632,
  colsample_bytree = 0.896,
  num_class = n_classes,
  nthread = 50
)

tic()
xgb_cv_model_4 <- xgb.cv(
  params = xgb_params,
  data = train_matrix_step_4,
  nrounds = n_round,
  nfold = k_fold,
  showsd = T,
  stratified = T,
  print_every_n = 1,
  early_stopping_rounds = 10,
  maximize = F,
  prediction = TRUE
)
toc()

xgb_cv_model_4$best_iteration

xgb_cv_model_4$evaluation_log %>% dplyr::filter(iter == xgb_cv_model_4$best_iteration) %>% dplyr::select(test_merror_mean) %>% pull

xgb_cv_model_4$evaluation_log %>% 
  ggplot(aes(x = iter)) +
  geom_line(aes(y = train_merror_mean, colour = "train")) + 
  geom_line(aes(y = test_merror_mean, colour = "test"))

# first default - model training
tic()
xgb_4 <- xgb.train(
  params = xgb_params, 
  data = train_matrix_step_4, 
  nrounds = xgb_cv_model_4$best_iteration,
  # nrounds = 2, 
  watchlist = list(val = val_matrix_step_4, train = train_matrix_step_4), 
  print_every_n = 1, 
  early_stopping_rounds = 10, 
  maximize = F , 
  eval_metric = "merror"
  )
toc()

# xgb_4 %>% saveRDS(paste0(source_path, "home/trufenc/xgboost_model_step_4_2020_10_12.rds"))
# xgb_4 %>% saveRDS(paste0(source_path, "home/trufenc/xgboost_model_step_4_2020_10_23.rds"))
xgb_4 %>% saveRDS(paste0(source_path, "home/trufenc/xgboost_model_step_4_2020_11_09.rds")) # tuned hyperparameters

xgb_pred <- predict(xgb_4, val_matrix_step_4)

val_prediction_df <- matrix(
  data = xgb_pred,
  nrow = n_classes,
  ncol = length(xgb_pred) / n_classes
  ) %>%
  t() %>%
  data.frame()

val_prediction <- val_prediction_df %>%
  mutate(
    label = val_label_step_4 %>% as.numeric() + 1,
    max_prob = max.col(., "last")
  )

library(caret)
confusion_matrix <- confusionMatrix(factor(val_prediction$label), factor(val_prediction$max_prob))

#view variable importance plot
importance_matrix <- xgb.importance(feature_names = colnames(train_matrix_step_4), model = xgb_4)

gp = xgb.ggplot.importance(importance_matrix = importance_matrix)
print(gp)
```

# independent dataset to test
# https://github.com/RGLab/flowCore/issues/108
```{r}
path_to_test_files_1 <- paste0(source_path, "home/trufenc/fcs_files/c120/Specimen_001_c00259_fcs")

path_to_test_files_2 <- paste0(source_path, "home/trufenc/fcs_files/c120/Specimen_001_c00260_fcs")

path_to_test_files_3 <- paste0(source_path, "home/trufenc/fcs_files/c120/Specimen_001_c00261_fcs")

path_to_test_files_4 <- paste0(source_path, "home/trufenc/fcs_files/c120/Specimen_001_c00262_fcs")

path_to_test_files_5 <- paste0(source_path, "home/trufenc/fcs_files/c120/Specimen_001_c00263_fcs")

path_to_test_files_6 <- paste0(source_path, "home/trufenc/fcs_files/c120/Specimen_001_c00273_fcs")

path_to_test_files_7 <- paste0(source_path, "home/trufenc/fcs_files/c120/Specimen_001_c00602_fcs")

path_to_test_files_8 <- paste0(source_path, "home/trufenc/fcs_files/c120/Specimen_001_c00603_fcs")

path_to_test_files_9 <- paste0(source_path, "home/trufenc/fcs_files/c120/Specimen_001_c00604_fcs")

path_to_test_files_10 <- paste0(source_path, "home/trufenc/fcs_files/c120/Specimen_001_c002601_fcs")

test_path_to_files <- list(
  path_to_test_files_1,
  path_to_test_files_2,
  path_to_test_files_3,
  path_to_test_files_4,
  path_to_test_files_5,
  path_to_test_files_6,
  path_to_test_files_7,
  path_to_test_files_8,
  path_to_test_files_9,
  path_to_test_files_10
)

test_files <- test_path_to_files %>% purrr::map(list.files, pattern = ".fcs", full.names = TRUE)

test_file_names <- test_path_to_files %>% purrr::map(list.files, pattern = ".fcs")

test_indices_list <- purrr::map(seq_along(test_files), function(j) purrr::map(seq_along(panel_A_classes), function(i) test_files[[j]] %>% str_which(pattern = panel_A_classes[i])) %>% unlist())

test_files_to_load_list <- purrr::map(seq_along(test_files), function(j) test_files[[j]][test_indices_list[[j]]])

test_files_to_load_names_list <- purrr::map(seq_along(test_files), function(j) test_file_names[[j]][test_indices_list[[j]]])

# files_to_load_list[[9]] <- files_to_load_list[[9]][-c(56)]
# files_to_load_names_list[[9]] <- files_to_load_names_list[[9]][-c(56)]
# files_to_load_list[[13]] <- files_to_load_list[[9]][-c(56)]
# files_to_load_names_list[[13]] <- files_to_load_names_list[[9]][-c(56)]

# test_files_to_load <- list.files(path = test_path_to_files, pattern = ".fcs", full.names = TRUE)

# test_files_to_load <- test_files_to_load[-33]

tic()
test_diff_som <- test_files_to_load_list %>% unlist() %>% load_fcs_files(n_cells = 1e20, filter = TRUE, to_filter = c(1:6), scale = FALSE, transform = TRUE, to_transform = c(1:18))
toc()

test_cell_types_control <- test_diff_som$files %>% 
  unlist() %>% 
  str_remove(pattern = ".fcs") %>% 
  str_remove(pattern = "export_Specimen_..._c....._..._..._")

test_cell_types <- test_cell_types_control
test_cell_types <- test_cell_types[!is.na(test_cell_types)]

test_facs_data_df <- test_diff_som %>% build_fcs_data_df(cell_types = test_cell_types)

test_facs_data_df <- test_facs_data_df %>% add_first_gate_column()

test_facs_data_df <- test_facs_data_df %>% add_second_gate_column()

test_facs_data_df <- test_facs_data_df %>% add_Res_Eff_Naive_gate_column()

test_facs_data_df <- test_facs_data_df %>% add_Klrg1_gate_column()

test_facs_data_df <- test_facs_data_df %>% add_fourth_gate_column()

test_df_step_4 <- test_facs_data_df %>% dplyr::filter(first_gate != "not_live") %>% dplyr::filter(second_gate == "CD8+_cells") %>% dplyr::filter(Res_Eff_Naive_gate != "Neg")

step_4_levels <- test_df_step_4$fourth_gate %>% unique()

n_classes <- length(step_4_levels)

test_label <- test_df_step_4 %>%
  dplyr::select(fourth_gate) %>%
  pull() %>%
  str_replace(pattern = "VM_neg", replacement = "1") %>%
  str_replace(pattern = "VM_pos", replacement = "2") %>%
  as.numeric() %>%
  "-"(1)

test_matrix <- xgb.DMatrix(
  # data = EmbedSOM_results_step_4$weights_df[-test_indices, ] %>%
  # data = test_EmbedSOM_results_step_4$weights_df %>%  
  data = test_df_step_4 %>%    
    dplyr::select(-c(Time, File, File_scattered, cell_type, first_gate, second_gate, Res_Eff_Naive_gate, Klrg1_gate, fourth_gate)) %>%
    # dplyr::select(-c(first_gate)) %>%
    as.matrix(),
  label = test_label
  )

xgb_pred_4 <- predict(xgb_4, test_matrix)

test_prediction_df <- matrix(
  data = xgb_pred_4,
  nrow = n_classes,
  ncol = length(xgb_pred_4) / n_classes
  ) %>%
  t() %>%
  data.frame()

test_prediction <- test_prediction_df %>%
  mutate(
    label = test_label %>% as.numeric() + 1,
    max_prob = max.col(., "last")
  )

library(caret)
test_confusion_matrix <- confusionMatrix(factor(test_prediction$label), factor(test_prediction$max_prob))

#view variable importance plot
test_importance_matrix <- xgb.importance(feature_names = colnames(train_matrix_step_4), model = xgb_4)

gp = xgb.ggplot.importance(importance_matrix = importance_matrix)
print(gp)
```

# mlr - xgboost
# Tune max_depth and min_child_weight
```{r}
library(mlr)

# Convert characters to factors
train_df <- train_df_step_4 %>% dplyr::select(-c(Time, File, File_scattered, cell_type, first_gate, second_gate, Res_Eff_Naive_gate, Klrg1_gate)) %>% mutate(third_gate = fourth_gate %>% factor()) %>% as.data.frame()
test_df <- val_df_step_4 %>% dplyr::select(-c(Time, File, File_scattered, cell_type, first_gate, second_gate, Res_Eff_Naive_gate, Klrg1_gate)) %>%  mutate(third_gate = fourth_gate %>% factor()) %>% as.data.frame()

# Do one hot encoding`<br/>
train_df <- createDummyFeatures(obj = train_df, target = "fourth_gate", method = "1-of-n")
test_df <- createDummyFeatures(obj = test_df, target = "fourth_gate", method = "1-of-n")

# Create tasks
train_task <- makeClassifTask(data = train_df, target = "fourth_gate")
test_task <- makeClassifTask(data = test_df, target = "fourth_gate")

# Create learner
lrn <- makeLearner("classif.xgboost", predict.type = "response")
lrn$par.vals <- list(objective = "multi:softprob", etest_metric = "merror", nrounds = 100L, booster = "gbtree", max_depth = 8, min_child_weight = 3.53, gamma = 1.09, subsample = 0.632, colsample_bytree = 0.896)

# Set parameter space
params <- makeParamSet(
  # makeDiscreteParam("booster", values = c("gbtree", "dart")),
  # makeIntegerParam("max_depth", lower = 3L, upper = 10L),
  # makeNumericParam("min_child_weight", lower = 1L, upper = 10L),
  # makeNumericParam("gamma", lower = 0L, upper = 10L)
  # makeNumericParam("subsample", lower = 0.5, upper = 1),
  # makeNumericParam("colsample_bytree", lower = 0.5, upper = 1)
  makeNumericParam("alpha", lower = 0, upper = 1),
  makeNumericParam("eta", lower = 0.001, upper = 0.3)
)

# set resampling strategy
rdesc <- makeResampleDesc("CV", stratify = T, iters = 5L)

# Search strategy
ctrl <- makeTuneControlRandom(maxit = 10L)

# Set parallel backend
library(parallel)
library(parallelMap) 
# parallelStartSocket(cpus = (detectCores()-1))
parallelStartSocket(cpus = 6)

#parameter tuning
# 98904.702
# 61985.26
# 28194.842 sec elapsed for gammma tuning!
tic()
xgb_tuning <- tuneParams(learner = lrn, task = train_task, resampling = rdesc, measures = acc, par.set = params, control = ctrl, show.info = T)
toc()

# xgb_tuning %>% saveRDS("~/Documents/xgb_tuning_step_3_balanced_data.rds")
# xgb_tuning <- readRDS("~/Documents/xgb_tuning_step_3_balanced_data.rds")

xgb_tuning$y

#set hyperparameters
lrn_tune <- setHyperPars(lrn,par.vals = xgb_tuning$x)

#train model
xg_model <- train(learner = lrn_tune, task = train_task)

#predict model
xg_pred <- predict(xg_model, test_task)

confusion_matrix <- confusionMatrix(xg_pred$data$response, xg_pred$data$truth)

conf_df <- confusion_matrix$byClass %>% as.data.frame()

conf_df$F1
```

























path to files
```{r path_to_files, cache=TRUE}
path_to_files <- paste0(source_path, "~/data/83_BIOINFORMATICS/Carlos")
```

```{r}
path_to_control_files_1 <- paste0(source_path, "data/83_IMPC_DATA/Immunology/CCP_Phenotyping_Immunology_Data_JB/CCP_cohorts_2018/CCP_cohorts_2018_12/2018_12_27_C067/2018_12_27_PA/C067_cA1556_gates")

path_to_control_files_2 <- paste0(source_path, "data/83_IMPC_DATA/Immunology/CCP_Phenotyping_Immunology_Data_JB/CCP_cohorts_2019/CCP_cohorts_2019_10/2019_10_29_C108/2019_10_29_PA/gates_c90692")

path_to_control_files_3 <- paste0(source_path, "data/83_IMPC_DATA/Immunology/CCP_Phenotyping_Immunology_Data_JB/CCP_cohorts_2019/CCP_cohorts_2019_10/2019_10_29_C108/2019_10_29_PA/gates_c90695")

path_to_control_files_4 <- paste0(source_path, "data/83_IMPC_DATA/Immunology/CCP_Phenotyping_Immunology_Data_JB/CCP_cohorts_2019/CCP_cohorts_2019_06/2019_06_10_C088/C088_PA_c89141_gates")

path_to_control_files_5 <- paste0(source_path, "data/83_IMPC_DATA/Immunology/CCP_Phenotyping_Immunology_Data_JB/CCP_cohorts_2019/CCP_cohorts_2019_06/2019_06_10_C088/C088_PA_c90043_gates")

path_to_ko_files_1 <- paste0(source_path, "data/83_IMPC_DATA/Immunology/CCP_Phenotyping_Immunology_Data_JB/CCP_cohorts_2019/CCP_cohorts_2019_10/2019_10_29_C108/2019_10_29_PA/gates_tgE8038")

path_to_ko_files_2 <- paste0(source_path, "data/83_IMPC_DATA/Immunology/CCP_Phenotyping_Immunology_Data_JB/CCP_cohorts_2019/CCP_cohorts_2019_10/2019_10_29_C108/2019_10_29_PA/gates_tgE8040")
```

```{r}
path_to_files <- list(path_to_control_files_1,
                      path_to_control_files_2,
                      path_to_control_files_3,
                      path_to_control_files_4,
                      path_to_control_files_5)

path_to_ko_files <- list(path_to_ko_files_1,
                           path_to_ko_files_2)
```

```{r files, cache=TRUE}
files <- path_to_files %>% purrr::map(list.files, pattern = ".fcs", full.names = TRUE)
ko_files <- path_to_ko_files %>% purrr::map(list.files, pattern = ".fcs", full.names = TRUE)
```

```{r file_names, cache=TRUE}
file_names <- path_to_files %>% purrr::map(list.files, pattern = ".fcs")
ko_files_names <- path_to_ko_files %>% purrr::map(list.files, pattern = ".fcs")
```

```{r}
panel_A_classes <- c(
  "_clog\\+.fcs",
  "_clog\\-_cells\\-.fcs",
  "_S1\\-.fcs",
  "_dead.fcs",
  "_S2\\-.fcs",
  "gdTCR_Eff_Klrg1\\-.fcs",
  "gdTCR_Eff_Klrg1\\+.fcs",
  "gdTCR_Res_Klrg1\\-.fcs",
  "gdTCR_Res_Klrg1\\+.fcs",
  "gdTCR_neg_Klrg1\\-.fcs",
  "gdTCR_neg_Klrg1\\+.fcs",
  "NK_Eff_Klrg1\\-.fcs",
  "NK_Eff_Klrg1\\+.fcs",
  "NK_Res_Klrg1\\-.fcs",
  "NK_Res_Klrg1\\+.fcs",
  "NK_neg_Klrg1\\+\\-.fcs",
  "NK_neg_Klrg1\\+.fcs",
  #"_CD5\\+\\-.fcs",
  #"_CD4\\+ NKT\\+ or CD4\\- NKT\\+\\-.fcs",
  "CD4\\-NKT_Eff_Klrg1\\-.fcs",
  "CD4\\-NKT_Eff_Klrg1\\+.fcs",
  "CD4\\-NKT_Res_Klrg1\\-.fcs",
  "CD4\\-NKT_Res_Klrg1\\+.fcs",
  "CD4\\-NKT_neg_Klrg1\\-.fcs",
  "CD4\\-NKT_neg_Klrg1\\+.fcs",
  "CD4\\+NKT_Eff_Klrg1\\-.fcs",
  "CD4\\+NKT_Eff_Klrg1\\+.fcs",
  "CD4\\+NKT_Res_Klrg1\\-.fcs",
  "CD4\\+NKT_Res_Klrg1\\+.fcs",
  "CD4\\+NKT_neg_Klrg1\\-.fcs",
  "CD4\\+NKT_neg_Klrg1\\+.fcs",
  "DN .fcs",
  "Tregs_Eff_Klrg1\\-.fcs",
  "Tregs_Eff_Klrg1\\+.fcs",
  "Tregs_Res_Klrg1\\-.fcs",
  "Tregs_Res_Klrg1\\+.fcs",
  "Tregs_neg_Klrg1\\-.fcs",
  "Tregs_neg_Klrg1\\+.fcs",
  "Th_Eff_Klrg1\\-.fcs",
  "Th_Eff_Klrg1\\+.fcs",
  "Th_Res_Klrg1\\-.fcs",
  "Th_Res_Klrg1\\+.fcs",
  "Th_neg_Klrg1\\-.fcs",
  "Th_neg_Klrg1\\+.fcs",
  "CD8_Naive_Klrg1\\-_VM Tcells\\-.fcs",
  "CD8_Naive_Klrg1\\-_VM Tcells.fcs",
  "CD8_Naive_Klrg1\\+_VM Tcells\\-.fcs",
  "CD8_Naive_Klrg1\\+_VM Tcells.fcs",
  "CD8_Eff_Klrg1\\-_VM Tcells\\-.fcs",
  "CD8_Eff_Klrg1\\-_VM Tcells.fcs",
  "CD8_Eff_Klrg1\\+_VM Tcells\\-.fcs",
  "CD8_Eff_Klrg1\\+_VM Tcells.fcs",
  "CD8_Res_Klrg1\\-_VM Tcells\\-.fcs",
  "CD8_Res_Klrg1\\-_VM Tcells.fcs",
  "CD8_Res_Klrg1\\+_VM Tcells\\-.fcs",
  "CD8_Res_Klrg1\\+_VM Tcells.fcs",
  "CD8_neg_Klrg1\\-_VM Tcells\\-.fcs",
  "CD8_neg_Klrg1\\-_VM Tcells.fcs",
  "CD8_neg_Klrg1\\+_VM Tcells\\-.fcs",
  "CD8_neg_Klrg1\\+_VM Tcells.fcs"
)
```

```{r}
indices_1 <- purrr::map(seq_along(panel_A_classes), function(i) files[[1]] %>% str_which(pattern = panel_A_classes[i])) %>% unlist()
files_to_load_1 <- files[[1]][indices_1]
files_to_load_names_1 <- file_names[[1]][indices_1]
```

# Second class assignment, more refined - gates_c90692
```{r}
panel_A_classes_2 <- c(
  "clog\\-\\-.fcs",
  "cells\\-.fcs",
  "S1\\-.fcs",
  "dead.fcs",
  "S2\\-.fcs",
  "gd_Eff_Klrg1\\+\\-.fcs",
  "gd_Eff_Klrg1\\+.fcs",
  "gd_Res_Klrg1\\+\\-.fcs",
  "gd_Res_Klrg1\\+.fcs",
  "gd_neg_Klrg1\\+\\-.fcs",
  "gd_neg_Klrg1\\+.fcs",
  "NK_Eff_Klrg1\\+\\-.fcs",
  "NK_Eff_Klrg1\\+.fcs",
  "NK_Res_Klrg1\\+\\-.fcs",
  "NK_Res_Klrg1\\+.fcs",
  "NK_neg_Klrg1\\+\\-.fcs",
  "NK_neg_Klrg1\\+.fcs",
  "CD4\\-NKT_Eff_Klrg1\\+\\-.fcs",
  "CD4\\-NKT_Eff_Klrg1\\+.fcs",
  "CD4\\-NKT_Res_Klrg1\\+\\-.fcs",
  "CD4\\-NKT_Res_Klrg1\\+.fcs",
  "CD4\\-NKT_neg_Klrg1\\+\\-.fcs",
  "CD4\\-NKT_neg_Klrg1\\+.fcs",
  "CD4\\+NKT_Eff_Klrg1\\+\\-.fcs",
  "CD4\\+NKT_Eff_Klrg1\\+.fcs",
  "CD4\\+NKT_Res_Klrg1\\+\\-.fcs",
  "CD4\\+NKT_Res_Klrg1\\+.fcs",
  "CD4\\+NKT_neg_Klrg1\\+\\-.fcs",
  "CD4\\+NKT_neg_Klrg1\\+.fcs",
  "DN .fcs",
  "Treg_Eff_Klrg1\\+\\-.fcs",
  "Treg_Eff_Klrg1\\+.fcs",
  "Treg_Res_Klrg1\\+\\-.fcs",
  "Treg_Res_Klrg1\\+.fcs",
  "Treg_neg_Klrg1\\+\\-.fcs",
  "Treg_neg_Klrg1\\+.fcs",
  "Th_Eff_Klrg1\\+\\-.fcs",
  "Th_Eff_Klrg1\\+.fcs",
  "Th_Res_Klrg1\\+\\-.fcs",
  "Th_Res_Klrg1\\+.fcs",
  "Th_neg_Klrg1\\+\\-.fcs",
  "Th_neg_Klrg1\\+.fcs",
  "CD8\\+_Naive_Klrg1\\-_VM Tcells\\-.fcs",
  "CD8\\+_Naive_Klrg1\\-_VM Tcells.fcs",
  "CD8\\+_Naive_Klrg1\\+_VM Tcells\\-.fcs",
  "CD8\\+_Naive_Klrg1\\+_VM Tcells.fcs",
  "CD8\\+_Eff_Klrg1\\-_VM Tcells\\-.fcs",
  "CD8\\+_Eff_Klrg1\\-_VM Tcells.fcs",
  "CD8\\+_Eff_Klrg1\\+_VM Tcells\\-.fcs",
  "CD8\\+_Eff_Klrg1\\+_VM Tcells.fcs",
  "CD8\\+_Res_Klrg1\\-_VM Tcells\\-.fcs",
  "CD8\\+_Res_Klrg1\\-_VM Tcells.fcs",
  "CD8\\+_Res_Klrg1\\+_VM Tcells\\-.fcs",
  "CD8\\+_Res_Klrg1\\+_VM Tcells.fcs",
  "CD8\\+_neg_Klrg1\\-_VM Tcells\\-.fcs",
  "CD8\\+_neg_Klrg1\\-_VM Tcells.fcs",
  "CD8\\+_neg_Klrg1\\+_VM Tcells\\-.fcs",
  "CD8\\+_neg_Klrg1\\+_VM Tcells.fcs"
)
```

```{r}
indices_2 <- purrr::map(seq_along(panel_A_classes_2), function(i) files[[2]] %>% str_which(pattern = panel_A_classes_2[i])) %>% unlist()
files_to_load_2 <- files[[2]][indices_2]
files_to_load_names_2 <- file_names[[2]][indices_2]

files_to_load_2[files_to_load_2 %>% str_which(pattern = "CD8\\+_VM Tcells\\-")] <- NA
files_to_load_2 <- files_to_load_2[!is.na(files_to_load_2)]
```

# Second class assignment, more refined - gates_c90695
```{r}
panel_A_classes_3 <- panel_A_classes_4 <- panel_A_classes_5 <- c(
  "clog\\-\\-.fcs",
  "clog\\-_cells\\-.fcs",
  "S1\\-.fcs",
  "dead.fcs",
  "S2\\-.fcs",
  "gd_Eff_Klrg1\\+\\-.fcs",
  "gd_Eff_Klrg1\\+.fcs",
  "gd_Res_Klrg1\\+\\-.fcs",
  "gd_Res_Klrg1\\+.fcs",
  "gd_neg_Klrg1\\+\\-.fcs",
  "gd_neg_Klrg1\\+.fcs",
  "NK_Eff_Klrg1\\+\\-.fcs",
  "NK_Eff_Klrg1\\+.fcs",
  "NK_Res_Klrg1\\+\\-.fcs",
  "NK_Res_Klrg1\\+.fcs",
  "NK_neg_Klrg1\\+\\-.fcs",
  "NK_neg_Klrg1\\+.fcs",
  "CD4\\-NKT_Eff_Klrg1\\+\\-.fcs",
  "CD4\\-NKT_Eff_Klrg1\\+.fcs",
  "CD4\\-NKT_Res_Klrg1\\+\\-.fcs",
  "CD4\\-NKT_Res_Klrg1\\+.fcs",
  "CD4\\-NKT_neg_Klrg1\\+\\-.fcs",
  "CD4\\-NKT_neg_Klrg1\\+.fcs",
  "CD4\\+NKT_Eff_Klrg1\\+\\-.fcs",
  "CD4\\+NKT_Eff_Klrg1\\+.fcs",
  "CD4\\+NKT_Res_Klrg1\\+\\-.fcs",
  "CD4\\+NKT_Res_Klrg1\\+.fcs",
  "CD4\\+NKT_neg_Klrg1\\+\\-.fcs",
  "CD4\\+NKT_neg_Klrg1\\+.fcs",
  "DN .fcs",
  "Treg_Eff_Klrg1\\+\\-.fcs",
  "Treg_Eff_Klrg1\\+.fcs",
  "Treg_Res_Klrg1\\+\\-.fcs",
  "Treg_Res_Klrg1\\+.fcs",
  "Treg_neg_Klrg1\\+\\-.fcs",
  "Treg_neg_Klrg1\\+.fcs",
  "Th_Eff_Klrg1\\+\\-.fcs",
  "Th_Eff_Klrg1\\+.fcs",
  "Th_Res_Klrg1\\+\\-.fcs",
  "Th_Res_Klrg1\\+.fcs",
  "Th_neg_Klrg1\\+\\-.fcs",
  "Th_neg_Klrg1\\+.fcs",
  "CD8\\+_Naive_Klrg1\\-_VM Tcells\\-.fcs",
  "CD8\\+_Naive_Klrg1\\-_VM Tcells.fcs",
  "CD8\\+_Naive_Klrg1\\+_VM Tcells\\-.fcs",
  "CD8\\+_Naive_Klrg1\\+_VM Tcells.fcs",
  "CD8\\+_Eff_Klrg1\\-_VM Tcells\\-.fcs",
  "CD8\\+_Eff_Klrg1\\-_VM Tcells.fcs",
  "CD8\\+_Eff_Klrg1\\+_VM Tcells\\-.fcs",
  "CD8\\+_Eff_Klrg1\\+_VM Tcells.fcs",
  "CD8\\+_Res_Klrg1\\-_VM Tcells\\-.fcs",
  "CD8\\+_Res_Klrg1\\-_VM Tcells.fcs",
  "CD8\\+_Res_Klrg1\\+_VM Tcells\\-.fcs",
  "CD8\\+_Res_Klrg1\\+_VM Tcells.fcs",
  "CD8\\+_neg_Klrg1\\-_VM Tcells\\-.fcs",
  "CD8\\+_neg_Klrg1\\-_VM Tcells.fcs",
  "CD8\\+_neg_Klrg1\\+_VM Tcells\\-.fcs",
  "CD8\\+_neg_Klrg1\\+_VM Tcells.fcs"
)
```

```{r}
indices_3 <- purrr::map(seq_along(panel_A_classes_3), function(i) files[[3]] %>% str_which(pattern = panel_A_classes_3[i])) %>% unlist()
files_to_load_3 <- files[[3]][indices_3]
files_to_load_names_3 <- file_names[[3]][indices_3]
```

```{r}
indices_4 <- purrr::map(seq_along(panel_A_classes_4), function(i) files[[4]] %>% str_which(pattern = panel_A_classes_4[i])) %>% unlist()
files_to_load_4 <- files[[4]][indices_4]
files_to_load_names_4 <- file_names[[4]][indices_4]
```

```{r}
indices_5 <- purrr::map(seq_along(panel_A_classes_5), function(i) files[[5]] %>% str_which(pattern = panel_A_classes_5[i])) %>% unlist()
files_to_load_5 <- files[[5]][indices_5]
files_to_load_names_5 <- file_names[[5]][indices_5]
```

All the classes for panel A
```{r}
panel_A_classes_v <- c(
  "clog+",
  "cells-",
  "S1-",
  "dead",
  "S2-",
  "gdTCR_Eff_Klrg1-",
  "gdTCR_Eff_Klrg1+",
  "gdTCR_Res_Klrg1-",
  "gdTCR_Res_Klrg1+",
  "gdTCR_neg_Klrg1-",
  "gdTCR_neg_Klrg1+",
  "NK_Eff_Klrg1-",
  "NK_Eff_Klrg1+",
  "NK_Res_Klrg1-",
  "NK_Res_Klrg1+",
  "NK_neg_Klrg1+-",
  "NK_neg_Klrg1+",
  "CD4-NKT_Eff_Klrg1-",
  "CD4-NKT_Eff_Klrg1+",
  "CD4-NKT_Res_Klrg1-",
  "CD4-NKT_Res_Klrg1+",
  "CD4-NKT_neg_Klrg1-",
  "CD4-NKT_neg_Klrg1+",
  "CD4+NKT_Eff_Klrg1-",
  "CD4+NKT_Eff_Klrg1+",
  "CD4+NKT_Res_Klrg1-",
  "CD4+NKT_Res_Klrg1+",
  "CD4+NKT_neg_Klrg1-",
  "CD4+NKT_neg_Klrg1+",
  "DN",
  "Tregs_Eff_Klrg1-",
  "Tregs_Eff_Klrg1+",
  "Tregs_Res_Klrg1-",
  "Tregs_Res_Klrg1+",
  "Tregs_neg_Klrg1-",
  "Tregs_neg_Klrg1+",
  "Th_Eff_Klrg1-",
  "Th_Eff_Klrg1+",
  "Th_Res_Klrg1-",
  "Th_Res_Klrg1+",
  "Th_neg_Klrg1-",
  "Th_neg_Klrg1+",
  "CD8_Naive_Klrg1-_VM Tcells-",
  "CD8_Naive_Klrg1-_VM Tcells",
  "CD8_Naive_Klrg1+_VM Tcells-",
  "CD8_Naive_Klrg1+_VM Tcells",
  "CD8_Eff_Klrg1-_VM Tcells-",
  "CD8_Eff_Klrg1-_VM Tcells",
  "CD8_Eff_Klrg1+_VM Tcells-",
  "CD8_Eff_Klrg1+_VM Tcells",
  "CD8_Res_Klrg1-_VM Tcells-",
  "CD8_Res_Klrg1-_VM Tcells",
  "CD8_Res_Klrg1+_VM Tcells-",
  "CD8_Res_Klrg1+_VM Tcells",
  "CD8_neg_Klrg1-_VM Tcells-",
  "CD8_neg_Klrg1-_VM Tcells",
  "CD8_neg_Klrg1+_VM Tcells-",
  "CD8_neg_Klrg1+_VM Tcells"
)
```

```{r}
ko_indices_1 <- purrr::map(seq_along(panel_A_classes_3), function(i) ko_files[[1]] %>% str_which(pattern = panel_A_classes_3[i])) %>% unlist()
ko_files_to_load_1 <- ko_files[[1]][ko_indices_1]
ko_files_to_load_names_1 <- ko_files_names[[1]][ko_indices_1]
```

```{r}
ko_indices_2 <- purrr::map(seq_along(panel_A_classes_3), function(i) ko_files[[2]] %>% str_which(pattern = panel_A_classes_3[i])) %>% unlist()
ko_files_to_load_2 <- ko_files[[2]][ko_indices_2]
ko_files_to_load_names_2 <- ko_files_names[[2]][ko_indices_2]
```


```{r}
files_to_load <- c(files_to_load_1, files_to_load_2, files_to_load_4, files_to_load_5, ko_files_to_load_1, ko_files_to_load_2)
files_to_load[files_to_load %>% str_which(pattern = "CD8\\+_VM Tcells\\-")] <- NA
files_to_load <- files_to_load[!is.na(files_to_load)]

test_files <- c(files_to_load_3)
```


# Load files and pre-procees them ()
```{r pre_process_data}
diff_som_3 <- files_to_load %>% load_fcs_files(n_cells = 1e20, filter = TRUE, toFilter = c(1:6), scale = FALSE, transform = TRUE, toTransform = c(1:18))
test_diff_som <- test_files %>% load_fcs_files(n_cells = 1e20, filter = TRUE, toFilter = c(1:6), scale = FALSE, transform = TRUE, toTransform = c(1:18))
```

```{r}
pre_process_data <- function(diff_som, to_transform = c(1:18)){
  # diff_som$fs$data <- diff_som$fs$data %>% purrr::set_names(str_remove(string = names(diff_som$fs$data), pattern = "FJComp."))
  diff_som_df <- diff_som$fs$data %>% as.data.frame() %>% dplyr::select(-c(Time, File, File_scattered))
  normally_dstributed <- diff_som_df %>% purrr::map(bestNormalize::orderNorm)
  normally_dstributed_df <- purrr::map(seq_along(normally_dstributed), function(i) normally_dstributed[[i]]$x.t) %>% purrr::set_names(colnames(diff_som_df)) %>% purrr::map(scale, center = TRUE, scale = TRUE) %>% purrr::map(scale_to_range_0_1) %>% bind_cols()
  diff_som$fs$data[, to_transform] <- normally_dstributed_df %>% as.matrix()
  return(diff_som)
}
```

```{r}
# diff_som_3 %>% saveRDS(file = paste0(source_path, "/home/trufenc/diff_som_3_2020_07_28.rds"))
# test_diff_som %>% saveRDS(file = paste0(source_path, "/home/trufenc/test_diff_som_3020_07_28.rds"))
```

```{r}
diff_som_3 <- readRDS(file = paste0(source_path, "home/trufenc/diff_som_2_2020_07_28.rds"))
test_diff_som <- readRDS(file = paste0(source_path, "home/trufenc/test_diff_som_2020_07_28.rds"))
```

```{r}
diff_som_3_normalized <- diff_som_3 %>% pre_process_data()
test_diff_som_normalized <- test_diff_som %>% pre_process_data()
```

```{r}
# cell_types <- files_to_load_names %>% str_remove(pattern = ".fcs") %>% str_remove(pattern = "export_Specimen_..._c....._..._..._")
cell_types_control <- c(files_to_load_names_1, files_to_load_names_2, files_to_load_names_4, files_to_load_names_5) %>% 
  str_remove(pattern = ".fcs") %>% 
  str_remove(pattern = "export_Specimen_..._c....._..._..._")

cell_types_ko <- c(ko_files_to_load_names_1, ko_files_to_load_names_2) %>% 
  str_remove(pattern = ".fcs") %>% 
  str_remove(pattern = "export_Specimen_..._tg....._..._..._")

cell_types <- c(cell_types_control, cell_types_ko)
cell_types[cell_types %>% str_which(pattern = "CD8\\+_VM Tcells\\-")] <- NA
cell_types <- cell_types[!is.na(cell_types)]
```

# function build_fcs_data_df
```{r build_fcs_data_df}
build_fcs_data_df <- function(cell_types, diff_som) {
  
  cell_types_df <- cell_types %>%
    as.data.frame() %>%
    rownames_to_column() %>%
    dplyr::rename("cell_types" = ".", "File" = "rowname") %>%
    mutate(File = File %>% as.numeric())

  cell_types_df <- cell_types_df %>%
    mutate(cell_types = cell_types %>% recode(
      "clog--" = "clog+",
      "clog-_cells-" = "cells-",
      "cells_S1-" = "S1-",
      "S2_dead" = "dead",
      "S1_S2-" = "S2-",
      "NK_Eff_Klrg1+-" = "NK_Eff_Klrg1-",
      "NK_Res_Klrg1+-" = "NK_Res_Klrg1-",
      "NK_neg_Klrg1+-" = "NK_neg_Klrg1-",
      "gd_Eff_Klrg1+" = "gdTCR_Eff_Klrg1+",
      "gd_Eff_Klrg1+-" = "gdTCR_Eff_Klrg1-",
      "gd_Res_Klrg1+" = "gdTCR_Res_Klrg1+",
      "gd_Res_Klrg1+-" = "gdTCR_Res_Klrg1-",
      "gd_neg_Klrg1+" = "gdTCR_neg_Klrg1+",
      "gd_neg_Klrg1+-" = "gdTCR_neg_Klrg1-",
      "CD4-NKT_Eff_Klrg1+-" = "CD4-NKT_Eff_Klrg1-",
      "CD4-NKT_Res_Klrg1+-" = "CD4-NKT_Res_Klrg1-",
      "CD4-NKT_neg_Klrg1+-" = "CD4-NKT_neg_Klrg1-",
      "CD4+NKT_Eff_Klrg1+-" = "CD4+NKT_Eff_Klrg1-",
      "CD4+NKT_Res_Klrg1+-" = "CD4+NKT_Res_Klrg1-",
      "CD4+NKT_neg_Klrg1+-" = "CD4+NKT_neg_Klrg1-",
      "Th_Eff_Klrg1+-" = "Th_Eff_Klrg1-",
      "Th_Res_Klrg1+-" = "Th_Res_Klrg1-",
      "Th_neg_Klrg1+-" = "Th_neg_Klrg1-",
      "Treg_Eff_Klrg1+-" = "Tregs_Eff_Klrg1-",
      "Treg_Res_Klrg1+-" = "Tregs_Res_Klrg1-",
      "Treg_neg_Klrg1+-" = "Tregs_neg_Klrg1-",
      "Treg_Eff_Klrg1+" = "Tregs_Eff_Klrg1+",
      "Treg_Res_Klrg1+" = "Tregs_Res_Klrg1+",
      "Treg_neg_Klrg1+" = "Tregs_neg_Klrg1+",
      "CD8_Naive_Klrg1-_VM Tcells" = "CD8_Naive_Klrg1-_VM Tcells+",
      "CD8_Naive_Klrg1+_VM Tcells" = "CD8_Naive_Klrg1+_VM Tcells+",
      "CD8_Eff_Klrg1-_VM Tcells" = "CD8_Eff_Klrg1-_VM Tcells+",
      "CD8_Eff_Klrg1+_VM Tcells" = "CD8_Eff_Klrg1+_VM Tcells+",
      "CD8_Res_Klrg1-_VM Tcells" = "CD8_Res_Klrg1-_VM Tcells+",
      "CD8_Res_Klrg1+_VM Tcells" = "CD8_Res_Klrg1+_VM Tcells+",
      "CD8_neg_Klrg1-_VM Tcells" = "CD8_neg_Klrg1-_VM Tcells+",
      "CD8_neg_Klrg1+_VM Tcells" = "CD8_neg_Klrg1+_VM Tcells+",
      "CD8+_Eff_Klrg1-_VM Tcells-" = "CD8_Eff_Klrg1-_VM Tcells-",
      "CD8+_Eff_Klrg1+_VM Tcells" = "CD8_Eff_Klrg1+_VM Tcells+",
      "CD8+_Eff_Klrg1+_VM Tcells-" = "CD8_Eff_Klrg1+_VM Tcells-",
      "CD8+_Naive_Klrg1-_VM Tcells" = "CD8_Naive_Klrg1-_VM Tcells+",
      "CD8+_Naive_Klrg1-_VM Tcells-" = "CD8_Naive_Klrg1-_VM Tcells-",
      "CD8+_Naive_Klrg1+_VM Tcells" = "CD8_Naive_Klrg1+_VM Tcells+",
      "CD8+_Naive_Klrg1+_VM Tcells-" = "CD8_Naive_Klrg1+_VM Tcells-",
      "CD8+_neg_Klrg1-_VM Tcells" = "CD8_neg_Klrg1-_VM Tcells+",
      "CD8+_neg_Klrg1-_VM Tcells-" = "CD8_neg_Klrg1-_VM Tcells-",
      "CD8+_neg_Klrg1+_VM Tcells" = "CD8_neg_Klrg1+_VM Tcells+",
      "CD8+_neg_Klrg1+_VM Tcells-" = "CD8_neg_Klrg1+_VM Tcells-",
      "CD8+_Res_Klrg1-_VM Tcells" = "CD8_Res_Klrg1-_VM Tcells+",
      "CD8+_Res_Klrg1-_VM Tcells-" = "CD8_Res_Klrg1-_VM Tcells-",
      "CD8+_Res_Klrg1+_VM Tcells" = "CD8_Res_Klrg1+_VM Tcells+",
      "CD8+_Res_Klrg1+_VM Tcells-" = "CD8_Res_Klrg1+_VM Tcells-"
    ))

  manual_gating <- diff_som$fs$data %>%
    as.data.frame() %>%
    full_join(cell_types_df) %>%
    na.omit() %>%
    dplyr::select(cell_types) %>%
    unlist() %>%
    as.character() %>%
    factor()

  facs_data_df <- diff_som$fs$data %>%
    as.data.frame() %>%
    dplyr::select(c(1:19))
  # facs_data_df <- diff_som$fs$data %>% as.data.frame() %>% dplyr::select(to_transform)

  facs_data_df <- facs_data_df %>%
    purrr::set_names(str_remove(string = names(facs_data_df), pattern = "FJComp."))

  facs_data_df <- facs_data_df %>%
    mutate(cell_type = manual_gating)
  
  return(facs_data_df)
}

# facs_data_df <- diff_som_3_normalized %>% build_fcs_data_df(cell_types = cell_types)
# 
# facs_data_df <- facs_data_df %>% 
#   mutate(first_gate = case_when(!(cell_type %in% c("clog+", "cells-", "S1-", "S2-", "dead")) ~ "live"))
#   
# facs_data_df <- facs_data_df %>% 
#   mutate(first_gate = if_else(is.na(first_gate), true = "not_live", false = first_gate))
```

```{r}
add_first_gate_column <- function(facs_data_df) {
  facs_data_df <- facs_data_df %>%
    mutate(first_gate = case_when(!(cell_type %in% c("clog+", "cells-", "S1-", "S2-", "dead")) ~ "live"))

  facs_data_df <- facs_data_df %>%
    mutate(first_gate = if_else(is.na(first_gate), true = "not_live", false = first_gate))
  return(facs_data_df)
}
```

```{r}
add_second_gate_column <- function(facs_data_df) {

  facs_data_df <- facs_data_df %>%
    mutate(second_gate = if_else(first_gate %>% str_detect(pattern = "not_live"), true = "not_live", false = as.character(cell_type)))

  facs_data_df <- facs_data_df %>%
    mutate(second_gate = if_else(second_gate %in% c("gdTCR_neg_Klrg1-", "gdTCR_neg_Klrg1+", "NK_neg_Klrg1-", "NK_neg_Klrg1+", "CD4-NKT_neg_Klrg1-", "CD4-NKT_neg_Klrg1+", "CD4+NKT_neg_Klrg1-", "CD4+NKT_neg_Klrg1+", "Tregs_neg_Klrg1-", "Tregs_neg_Klrg1+", "Th_neg_Klrg1-", "Th_neg_Klrg1+", "CD8_neg_Klrg1-_VM Tcells-", "CD8_neg_Klrg1-_VM Tcells+", "CD8_neg_Klrg1+_VM Tcells-", "CD8_neg_Klrg1+_VM Tcells+"), true = "Not_Panel_A_cell_types", false = second_gate))

  facs_data_df <- facs_data_df %>%
    mutate(second_gate = if_else(second_gate %>% str_detect(pattern = "gdTCR"), true = "gdTCR_cells", false = second_gate)) %>%
    mutate(second_gate = if_else(second_gate %>% str_detect(pattern = "NK_"), true = "NK_cells", false = second_gate)) %>%
    mutate(second_gate = if_else(second_gate %>% str_detect(pattern = "CD4\\-NKT_"), true = "CD4-NKT_cells", false = second_gate)) %>%
    mutate(second_gate = if_else(second_gate %>% str_detect(pattern = "CD4\\+NKT_"), true = "CD4+NKT_cells", false = second_gate)) %>%
    mutate(second_gate = if_else(second_gate %>% str_detect(pattern = "Tregs_"), true = "Tregs_CD4+_cells", false = second_gate)) %>%
    mutate(second_gate = if_else(second_gate %>% str_detect(pattern = "Th_"), true = "Th_CD4+_cells", false = second_gate)) %>%
    mutate(second_gate = if_else(second_gate %>% str_detect(pattern = "CD8"), true = "CD8+_cells", false = second_gate))

  return(facs_data_df)
}
# facs_data_df %>% vroom::vroom_write(paste(source_path, "home/trufenc/facs_data_df_complete_step_2.tsv"))
```

```{r}
add_third_gate_column <- function(facs_data_df) {

  facs_data_df <- facs_data_df %>%
    mutate(third_gate = if_else(first_gate %>% str_detect(pattern = "not_live"), true = "not_live", false = as.character(cell_type)))

  facs_data_df <- facs_data_df %>%
    mutate(third_gate = if_else(second_gate %>% str_detect(pattern = "Not_Panel_A_cell_types|DN "), true = "Not_Panel_A_cell_types", false = third_gate))
  
  facs_data_df <- facs_data_df %>%
    mutate(third_gate = if_else(third_gate %>% str_detect(pattern = "Eff_Klrg1\\-"), true = "Eff_Klrg1_neg", false = third_gate)) %>% 
    mutate(third_gate = if_else(third_gate %>% str_detect(pattern = "Eff_Klrg1\\+"), true = "Eff_Klrg1_pos", false = third_gate)) %>% 
    mutate(third_gate = if_else(third_gate %>% str_detect(pattern = "Res_Klrg1\\-"), true = "Res_Klrg1_neg", false = third_gate)) %>% 
    mutate(third_gate = if_else(third_gate %>% str_detect(pattern = "Res_Klrg1\\+"), true = "Res_Klrg1_pos", false = third_gate)) %>% 
    mutate(third_gate = if_else(third_gate %>% str_detect(pattern = "Naive_Klrg1\\-"), true = "Naive_Klrg1_neg", false = third_gate)) %>% 
    mutate(third_gate = if_else(third_gate %>% str_detect(pattern = "Naive_Klrg1\\+"), true = "Naive_Klrg1_pos", false = third_gate)) 
  
  return(facs_data_df)
}
# facs_data_df %>% vroom::vroom_write(paste(source_path, "home/trufenc/facs_data_df_complete_step_2.tsv"))
```

```{r}
add_fourth_gate_column <- function(facs_data_df) {

  facs_data_df <- facs_data_df %>%
    mutate(fourth_gate = if_else(cell_type %>% str_detect(pattern = "Tcells\\-"), true = "VM_neg", false = as.character(cell_type)))

  facs_data_df <- facs_data_df %>%
    mutate(fourth_gate = if_else(fourth_gate %>% str_detect(pattern = "Tcells\\+"), true = "VM_pos", false = fourth_gate))
  
  return(facs_data_df)
}
```

```{r}
facs_data_df <- diff_som_3 %>% build_fcs_data_df(cell_types = cell_types)

test_facs_data_df <- test_diff_som %>% build_fcs_data_df(cell_types = cell_types)

facs_data_df <- facs_data_df %>% bind_rows(test_facs_data_df)

facs_data_df <- facs_data_df %>% add_first_gate_column()

facs_data_df <- facs_data_df %>% add_second_gate_column()

facs_data_df <- facs_data_df %>% add_third_gate_column()

facs_data_df <- facs_data_df %>% add_fourth_gate_column()
```

# Keep only VM_pos and VM_neg
```{r}
facs_data_df <- facs_data_df %>% dplyr::filter(fourth_gate %in% c("VM_neg", "VM_pos"))

facs_data_df$fourth_gate %>% unique()
```

```{r}
facs_data_df %>% group_by(fourth_gate) %>% tally()
```

```{r}
facs_data_df_list <- facs_data_df %>% split(f = .$fourth_gate)

set.seed(123)
facs_data_df_list$VM_neg <- facs_data_df_list$VM_neg %>% dplyr::slice(sample(120000))

set.seed(123)
facs_data_df_list$VM_pos <- facs_data_df_list$VM_pos %>% dplyr::slice(sample(120000))

facs_data_df <- facs_data_df_list %>% bind_rows(.id = "fourth_gate")

facs_data_df <- facs_data_df %>% dplyr::select(-c(Time, cell_type, first_gate, second_gate, third_gate))

facs_data_df %>% vroom::vroom_write(path = paste0(source_path, "home/trufenc/balanced_data_2_classes_fourth_gate.tsv"), delim = "\t")
```

# Load balanced df with 2 classes
```{r}
facs_data_df <- vroom::vroom(file = paste0(source_path, "home/trufenc/balanced_data_2_classes_fourth_gate.tsv"), delim = "\t")
```

# Normalize dataset
```{r}
normalized_df <- facs_data_df %>% dplyr::select(-fourth_gate) %>% purrr::map(bestNormalize::orderNorm)
normally_dstributed_df <- purrr::map(seq_along(normalized_df), function(i) normalized_df[[i]]$x.t) %>% purrr::set_names(colnames(facs_data_df)[1:18]) %>% purrr::map(scale, center = TRUE, scale = TRUE) %>% purrr::map(scale_to_range_0_1) %>% bind_cols()
facs_data_df <- normally_dstributed_df %>% mutate(third_gate = facs_data_df$third_gate)
```

# Selected features
```{r}
facs_data_df <- facs_data_df %>% dplyr::select(c("PE.A", "AmCyan.A",  "fourth_gate"))
```

```{r}
# randomize
set.seed(123)
facs_data_df <- facs_data_df[sample(nrow(facs_data_df)), ]

set.seed(123)
test_indices <- sample(nrow(facs_data_df)*.3)

test_df <- facs_data_df[test_indices, ]
train_df <- facs_data_df[-test_indices, ]
```

```{r}
step_4_levels <- facs_data_df$fourth_gate %>% unique()
n_classes <- length(step_4_levels)
```

```{r}
classes_number <- data.frame(
  classes = step_4_levels,
  Number = 1:length(step_4_levels)
  )
```

```{r}
test_label <- test_df %>% 
  dplyr::select(fourth_gate) %>% 
  pull() %>% 
  str_replace(pattern = "VM_neg", replacement = "1") %>% 
  str_replace(pattern = "VM_pos", replacement = "2") %>% 
  as.numeric() %>%
  '-'(1) 

test_matrix <- xgb.DMatrix(
  data = test_df %>% 
    # dplyr::select(-c(Time, cell_type, first_gate, third_gate)) %>%
    dplyr::select(-c(fourth_gate)) %>% 
    as.matrix(), 
  label = test_label
  )
```

```{r}
train_label <- train_df %>% 
  dplyr::select(fourth_gate) %>% 
  pull() %>% 
  str_replace(pattern = "VM_neg", replacement = "1") %>% 
  str_replace(pattern = "VM_pos", replacement = "2") %>% 
  as.numeric() %>%
  '-'(1) 

train_matrix <- xgb.DMatrix(
  data = train_df %>% 
    # dplyr::select(-c(Time, cell_type, first_gate, third_gate)) %>% 
    dplyr::select(-c(fourth_gate)) %>% 
    as.matrix(), 
  label = train_label
  )
```

# Random forest
```{r}
rf_train <- train_df %>% mutate(fourth_gate = train_label %>% factor())
# rf_train <- train_df %>% dplyr::select(c("APC.Cy7.A", "PE.A", "PerCP.Cy5.5.A", "FITC.A",  "third_gate")) %>% mutate(third_gate = train_label %>% factor())

rf_test <- test_df %>% mutate(fourth_gate = test_label %>% factor())
# rf_test <- test_df %>% dplyr::select(c("APC.Cy7.A", "PE.A", "PerCP.Cy5.5.A", "FITC.A",  "third_gate")) %>% mutate(third_gate = test_label %>% factor())

set.seed(123)
tic()
# rf_model <- ranger(formula = third_gate ~ ., data = rf_train, num.threads = 50, num.trees = 1600, mtry = 18, max.depth = 19, min.node.size = 0, splitrule = "gini")
rf_model <- ranger(formula = fourth_gate ~ ., data = rf_train, num.threads = 6, num.trees = 1400, mtry = 18, max.depth = 0, min.node.size = 3, splitrule = "gini")
toc()

confusionMatrix(rf_train$fourth_gate, rf_model$predictions)

rf_pred <- predict(rf_model, rf_test %>% dplyr::select(-fourth_gate))

confusionMatrix(rf_test$fourth_gate, rf_pred$predictions)
```

```{r}
  set.seed(123)
  # rf_model <- ranger(data = rf_train, formula = fourth_gate ~ ., num.threads = 50, num.trees = 500, mtry = 4, splitrule = "extratrees")

  rf_model_list <- purrr::map(seq(from = 0, to = 20, by = 1), function(i) ranger(data = rf_train, formula = fourth_gate ~ ., num.threads = 6, num.trees = 1400, mtry = 18, splitrule = "extratrees", min.node.size = 3, max.depth = i))
  
  cm_train_list <- purrr::map(seq_along(rf_model_list), function(i) confusionMatrix(rf_train$fourth_gate, rf_model_list[[i]]$predictions))

  cm_train_df <- cm_train_list %>% purrr::map(function(x) x %>% .$overall %>% t() %>% as.data.frame()) %>% bind_rows()
  
  rf_pred_list <- purrr::map(seq_along(rf_model_list), function(i) predict(rf_model_list[[i]], rf_test %>% dplyr::select(-fourth_gate)))

  cm_test_list <- purrr::map(seq_along(rf_model_list), function(i) confusionMatrix(rf_test$fourth_gate, rf_pred_list[[i]]$predictions))
  
  cm_test_df <- cm_test_list %>% purrr::map(function(x) x %>% .$overall %>% t() %>% as.data.frame()) %>% bind_rows()
  
  acc_data <- data.frame(train_acc = cm_train_df$Accuracy,
             eval_acc = cm_test_df$Accuracy,
             max.depth = seq(from = 0, to = 20, by = 1))
  
  acc_data %>% tidyr::gather(key = "key", value = "value", -max.depth) %>% ggplot(aes(x = max.depth, y = value, colour = key)) + geom_line()
  
  kappa_data <- data.frame(train_kappa = cm_train_df$Kappa,
             eval_kappa = cm_test_df$Kappa,
             max.depth = seq(from = 0, to = 20, by = 1))
  
  kappa_data %>% tidyr::gather(key = "key", value = "value", -max.depth) %>% ggplot(aes(x = max.depth, y = value, colour = key)) + geom_line()
```

# Final model for fouth gate
```{r}
set.seed(123)
tic()
rf_model_step_4 <- ranger(formula = factor(fourth_gate) ~ ., data = facs_data_df, num.threads = 6, num.trees = 1400, mtry = 18, max.depth = 0, min.node.size = 3, splitrule = "hellinger")
toc()

# rf_model_step_4 %>% saveRDS(file = paste0(source_path, "home/trufenc/rf_model_step_4.rds"))
```

